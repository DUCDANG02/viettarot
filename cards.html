<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VietTarot - Ý Nghĩa Các Loại Bài</title>

    <link rel="icon" type="image/png" sizes="16x16" href="https://www.viettarot.com/image/iconlogo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.viettarot.com/image/iconlogo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://www.viettarot.com/image/iconlogo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-blue: #4A6CF3;
            --primary-purple: #9B49F2;
            --text-primary: #1A1229;
            --text-secondary: #5A6474;
            --bg-white: #FFFFFF;
            --bg-off-white: #F8F7FA;
            --border-color: #E5E7EB;
            --danger-color: #dc3545;
            --success-color: #198754;
            --gradient-primary: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-purple) 100%);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-off-white);
            color: var(--text-primary);
        }

        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-white);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.75s ease, visibility 0.75s ease;
            opacity: 1;
            visibility: visible;
        }

        #preloader.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        .preloader-content {
            text-align: center;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid var(--primary-blue);
            border-top-color: var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .loading-text {
            margin-top: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .page-header {
            background: var(--gradient-primary);
            color: var(--bg-white);
            padding: 4rem 0;
            text-align: center;
        }

        .page-header h1 {
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }

        .page-header p {
            font-size: 1.15rem;
            opacity: 0.9;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .filters-container {
            background-color: var(--bg-white);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            margin-top: -2.5rem;
            position: relative;
            z-index: 10;
        }

        .search-form-group {
            position: relative;
        }

        .search-form-group .form-control {
            padding-left: 3rem;
            height: 50px;
            background-color: var(--bg-off-white);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }

        .search-form-group .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.2rem;
        }
        
        .filter-buttons {
            position: relative;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .filter-buttons .btn {
            margin: 0;
            font-weight: 500;
            border-radius: 50px;
            border: 1px solid transparent;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            background-color: transparent;
            z-index: 2;
            padding: 0.5rem 1rem;
        }
        
        .filter-buttons .btn:hover {
            color: var(--text-primary);
        }
        
        .filter-slider {
            position: absolute;
            top: 0;
            bottom: 0;
            height: 100%;
            border-radius: 50px;
            background: var(--gradient-primary);
            box-shadow: 0 4px 15px rgba(120, 73, 242, 0.3);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 1;
        }
        
        .filter-buttons .btn.active {
            color: var(--bg-white);
        }

        @media (max-width: 991.98px) {
            .filter-slider {
                display: none !important;
            }
            .filter-buttons .btn.active {
                background: var(--gradient-primary);
                box-shadow: 0 2px 8px rgba(120, 73, 242, 0.3);
            }
        }
        
        @media (min-width: 992px) {
            .filter-buttons {
                justify-content: flex-start;
                gap: 0.25rem;
            }
            .filter-buttons .btn {
                margin: 0.25rem;
             }
        }

        .tarot-card-item-wrapper {
            cursor: pointer;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .tarot-card-item-wrapper.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .tarot-card-item {
            background-color: var(--bg-white);
            border-radius: 1rem;
            overflow: hidden;
            text-align: center;
            text-decoration: none;
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .tarot-card-item-wrapper:hover .tarot-card-item {
            transform: translateY(-8px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .tarot-card-item-wrapper:hover .tarot-card-name {
            color: var(--primary-blue);
        }

        .tarot-card-image {
            width: 100%;
            height: auto;
            aspect-ratio: 2 / 3.5;
            object-fit: cover;
            background-color: var(--bg-off-white);
        }

        .tarot-card-name {
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            font-size: 0.8rem;
            margin: 0;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
        }

        #loading-indicator, #no-results-message {
            display: none;
            text-align: center;
            padding: 3rem 0;
            color: var(--text-secondary);
        }
        
        #cardDetailModal .modal-dialog {
            max-width: 1200px;
            animation: zoomIn 0.4s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #cardDetailModal .modal-content {
            border-radius: 1rem;
            background-color: #fdfcff;
            border: none;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }
        
        #cardDetailModal .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient-primary);
            z-index: 2;
        }
        
        #cardDetailModal .modal-header {
            border-bottom: none;
            padding: 1.3rem 0.5rem;
        }
        
        #cardDetailModal .btn-close {
            position: absolute;
            top: 1.2rem;
            right: 1.5rem;
            z-index: 10;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--gradient-primary);
            opacity: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        #cardDetailModal .btn-close i {
            color: white;
            font-size: 1rem;
        }

        #cardDetailModal .btn-close:hover {
             transform: scale(1.1) rotate(90deg);
        }

        #cardDetailModal .modal-body {
            padding: 0 1.5rem 1.5rem 1.5rem;
        }
        
        .card-detail-image {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            margin: 0 auto;
        }
        
        .card-detail-content {
            max-height: 75vh;
            overflow-y: auto;
            padding-right: 1rem;
        }
        
        .card-detail-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .card-detail-subtitle {
            font-weight: 500;
            color: var(--primary-purple);
            margin-bottom: 1.5rem;
        }

        .card-detail-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            background-color: var(--bg-off-white);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .info-item {
            font-size: 0.9rem;
            text-align: center;
        }
        
        .info-item .info-label {
            font-weight: 600;
            color: var(--text-primary);
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .info-item .info-value {
            color: var(--text-secondary);
        }
        
        .detail-section h5 {
            font-weight: 600;
            color: var(--text-primary);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-blue);
            margin-bottom: 1rem;
            display: inline-block;
        }
        
        .detail-section p, .detail-section ul {
            color: var(--text-secondary);
            line-height: 1.7;
            text-align: justify;
            font-size: 0.95rem;
        }
        
        .card-group-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-purple);
            font-size: 1.5rem;
        }

        .card-group-title:first-child {
            margin-top: 0;
        }
        
        .card-group-subtitle {
            font-weight: 600;
            font-size: 1.15rem;
            color: var(--text-secondary);
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 3px solid var(--primary-blue);
        }

        .card-group-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        }

        @media (min-width: 576px) { .card-group-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); } }
        @media (min-width: 768px) { .card-group-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); } }
        @media (min-width: 1200px) { .card-group-grid { grid-template-columns: repeat(8, 1fr); } }
        
        #related-cards-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }
        @media (min-width: 1200px) {
            #related-cards-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        .btn-gradient-primary {
            background: var(--gradient-primary);
            border: none;
            font-weight: 600;
            color: var(--bg-white);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(120, 73, 242, 0.25);
        }

        .btn-gradient-primary:hover {
            color: var(--bg-white);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(120, 73, 242, 0.4);
        }
        
        .promo-popup-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(26, 18, 41, 0.75);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        .promo-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .promo-popup-content {
            position: relative;
            background-color: var(--bg-white);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1 / 1;
            transform: scale(0.8);
            transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .promo-popup-overlay.show .promo-popup-content {
            transform: scale(1);
        }
        .promo-popup-content a {
            display: block;
            width: 100%; height: 100%;
        }
        .promo-popup-content img {
            width: 100%; height: 100%;
            object-fit: cover;
            background-color: var(--bg-off-white);
        }
        .promo-popup-close {
            position: absolute;
            top: 10px; right: 10px;
            width: 36px; height: 36px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            line-height: 36px;
            text-align: center;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.3s ease;
        }
        .promo-popup-close:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
    </style>
</head>

<body>
    <div id="preloader">
        <div class="preloader-content">
            <div class="loader"></div>
            <div class="loading-text">Đang tải...</div>
        </div>
    </div>
    
    <div id="header-placeholder"></div>
    <div id="modals-placeholder"></div>
    <div id="floating-widgets-placeholder"></div>

    <main>
        <section class="page-header">
            <div class="container">
                <h1>Khám Phá Ý Nghĩa Các Lá Bài</h1>
                <p class="lead">Tra cứu ý nghĩa, thông điệp và lời khuyên từ các bộ bài Tarot, Oracle và Lenormand.</p>
            </div>
        </section>

        <section class="py-5">
            <div class="container">
                <div class="filters-container mb-5">
                    <div class="row g-3 align-items-center">
                        <div class="col-lg-5 col-md-12">
                            <div class="search-form-group">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="search-input" class="form-control" placeholder="Tìm kiếm theo tên lá bài...">
                            </div>
                        </div>
                        <div class="col-lg-7 col-md-12">
                            <div class="filter-buttons" id="filter-buttons">
                                <div class="filter-slider" id="filter-slider"></div>
                                <button class="btn active" data-filter="Tarot">Bài Tarot</button>
                                <button class="btn" data-filter="Oracle">Bài Oracle</button>
                                <button class="btn" data-filter="Lenormand">Bài Lenormand</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="loading-indicator">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Đang tải dữ liệu các lá bài...</p>
                </div>
                
                <div id="card-grid">
                    </div>
                
                <div id="no-results-message">
                    <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                    <p class="mb-0">Không tìm thấy lá bài nào phù hợp.</p>
                </div>

            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <div class="modal fade" id="cardDetailModal" tabindex="-1" aria-labelledby="cardDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row g-4">
                        <div class="col-lg-4 text-center">
                            <img src="https://placehold.co/300x525/cccccc/ffffff?text=Image" alt="Hình ảnh lá bài" id="modalCardImage" class="card-detail-image">
                            
                            <a href="#" id="exampleReadingBtn" class="btn btn-gradient-primary mt-4 w-100" data-view="details">
                                <i class="fas fa-eye me-2"></i>Ví dụ trong trải bài
                            </a>
                        </div>
                        <div class="col-lg-8">
                            <div class="card-detail-content">
                                <h2 class="card-detail-title" id="modalCardName">Tên lá bài</h2>
                                <h4 class="card-detail-subtitle" id="modalDharmaName">Tên pháp danh</h4>
                                
                                <div id="modalCardDetailsContent">
                                    <div class="card-detail-info-grid">
                                        <div class="info-item"><span class="info-label"><i class="fas fa-hashtag me-2" style="color: #4A6CF3;"></i>Số thứ tự</span><span class="info-value" id="modalCardNumber"></span></div>
                                        <div class="info-item"><span class="info-label"><i class="fas fa-atom me-2" style="color: #10B981;"></i>Nguyên tố</span><span class="info-value" id="modalCardElement"></span></div>
                                        <div class="info-item"><span class="info-label"><i class="fas fa-yin-yang me-2" style="color: #EF4444;"></i>Tính chất</span><span class="info-value" id="modalCardPolarity"></span></div>
                                        <div class="info-item"><span class="info-label"><i class="fas fa-star-of-david me-2" style="color: #F59E0B;"></i>Cung hoàng đạo</span><span class="info-value" id="modalCardZodiac"></span></div>
                                    </div>
                                    <div class="detail-section mt-4"><h5><i class="fas fa-book-open me-2" style="color: #6366F1;"></i>Mô tả sách gốc</h5><p id="modalDescriptionOriginal"></p></div>
                                    <div class="detail-section mt-4"><h5><i class="fas fa-gem me-2" style="color: #0EA5E9;"></i>Ý nghĩa biểu tượng</h5><div id="modalSymbolism"></div></div>
                                    <div class="detail-section mt-4"><h5><i class="fas fa-key me-2" style="color: #8B5CF6;"></i>Ý nghĩa tổng quan</h5><p id="modalMeaningGeneral"></p></div>
                                    <div class="detail-section mt-4"><h5><i class="fas fa-arrow-up me-2" style="color: var(--success-color);"></i>Nghĩa xuôi</h5><div id="modalMeaningUpright"></div></div>
                                    <div class="detail-section mt-4"><h5><i class="fas fa-arrow-down me-2" style="color: var(--danger-color);"></i>Nghĩa ngược</h5><div id="modalMeaningReversed"></div></div>
                                    <div class="detail-section mt-4"><h5><i class="fas fa-heart me-2" style="color: #EC4899;"></i>Chủ đề Tình yêu</h5><p id="modalThemeLove"></p></div>
                                    <div class="detail-section mt-4"><h5><i class="fas fa-book-reader me-2" style="color: #F97316;"></i>Chủ đề Học tập</h5><p id="modalThemeStudy"></p></div>
                                    <div class="detail-section mt-4"><h5><i class="fas fa-briefcase me-2" style="color: #3B82F6;"></i>Chủ đề Sự nghiệp</h5><p id="modalThemeCareer"></p></div>
                                </div>

                                <div id="modalExampleReadingContent" style="display: none;">
                                    <div class="detail-section">
                                        <h5><i class="fas fa-comments me-2" style="color: #8B5CF6;"></i>Ví dụ Giải Nghĩa Lá The Fool</h5>
                                        <p>Dưới đây là các ví dụ về cách lá <strong>The Fool</strong> có thể được diễn giải trong các bối cảnh khác nhau của một trải bài.</p>
                                    </div>

                                    <div class="detail-section mt-4">
                                        <h5><i class="fas fa-heart me-2" style="color: #EC4899;"></i>Trong Trải Bài Tình Yêu</h5>
                                        <p>Khi The Fool xuất hiện, nó báo hiệu một sự khởi đầu mới mẻ và đầy hứng khởi trong chuyện tình cảm. Bạn có thể sắp bước vào một mối quan hệ mới với một tâm hồn tự do, không bị ràng buộc bởi những tổn thương trong quá khứ. Lá bài khuyến khích bạn hãy mở lòng, đón nhận tình yêu một cách ngây thơ và tin tưởng. Đây là lúc để "nhảy một bước nhảy của niềm tin" và xem cuộc phiêu lưu này sẽ dẫn bạn đến đâu.</p>
                                        <p><em>Ví dụ: Nếu bạn đang độc thân và hỏi về tình yêu sắp tới, The Fool cho thấy một mối quan hệ bất ngờ, có thể hơi khác thường nhưng sẽ mang lại cho bạn rất nhiều niềm vui và sự tự do. Hãy cứ là chính mình và đừng ngại thể hiện sự độc đáo của bản thân.</em></p>
                                    </div>
                                    
                                    <div class="detail-section mt-4">
                                        <h5><i class="fas fa-briefcase me-2" style="color: #3B82F6;"></i>Trong Trải Bài Sự Nghiệp</h5>
                                        <p>Về sự nghiệp, The Fool là lời kêu gọi cho một khởi đầu mới. Đây có thể là một công việc mới, một dự án kinh doanh táo bạo, hoặc thậm chí là một sự thay đổi hoàn toàn về con đường sự nghiệp. Lá bài này khuyên bạn nên can đảm nắm bắt các cơ hội, ngay cả khi bạn chưa có tất cả các câu trả lời. Sự lạc quan và sẵn sàng học hỏi sẽ là chìa khóa thành công. Đừng ngại trở thành "người mới" và bắt đầu lại từ đầu.</p>
                                        <p><em>Ví dụ: Bạn đang phân vân không biết có nên nghỉ việc để khởi nghiệp hay không? The Fool xuất hiện như một sự ủng hộ mạnh mẽ. Nó nói rằng, mặc dù con đường phía trước có thể không chắc chắn (giống như vực thẳm), tiềm năng thành công là rất lớn nếu bạn dám bước đi.</em></p>
                                    </div>

                                    <div class="detail-section mt-4">
                                        <h5><i class="fas fa-lightbulb me-2" style="color: #F59E0B;"></i>Lời Khuyên & Hướng Dẫn</h5>
                                        <p>Ở vị trí lời khuyên, The Fool nhắc nhở bạn hãy sống trọn vẹn trong khoảnh khắc hiện tại. Hãy giải phóng bản thân khỏi những nỗi sợ hãi và những kỳ vọng của người khác. Đây là thời điểm để khám phá, để sáng tạo, và để tin tưởng vào vũ trụ. Hãy tự hỏi: "Điều gì sẽ xảy ra nếu mình không sợ hãi?" Câu trả lời sẽ dẫn lối cho bạn. Hãy đón nhận sự ngây thơ và trí tò mò của một đứa trẻ, bởi vì đó là nơi sức mạnh và tiềm năng vô hạn của bạn đang ẩn giấu.</p>
                                    </div>
                                </div>
                                
                                <div id="related-cards-section" class="mt-5" style="display: none;">
                                    <h5 class="card-group-subtitle" style="border-left-color: var(--primary-purple); font-size: 1.25rem;">
                                        <i class="fas fa-random me-2"></i>Các lá bài liên quan
                                    </h5>
                                    <div id="related-cards-grid" class="card-group-grid">
                                    </div>
                                </div>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="permissionDeniedModal" tabindex="-1" aria-labelledby="permissionDeniedModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="permissionDeniedModalLabel"><i class="fas fa-lock me-2 text-warning"></i>Yêu Cầu Quyền Truy Cập</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center" id="permissionDeniedModalBody">
                    </div>
                <div class="modal-footer justify-content-center border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đã hiểu</button>
                </div>
            </div>
        </div>
    </div>
    <div id="promotionPopup" class="promo-popup-overlay">
        <div class="promo-popup-content">
            <button id="closePromoPopup" class="promo-popup-close" title="Đóng">&times;</button>
            <a href="#" target="_blank" id="promo-link">
                <img src="https://placehold.co/500x500/1A1229/FFFFFF?text=Promo" alt="Quảng cáo khuyến mãi" id="promo-image">
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="components.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', initializePageLogic);

        function initializePageLogic() {
            const cardGrid = document.getElementById('card-grid');
            const searchInput = document.getElementById('search-input');
            const filterButtonsContainer = document.getElementById('filter-buttons');
            const filterSlider = document.getElementById('filter-slider');
            const loadingIndicator = document.getElementById('loading-indicator');
            const noResultsMessage = document.getElementById('no-results-message');
            const cardDetailModal = new bootstrap.Modal(document.getElementById('cardDetailModal'));
            const relatedCardsGrid = document.getElementById('related-cards-grid');

            // START: CODE SỬA ĐỔI - Khởi tạo modal và các biến liên quan
            const permissionModal = new bootstrap.Modal(document.getElementById('permissionDeniedModal'));
            const exampleReadingBtn = document.getElementById('exampleReadingBtn');
            const detailsContent = document.getElementById('modalCardDetailsContent');
            const exampleContent = document.getElementById('modalExampleReadingContent');

            let allCardsData = [];
            let filteredCards = [];
            let supabase = window.viettarotApp.supabase;
            let currentUserRole = 'guest'; // Biến lưu trữ vai trò người dùng
            // END: CODE SỬA ĐỔI

            // START: CODE MỚI - Hàm lấy vai trò người dùng
            async function fetchUserRole() {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    const { data: profile, error } = await supabase
                        .from('profiles')
                        .select('role')
                        .eq('id', user.id)
                        .single();
                    if (error) {
                        console.error("Lỗi khi lấy vai trò người dùng:", error);
                        currentUserRole = 'user'; // Mặc định là 'user' nếu không lấy được profile
                    } else {
                        currentUserRole = profile ? profile.role : 'user';
                    }
                } else {
                    currentUserRole = 'guest';
                }
            }
            // END: CODE MỚI

            async function fetchAllCards() {
                loadingIndicator.style.display = 'block';
                cardGrid.innerHTML = '';
                noResultsMessage.style.display = 'none';

                const activeFilter = document.querySelector('#filter-buttons .btn.active').dataset.filter;
                
                let tableName = '';
                switch (activeFilter) {
                    case 'Tarot':
                        tableName = 'tarot_cards';
                        break;
                    case 'Oracle':
                        tableName = 'oracle_cards';
                        break;
                    case 'Lenormand':
                        tableName = 'lenormand_cards';
                        break;
                    default:
                        console.error('Bộ bài không hợp lệ:', activeFilter);
                        loadingIndicator.style.display = 'none';
                        return;
                }

                try {
                    const { data, error } = await supabase
                        .from(tableName)
                        .select('*')
                        .order('rank_order', { ascending: true });

                    if (error) throw error;
                    allCardsData = data || [];
                } catch (error) {
                    console.error('Lỗi khi tải dữ liệu lá bài:', error);
                    allCardsData = [];
                    noResultsMessage.innerHTML = '<i class="fas fa-exclamation-triangle fa-2x mb-3"></i><p class="mb-0">Không thể tải dữ liệu. Vui lòng thử lại sau.</p>';
                    noResultsMessage.style.display = 'block';
                } finally {
                    handleFilterAndSearch();
                    loadingIndicator.style.display = 'none';
                }
            }
            
            function createGroupHeader(title, level = 'h4', customClass = 'card-group-title') {
                const header = document.createElement(level);
                header.className = customClass;
                header.textContent = title;
                return header;
            }
            
            function createCardGridForGroup(cards) {
                const grid = document.createElement('div');
                grid.className = 'card-group-grid';
                const fragment = document.createDocumentFragment();
                cards.forEach(card => {
                    const cardElementWrapper = document.createElement('div');
                    cardElementWrapper.className = 'tarot-card-item-wrapper';
                    cardElementWrapper.dataset.cardId = card.id;
                    
                    cardElementWrapper.innerHTML = `
                        <div class="tarot-card-item">
                            <img src="${card.image_url || 'https://placehold.co/300x525/cccccc/ffffff?text=No+Image'}" alt="${card.name}" class="tarot-card-image" loading="lazy">
                            <h6 class="tarot-card-name">${card.name}</h6>
                        </div>
                    `;
                    fragment.appendChild(cardElementWrapper);
                });
                grid.appendChild(fragment);
                return grid;
            }
            
            function renderCards() {
                cardGrid.innerHTML = '';
                noResultsMessage.style.display = 'none';
                
                const activeFilter = document.querySelector('#filter-buttons .btn.active').dataset.filter;
                
                if (filteredCards.length === 0) {
                     if (searchInput.value || allCardsData.length > 0) { 
                        noResultsMessage.innerHTML = '<i class="fas fa-exclamation-circle fa-2x mb-3"></i><p class="mb-0">Không tìm thấy lá bài nào phù hợp.</p>';
                        noResultsMessage.style.display = 'block';
                    } else {
                        noResultsMessage.innerHTML = '<i class="fas fa-info-circle fa-2x mb-3"></i><p class="mb-0">Chưa có dữ liệu cho bộ bài này.</p>';
                        noResultsMessage.style.display = 'block';
                    }
                    return;
                }

                if (activeFilter !== 'Tarot') {
                    cardGrid.appendChild(createCardGridForGroup(filteredCards));
                } else {
                    const groups = {
                        major_arcana: { title: 'Bộ Ẩn Chính', cards: [] },
                        minor_arcana: { 
                            suits: {
                                Wands: { title: 'Gậy (Wands)', cards: [] },
                                Cups: { title: 'Cốc (Cups)', cards: [] },
                                Swords: { title: 'Kiếm (Swords)', cards: [] },
                                Pentacles: { title: 'Tiền (Pentacles)', cards: [] }
                            }
                        }
                    };
                    
                    filteredCards.forEach(card => {
                        if (card.sub_type === 'major_arcana') {
                            groups.major_arcana.cards.push(card);
                        } else if (card.sub_type === 'minor_arcana' && card.suit && groups.minor_arcana.suits[card.suit]) {
                            groups.minor_arcana.suits[card.suit].cards.push(card);
                        }
                    });

                    const fragment = document.createDocumentFragment();
                    if (groups.major_arcana.cards.length > 0) {
                        fragment.appendChild(createGroupHeader(groups.major_arcana.title));
                        fragment.appendChild(createCardGridForGroup(groups.major_arcana.cards));
                    }
                    
                    const minorSuits = Object.values(groups.minor_arcana.suits).filter(s => s.cards.length > 0);
                    if(minorSuits.length > 0) {
                        fragment.appendChild(createGroupHeader('Bộ Ẩn Phụ'));
                        minorSuits.forEach(suit => {
                            fragment.appendChild(createGroupHeader(suit.title, 'h5', 'card-group-subtitle'));
                            fragment.appendChild(createCardGridForGroup(suit.cards));
                        });
                    }
                    cardGrid.appendChild(fragment);
                }
                
                const observer = new IntersectionObserver((entries, obs) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            obs.unobserve(entry.target);
                        }
                    });
                }, { rootMargin: '0px 0px -50px 0px' });
                cardGrid.querySelectorAll('.tarot-card-item-wrapper').forEach(w => observer.observe(w));
            }
            
            function handleFilterAndSearch() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                if (allCardsData.length === 0) {
                    filteredCards = [];
                } else {
                    filteredCards = searchTerm 
                        ? allCardsData.filter(card => 
                            card.name.toLowerCase().includes(searchTerm) || 
                            (card.dharma_name && card.dharma_name.toLowerCase().includes(searchTerm))
                          )
                        : [...allCardsData];
                }
                renderCards();
            }

            function displayRelatedCards(currentCard) {
                const relatedSection = document.getElementById('related-cards-section');
                relatedCardsGrid.innerHTML = ''; 

                const activeFilter = document.querySelector('#filter-buttons .btn.active').dataset.filter;
                const groupKey = currentCard.sub_type === 'major_arcana' ? 'major_arcana' : currentCard.suit;

                if (activeFilter !== 'Tarot' || !groupKey) {
                    relatedSection.style.display = 'none';
                    return;
                }

                let relatedCards = allCardsData.filter(card => {
                    const cardGroupKey = card.sub_type === 'major_arcana' ? 'major_arcana' : card.suit;
                    return cardGroupKey === groupKey && card.id !== currentCard.id;
                });

                if (relatedCards.length === 0) {
                    relatedSection.style.display = 'none';
                    return;
                }

                relatedCards.sort(() => 0.5 - Math.random());
                const cardsToShow = relatedCards.slice(0, 5);

                const fragment = document.createDocumentFragment();
                cardsToShow.forEach(card => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'tarot-card-item-wrapper is-visible';
                    wrapper.dataset.cardId = card.id;
                    wrapper.title = card.name;
                    
                    wrapper.innerHTML = `
                        <div class="tarot-card-item">
                            <img src="${card.image_url || 'https://placehold.co/300x525/cccccc/ffffff?text=No+Image'}" alt="${card.name}" class="tarot-card-image" loading="lazy">
                            <h6 class="tarot-card-name">${card.name}</h6>
                        </div>
                    `;
                    fragment.appendChild(wrapper);
                });

                relatedCardsGrid.appendChild(fragment);
                relatedSection.style.display = 'block';
            }
            
            function showCardDetails(cardId) {
                const card = allCardsData.find(c => c.id === parseInt(cardId));
                if (!card) return;

                detailsContent.style.display = 'block';
                exampleContent.style.display = 'none';
                exampleReadingBtn.dataset.view = 'details';
                exampleReadingBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Ví dụ trong trải bài';

                const activeFilter = document.querySelector('#filter-buttons .btn.active').dataset.filter;
                const safeText = (text, fallback = 'Chưa có thông tin') => text || fallback;
                const formatHtml = (text) => (text || '').replace(/\n/g, '<br>');
                
                const isTarot = activeFilter === 'Tarot';
                
                // START: CODE SỬA ĐỔI - Ẩn/hiện nút "Ví dụ"
                exampleReadingBtn.style.display = isTarot ? 'block' : 'none';
                // END: CODE SỬA ĐỔI

                document.getElementById('modalCardImage').src = card.image_url || 'https://placehold.co/300x525/cccccc/ffffff?text=No+Image';
                document.getElementById('modalCardName').textContent = safeText(card.name, 'Tên lá bài');
                document.getElementById('modalDharmaName').textContent = safeText(card.dharma_name, '');
                
                document.getElementById('modalCardNumber').textContent = safeText(card.card_number, 'N/A');
                
                document.getElementById('modalCardElement').closest('.info-item').style.display = isTarot ? 'block' : 'none';
                document.getElementById('modalCardPolarity').closest('.info-item').style.display = isTarot ? 'block' : 'none';
                document.getElementById('modalCardZodiac').closest('.info-item').style.display = isTarot ? 'block' : 'none';

                document.querySelectorAll('#cardDetailModal .detail-section').forEach(section => {
                    section.style.display = 'block';
                });
                document.getElementById('modalSymbolism').innerHTML = '';

                if(isTarot) {
                    document.getElementById('modalCardElement').textContent = safeText(card.element);
                    document.getElementById('modalCardPolarity').textContent = safeText(card.polarity);
                    document.getElementById('modalCardZodiac').textContent = safeText(card.zodiac);
                    document.getElementById('modalDescriptionOriginal').innerHTML = formatHtml(safeText(card.description_original));
                    document.getElementById('modalSymbolism').innerHTML = formatHtml(safeText(card.symbolism));
                    document.getElementById('modalMeaningGeneral').innerHTML = formatHtml(safeText(card.meaning_general));
                    document.getElementById('modalMeaningUpright').innerHTML = formatHtml(safeText(card.meaning_upright));
                    document.getElementById('modalMeaningReversed').innerHTML = formatHtml(safeText(card.meaning_reversed));
                    document.getElementById('modalThemeLove').innerHTML = formatHtml(safeText(card.theme_love));
                    document.getElementById('modalThemeStudy').innerHTML = formatHtml(safeText(card.theme_study));
                    document.getElementById('modalThemeCareer').innerHTML = formatHtml(safeText(card.theme_career));
                } else {
                    document.getElementById('modalDescriptionOriginal').innerHTML = formatHtml(safeText(card.description));
                    document.getElementById('modalMeaningGeneral').innerHTML = formatHtml(safeText(card.meaning));
                    if (card.keywords) {
                        document.getElementById('modalSymbolism').innerHTML = `<b>Keywords:</b> ${safeText(card.keywords)}`;
                    } else {
                        document.getElementById('modalSymbolism').closest('.detail-section').style.display = 'none';
                    }

                    document.getElementById('modalMeaningUpright').closest('.detail-section').style.display = 'none';
                    document.getElementById('modalMeaningReversed').closest('.detail-section').style.display = 'none';
                    document.getElementById('modalThemeLove').closest('.detail-section').style.display = 'none';
                    document.getElementById('modalThemeStudy').closest('.detail-section').style.display = 'none';
                    document.getElementById('modalThemeCareer').closest('.detail-section').style.display = 'none';
                }
                
                if (!cardDetailModal._isShown) {
                    cardDetailModal.show();
                }
                
                displayRelatedCards(card);
            }

            function updateFilterSlider(activeButton) {
                if (!activeButton || !filterSlider || window.innerWidth < 992) return;
                filterSlider.style.width = `${activeButton.offsetWidth}px`;
                filterSlider.style.left = `${activeButton.offsetLeft}px`;
                filterSlider.style.top = `${activeButton.offsetTop}px`;
                filterSlider.style.height = `${activeButton.offsetHeight}px`;
            }

            searchInput.addEventListener('input', handleFilterAndSearch);

            filterButtonsContainer.addEventListener('click', (e) => {
                const targetButton = e.target.closest('button.btn');
                if (targetButton && !targetButton.classList.contains('active')) {
                    filterButtonsContainer.querySelector('.btn.active').classList.remove('active');
                    targetButton.classList.add('active');
                    updateFilterSlider(targetButton);
                    fetchAllCards();
                }
            });
            
            cardGrid.addEventListener('click', (e) => {
                const cardWrapper = e.target.closest('.tarot-card-item-wrapper');
                if (cardWrapper && cardWrapper.dataset.cardId) {
                    showCardDetails(cardWrapper.dataset.cardId);
                }
            });
            
            relatedCardsGrid.addEventListener('click', (e) => {
                const cardWrapper = e.target.closest('.tarot-card-item-wrapper');
                if (cardWrapper && cardWrapper.dataset.cardId) {
                    const modalContent = document.querySelector('#cardDetailModal .card-detail-content');
                    if (modalContent) {
                        modalContent.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                    setTimeout(() => {
                        showCardDetails(cardWrapper.dataset.cardId);
                    }, 300);
                }
            });
            
            // START: CODE SỬA ĐỔI - Logic xử lý nút "Ví dụ" với kiểm tra quyền
            exampleReadingBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const allowedRoles = ['student', 'membership', 'admin']; // 'admin' để quản trị viên có thể xem
                
                if (allowedRoles.includes(currentUserRole)) {
                    // Nếu có quyền, thực hiện chức năng như cũ
                    const currentView = this.dataset.view;
                    if (currentView === 'details') {
                        detailsContent.style.display = 'none';
                        exampleContent.style.display = 'block';
                        this.dataset.view = 'examples';
                        this.innerHTML = '<i class="fas fa-info-circle me-2"></i>Xem Chi Tiết Lá Bài';
                    } else {
                        detailsContent.style.display = 'block';
                        exampleContent.style.display = 'none';
                        this.dataset.view = 'details';
                        this.innerHTML = '<i class="fas fa-eye me-2"></i>Ví dụ trong trải bài';
                    }
                } else {
                    // Nếu không có quyền, hiển thị popup thông báo
                    const permissionModalBody = document.getElementById('permissionDeniedModalBody');
                    permissionModalBody.innerHTML = `
                        <p class="fs-5 mb-1">Bạn cần là <strong>Học viên</strong> hoặc <strong>Member</strong> để xem nội dung này.</p>
                        <p class="text-secondary">Vui lòng đăng nhập hoặc nâng cấp tài khoản của bạn để truy cập tính năng này.</p>
                    `;
                    permissionModal.show();
                }
            });
            // END: CODE SỬA ĐỔI

            async function initializePage() {
                if (!supabase) {
                    console.error("Supabase client chưa được khởi tạo.");
                    return;
                }
                await fetchUserRole(); // Lấy vai trò người dùng khi tải trang
                await fetchAllCards();
                updateFilterSlider(filterButtonsContainer.querySelector('.btn.active'));
            }
            
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    updateFilterSlider(filterButtonsContainer.querySelector('.btn.active'));
                }, 250);
            });

            initializePage();
        }
        
        window.addEventListener('load', function() {
            const preloader = document.getElementById('preloader');
            if (preloader) {
                setTimeout(() => {
                    preloader.classList.add('fade-out');
                }, 200);
            }

            const promotionPopup = document.getElementById('promotionPopup');
            const closePromoPopup = document.getElementById('closePromoPopup');
            if (promotionPopup && closePromoPopup && !sessionStorage.getItem('promoShown')) {
                setTimeout(() => {
                    promotionPopup.classList.add('show');
                    sessionStorage.setItem('promoShown', 'true');
                }, 1000);

                const closePopup = () => promotionPopup.classList.remove('show');
                closePromoPopup.addEventListener('click', closePopup);
                promotionPopup.addEventListener('click', (e) => { if (e.target === promotionPopup) closePopup(); });
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePopup(); });
            }
        });
    </script>
</body>
</html>

