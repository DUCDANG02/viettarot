<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản Trị Supabase (CKEditor)</title>

    <link rel="icon" type="image/png" href="image/logotab.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            '50': '#eff6ff',
                            '100': '#dbeafe',
                            '200': '#bfdbfe',
                            '300': '#93c5fd',
                            '400': '#60a5fa',
                            '500': '#3b82f6',
                            '600': '#2563eb',
                            '700': '#1d4ed8',
                            '800': '#1e40af',
                            '900': '#1e3a8a',
                            '950': '#172554',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        /* CSS giữ nguyên như file gốc của bạn */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        .sidebar-item.active { background-color: #1e40af; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .modal { transition: opacity 0.25s ease; }
        #admin-panel, #login-screen { display: none; }
        .table-row-hover:hover { background-color: #f9fafb; }
        @media (max-width: 767px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); background-color: white; }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid #f3f4f6; }
            .responsive-table tr:last-child td { margin-bottom: 0; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; text-align: left; margin-right: 1rem; color: #374151; flex-shrink: 0; }
            .responsive-table .td-content { word-break: break-all; }
            .responsive-table td.image-cell { justify-content: center; padding: 1rem; }
            .responsive-table td.image-cell::before { display: none; }
            .responsive-table td.action-cell { justify-content: flex-end; background-color: #f9fafb; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        }
        #notification-panel { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
        #notification-panel.open { transform: translateX(0); }
        #notification-badge { display: none; }
        #notification-badge.active { display: block; }
        #realtime-users-panel { transition: transform 0.3s ease-in-out; position: fixed; bottom: 0; left: 0; width: 16rem; z-index: 60; transform: translateY(calc(100% - 3.25rem)); }
        #realtime-users-panel.open { transform: translateY(0); }
        #users-panel-body { height: 24rem; overflow-y: auto; background-color: white; border-top: 1px solid #d1d5db; }
        #toggle-users-panel svg { transition: transform 0.3s ease; }
        #realtime-users-panel.open #toggle-users-panel svg { transform: rotate(180deg); }
        .user-list-item .status-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; position: absolute; bottom: -2px; right: -2px; }
        .status-dot.online { background-color: #4ade80; } /* Green */
        .status-dot.guest { background-color: #60a5fa; } /* Blue */
        .ck-editor__editable_inline { min-height: 150px; }
        :root { --ck-z-default: 100; --ck-z-modal: calc( var(--ck-z-default) + 999 ); }
        #form-modal .ck.ck-balloon-panel { z-index: 60 !important; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="login-screen" class="flex items-center justify-center h-screen bg-gray-200 p-4">
        <div class="w-full max-w-sm bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Đăng nhập Admin</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu</label>
                    <input type="password" id="password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" required>
                </div>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center hidden"></div>
                <button type="submit" id="login-button" class="w-full bg-primary-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-primary-700 transition duration-300 shadow-sm">
                    Đăng nhập
                </button>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="relative min-h-screen md:flex">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

        <aside id="sidebar" class="w-64 bg-gray-900 text-white flex-shrink-0 fixed inset-y-0 left-0 z-40 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-5 bg-gray-900 text-2xl font-bold text-center">Admin</div>
            <nav class="mt-5 px-2">
                <a href="#" id="nav-dashboard" class="sidebar-item flex items-center py-2.5 px-4 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fa-solid fa-house w-6 h-6 mr-3 text-center"></i>
                    <span>Bảng điều khiển</span>
                </a>
                <a href="#" id="nav-courses" class="sidebar-item flex items-center py-2.5 px-4 rounded-lg mt-1 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fa-solid fa-graduation-cap w-6 h-6 mr-3 text-center"></i>
                    <span>Khóa học</span>
                </a>
                <a href="#" id="nav-documents" class="sidebar-item flex items-center py-2.5 px-4 rounded-lg mt-1 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                   <i class="fa-solid fa-file-lines w-6 h-6 mr-3 text-center"></i>
                    <span>Tài liệu</span>
                </a>
                <a href="#" id="nav-posts" class="sidebar-item flex items-center py-2.5 px-4 rounded-lg mt-1 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fa-solid fa-newspaper w-6 h-6 mr-3 text-center"></i>
                    <span>Bài viết</span>
                </a>
                <a href="#" id="nav-tarot_cards" class="sidebar-item flex items-center py-2.5 px-4 rounded-lg mt-1 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fa-solid fa-layer-group w-6 h-6 mr-3 text-center"></i>
                    <span>Lá bài Tarot</span>
                </a>
                <a href="#" id="nav-profiles" class="sidebar-item flex items-center py-2.5 px-4 rounded-lg mt-1 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fa-solid fa-users w-6 h-6 mr-3 text-center"></i>
                    <span>Hồ sơ</span>
                </a>
                <!-- START: THAY ĐỔI - Thêm mục Slider vào menu -->
                <a href="#" id="nav-sliders" class="sidebar-item flex items-center py-2.5 px-4 rounded-lg mt-1 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                     <i class="fa-solid fa-images w-6 h-6 mr-3 text-center"></i>
                    <span>Slider</span>
                </a>
                <!-- END: THAY ĐỔI -->
                <a href="#" id="nav-settings" class="sidebar-item flex items-center py-2.5 px-4 rounded-lg mt-1 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fa-solid fa-gears w-6 h-6 mr-3 text-center"></i>
                    <span>Cài đặt</span>
                </a>
            </nav>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden bg-gray-100">
            <header class="flex items-center justify-between p-4 bg-white border-b sticky top-0 z-20 shadow-sm">
                <div class="flex items-center">
                    <button id="menu-button" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-900 hover:bg-gray-100 mr-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="page-title" class="text-xl md:text-2xl font-semibold text-gray-800">Bảng điều khiển</h1>
                </div>
                <div class="flex items-center space-x-2 md:space-x-3">
                     <div class="relative">
                        <button id="column-toggle-button" class="bg-white text-gray-600 font-bold py-2 px-3 rounded-lg hover:bg-gray-100 border border-gray-300 transition duration-300 flex items-center hidden shadow-sm">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" /><path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 0 1 0-1.18l.853-1.046a1.651 1.651 0 0 0-.54-2.257l-1.046-.853a1.651 1.651 0 0 1 1.18-2.887l1.046.853a1.651 1.651 0 0 0 2.257-.54l.853-1.046a1.651 1.651 0 0 1 2.887 1.18l-.853 1.046a1.651 1.651 0 0 0 .54 2.257l1.046.853a1.651 1.651 0 0 1-1.18 2.887l-1.046-.853a1.651 1.651 0 0 0-2.257.54l-.853 1.046a1.651 1.651 0 0 1-2.887-1.18l.853-1.046a1.651 1.651 0 0 0-.54-2.257L.664 10.59ZM10 15a5 5 0 1 0 0-10 5 5 0 0 0 0 10Z" clip-rule="evenodd" /></svg>
                            <span class="hidden sm:inline ml-2">Cột</span>
                        </button>
                        <div id="column-selector" class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-20 hidden p-4 border">
                            <h4 class="text-sm font-bold mb-2 text-gray-700">Hiển thị các cột</h4>
                            <div id="column-checkboxes" class="space-y-2">
                            </div>
                        </div>
                    </div>
                     <button id="import-excel-button" class="bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700 transition duration-300 flex items-center hidden shadow-sm">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-11.25a.75.75 0 0 0-1.5 0v4.59L7.3 9.7a.75.75 0 0 0-1.1 1.02l3.25 3.5a.75.75 0 0 0 1.1 0l3.25-3.5a.75.75 0 1 0-1.1-1.02l-1.95 2.1V6.75Z" clip-rule="evenodd" /></svg>
                         <span class="hidden sm:inline ml-2">Import</span>
                     </button>
                     <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">

                     <button id="add-new-button" class="bg-primary-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-primary-700 transition duration-300 flex items-center shadow-sm">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                         <span class="hidden sm:inline ml-2">Thêm mới</span>
                     </button>
                    
                    <button id="notification-button" class="relative p-2 rounded-full text-gray-500 hover:text-gray-900 hover:bg-gray-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-badge" class="absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white"></span>
                    </button>

                    <button id="logout-button" class="bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700 transition duration-300 flex items-center shadow-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                         <span class="hidden sm:inline ml-2">Đăng xuất</span>
                    </button>
                </div>
            </header>
            <div id="content" class="flex-1 p-4 md:p-6 overflow-y-auto">
                <div id="loading-indicator" class="text-center p-10">
                    <p class="text-gray-500 text-lg">Đang tải dữ liệu...</p>
                </div>
            </div>
        </main>

        <div id="notification-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
        <aside id="notification-panel" class="w-full sm:w-80 md:w-96 bg-white shadow-lg fixed top-0 right-0 h-full z-50 flex flex-col">
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">Thông báo</h3>
                <button id="close-notification-button" class="p-2 rounded-full hover:bg-gray-200">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="notification-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                 <div class="text-center text-gray-400 p-8">
                    <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <p>Chưa có thông báo nào.</p>
                </div>
            </div>
        </aside>

    </div>

    <div id="form-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-full flex flex-col">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-lg sticky top-0 z-10">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-700"></h3>
                <button id="close-modal-button" class="text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <form id="data-form" class="p-6 flex-grow overflow-y-auto">
                 <!-- Form content will be generated here -->
            </form>
            <div class="p-4 border-t flex justify-end bg-gray-50 rounded-b-lg sticky bottom-0 z-10">
                <button type="button" id="cancel-button" class="mr-3 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">Hủy</button>
                <button type="button" id="save-button" class="bg-primary-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-700 transition duration-200 shadow-sm">Lưu</button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 text-center">
                <svg class="w-16 h-16 mx-auto text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h3 class="text-xl font-semibold mt-4 mb-2">Xác nhận xóa</h3>
                <p class="text-gray-600 mb-6">Bạn có chắc chắn muốn xóa mục này không? Hành động này không thể hoàn tác.</p>
            </div>
            <div class="p-4 bg-gray-50 flex justify-center rounded-b-lg space-x-4">
                <button id="cancel-delete-button" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">Hủy</button>
                <button id="confirm-delete-button" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200 shadow-sm">Xóa</button>
            </div>
        </div>
    </div>
    
    <div id="import-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-full flex flex-col">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h3 class="text-xl font-semibold text-gray-700">Import Dữ liệu từ Excel</h3>
                <button id="close-import-modal-button" class="text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <div id="import-instructions" class="mb-4 bg-blue-50 border-l-4 border-blue-400 text-blue-700 p-4 rounded-md">
                    <p class="font-bold">Hướng dẫn:</p>
                    <p>1. Chọn cột Excel tương ứng với từng trường dữ liệu của hệ thống.</p>
                    <p>2. Hệ thống sẽ bỏ qua các trường không được ánh xạ.</p>
                    <p>3. Kiểm tra dữ liệu xem trước bên dưới trước khi xác nhận.</p>
                </div>
                <h4 class="text-lg font-semibold mb-2">Ánh xạ cột</h4>
                <div id="column-mapping" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                </div>
                <h4 class="text-lg font-semibold mb-2">Xem trước dữ liệu (5 dòng đầu)</h4>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="import-preview-head" class="bg-gray-50"></thead>
                        <tbody id="import-preview-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end bg-gray-50 rounded-b-lg">
                <button type="button" id="cancel-import-button" class="mr-3 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">Hủy</button>
                <button type="button" id="start-import-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-sm">Bắt đầu Import</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 w-full max-w-xs p-4 rounded-lg shadow-lg text-white flex items-center space-x-3 opacity-0 transform translate-y-10 transition-all duration-300 z-[70]">
        <div id="toast-icon" class="flex-shrink-0 w-6 h-6">
        </div>
        <p id="toast-message" class="flex-1 text-sm font-medium"></p>
    </div>

    <div id="realtime-users-panel">
        <div id="users-panel-header" class="bg-gray-800 text-white p-3 rounded-t-lg cursor-pointer flex justify-between items-center shadow-lg hover:bg-gray-700 transition-colors">
            <h4 class="font-semibold text-sm flex items-center">
                <i class="fas fa-wifi text-green-400 mr-2 animate-pulse"></i>
                <span id="online-users-count">0</span>&nbsp;Người dùng Online
            </h4>
            <button id="toggle-users-panel" class="text-white p-1 rounded-full hover:bg-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
        <div id="users-panel-body">
            <div id="online-users-list" class="divide-y divide-gray-200">
                <div class="p-4 text-center text-gray-500">
                    <p>Đang kết nối...</p>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // ===================================================================================
        // CẤU HÌNH SUPABASE
        // ===================================================================================
        const SUPABASE_URL = 'https://lkznteubcwladqkxyaqo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxrem50ZXViY3dsYWRxa3h5YXFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjcwODksImV4cCI6MjA2NzgwMzA4OX0.7P4-H_ujbLG2KLEFiVtlGIs8o515OkqNw9MVPDF7sCY';
        const BUCKET_NAME = 'public-uploads';
        // ===================================================================================

        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            document.getElementById('content').innerHTML = `
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                    <p class="font-bold">Cảnh báo Cấu hình</p>
                    <p>Vui lòng mở file HTML và cập nhật <b>SUPABASE_URL</b> và <b>SUPABASE_ANON_KEY</b> bằng thông tin Supabase project của bạn để ứng dụng hoạt động.</p>
                </div>
            `;
        }

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GLOBAL STATE ---
        let currentSection = 'dashboard'; 
        let currentItemId = null;
        let deleteHandler = null;
        let currentPage = 1;
        const ITEMS_PER_PAGE = 10;
        let excelData = [];
        let columnPreferences = {};
        let isInitialLoad = true;
        let hasNewNotification = false;
        let adminUserId = null;
        let editorInstances = {};
        let recentActivities = []; 
        let pendingJoinActivityTimeouts = new Map();
        const JOIN_ACTIVITY_DELAY = 6000;

        // --- UI ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        
        const menuButton = document.getElementById('menu-button');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        const contentDiv = document.getElementById('content');
        const pageTitle = document.getElementById('page-title');
        const loadingIndicator = document.getElementById('loading-indicator');
        const addNewButton = document.getElementById('add-new-button');
        const formModal = document.getElementById('form-modal');
        const modalTitle = document.getElementById('modal-title');
        const dataForm = document.getElementById('data-form');
        const closeModalButton = document.getElementById('close-modal-button');
        const cancelButton = document.getElementById('cancel-button');
        const saveButton = document.getElementById('save-button');
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');

        const importExcelButton = document.getElementById('import-excel-button');
        const excelFileInput = document.getElementById('excel-file-input');
        const importModal = document.getElementById('import-modal');
        const closeImportModalButton = document.getElementById('close-import-modal-button');
        const cancelImportButton = document.getElementById('cancel-import-button');
        const startImportButton = document.getElementById('start-import-button');
        const columnMappingDiv = document.getElementById('column-mapping');
        const importPreviewHead = document.getElementById('import-preview-head');
        const importPreviewBody = document.getElementById('import-preview-body');

        const columnToggleButton = document.getElementById('column-toggle-button');
        const columnSelector = document.getElementById('column-selector');
        const columnCheckboxes = document.getElementById('column-checkboxes');
        
        const notificationButton = document.getElementById('notification-button');
        const notificationPanel = document.getElementById('notification-panel');
        const notificationOverlay = document.getElementById('notification-overlay');
        const closeNotificationButton = document.getElementById('close-notification-button');
        const notificationList = document.getElementById('notification-list');
        const notificationBadge = document.getElementById('notification-badge');

        const realtimeUsersPanel = document.getElementById('realtime-users-panel');
        const usersPanelHeader = document.getElementById('users-panel-header');
        const toggleUsersPanel = document.getElementById('toggle-users-panel');
        const onlineUsersList = document.getElementById('online-users-list');
        const onlineUsersCount = document.getElementById('online-users-count');
        
        // --- TÁCH BIỆT TRẠNG THÁI ---
        let onlinePresence = {}; // Dành cho người dùng đăng nhập
        let onlineGuests = {}; // Dành cho khách
        
        const pendingLeaveTimeouts = new Map();
        const LEAVE_DELAY = 6000;
        const GUEST_TIMEOUT_MS = 5 * 60 * 1000; // 5 phút
        const guestTimeouts = new Map();


        // --- CONFIGURATION FOR EACH SECTION ---
        const sections = {
            dashboard: {
                title: 'Bảng điều khiển',
                render: (stats) => renderDashboard(stats),
            },
            courses: {
                title: 'Quản lý Khóa học',
                table: 'courses',
                defaultColumns: ['id', 'image_url', 'title', 'instructor_name', 'price_sale'],
                fields: [
                    { name: 'id', label: 'ID', type: 'number', readonly: true, grid: 'col-span-12 sm:col-span-2' },
                    { name: 'title', label: 'Tiêu đề', type: 'text', required: true, grid: 'col-span-12 sm:col-span-10' },
                    { name: 'description', label: 'Mô tả', type: 'richtext', rows: 5, grid: 'col-span-12' },
                    { name: 'image_url', label: 'Hình ảnh', type: 'file', storagePath: 'courses', grid: 'col-span-12' },
                    { name: 'instructor_name', label: 'Giảng viên', type: 'text', grid: 'col-span-12 sm:col-span-6' },
                    { name: 'course_type', label: 'Loại', type: 'text', grid: 'col-span-12 sm:col-span-6' },
                    { name: 'price_original', label: 'Giá gốc', type: 'number', grid: 'col-span-12 sm:col-span-6' },
                    { name: 'price_sale', label: 'Giá sale', type: 'number', grid: 'col-span-12 sm:col-span-6' },
                    { name: 'course_link', label: 'Link khóa học', type: 'url', grid: 'col-span-12' },
                ],
                render: (items) => renderTable(items),
            },
            documents: {
                title: 'Quản lý Tài liệu',
                table: 'documents',
                defaultColumns: ['id', 'image_url', 'title', 'author_name', 'category', 'price_sale'],
                fields: [
                    { name: 'id', label: 'ID', type: 'number', readonly: true, grid: 'col-span-12 sm:col-span-2' },
                    { name: 'title', label: 'Tiêu đề', type: 'text', required: true, import: true, grid: 'col-span-12 sm:col-span-10' },
                    { name: 'description', label: 'Mô tả', type: 'richtext', import: true, grid: 'col-span-12' },
                    { name: 'image_url', label: 'Hình ảnh', type: 'file', storagePath: 'documents', import: false, grid: 'col-span-12' },
                    { name: 'author_name', label: 'Tác giả', type: 'text', import: true, grid: 'col-span-12 sm:col-span-4' },
                    { name: 'category', label: 'Danh mục', type: 'text', import: true, grid: 'col-span-12 sm:col-span-4' },
                    { name: 'published_at', label: 'Ngày XB', type: 'date', import: true, grid: 'col-span-12 sm:col-span-4' },
                    { name: 'price_original', label: 'Giá gốc', type: 'number', import: true, grid: 'col-span-12 sm:col-span-6' },
                    { name: 'price_sale', label: 'Giá sale', type: 'number', import: true, grid: 'col-span-12 sm:col-span-6' },
                    { name: 'document_url', label: 'URL Tài liệu', type: 'url', import: true, grid: 'col-span-12' },
                ],
                render: (items) => renderTable(items),
            },
            posts: {
                title: 'Quản lý Bài viết',
                table: 'posts',
                defaultColumns: ['id', 'image_url', 'title', 'author_name', 'published_at'],
                fields: [
                    { name: 'id', label: 'ID', type: 'number', readonly: true, grid: 'col-span-12 sm:col-span-2' },
                    { name: 'title', label: 'Tiêu đề', type: 'text', required: true, import: true, grid: 'col-span-12 sm:col-span-10' },
                    { name: 'content', label: 'Nội dung', type: 'richtext', rows: 8, import: true, grid: 'col-span-12' },
                    { name: 'image_url', label: 'Hình ảnh', type: 'file', storagePath: 'posts', import: false, grid: 'col-span-12' },
                    { name: 'author_name', label: 'Tác giả', type: 'text', import: true, grid: 'col-span-12 sm:col-span-6' },
                    { name: 'published_at', label: 'Ngày XB', type: 'date', import: true, grid: 'col-span-12 sm:col-span-6' },
                ],
                render: (items) => renderTable(items),
            },
            tarot_cards: {
                title: 'Quản lý Lá bài Tarot',
                table: 'tarot_cards',
                defaultColumns: ['id', 'image_url', 'name', 'sub_type', 'suit', 'card_group'],
                fields: [
                    { group: 'Thông tin cơ bản', grid: 'col-span-12' },
                    { name: 'id', label: 'ID', type: 'number', readonly: true, grid: 'col-span-12 sm:col-span-2' },
                    { name: 'name', label: 'Tên lá bài', type: 'text', required: true, grid: 'col-span-12 sm:col-span-4' },
                    { name: 'dharma_name', label: 'Tên pháp danh', type: 'text', grid: 'col-span-12 sm:col-span-6' },
                    { name: 'image_url', label: 'Link Hình ảnh (URL)', type: 'url', grid: 'col-span-12' },
                    
                    { group: 'Thuộc tính lá bài', grid: 'col-span-12' },
                    { name: 'sub_type', label: 'Phân loại', type: 'select', required: true, options: ['major_arcana', 'minor_arcana'], grid: 'col-span-12 sm:col-span-3' },
                    { name: 'suit', label: 'Bộ (Suit)', type: 'select', options: ['', 'Wands', 'Cups', 'Swords', 'Pentacles'], grid: 'col-span-12 sm:col-span-3' },
                    { name: 'card_number', label: 'Số thứ tự', type: 'number', grid: 'col-span-12 sm:col-span-3' },
                    { name: 'rank_order', label: 'Hạng (để sắp xếp)', type: 'number', grid: 'col-span-12 sm:col-span-3' },
                    { name: 'card_group', label: 'Nhóm lá bài', type: 'text', grid: 'col-span-12 sm:col-span-4' },
                    { name: 'element', label: 'Nguyên tố', type: 'text', grid: 'col-span-12 sm:col-span-2' },
                    { name: 'polarity', label: 'Tính chất', type: 'text', grid: 'col-span-12 sm:col-span-2' },
                    { name: 'zodiac', label: 'Cung hoàng đạo', type: 'text', grid: 'col-span-12 sm:col-span-4' },

                    { group: 'Nội dung & Ý nghĩa', grid: 'col-span-12' },
                    { name: 'description_original', label: 'Mô tả sách gốc', type: 'richtext', grid: 'col-span-12' },
                    { name: 'symbolism', label: 'Ý nghĩa biểu tượng', type: 'richtext', grid: 'col-span-12' },
                    { name: 'meaning_general', label: 'Ý nghĩa tổng quan', type: 'richtext', grid: 'col-span-12' },
                    { name: 'meaning_upright', label: 'Nghĩa xuôi', type: 'richtext', grid: 'col-span-12 md:col-span-6' },
                    { name: 'meaning_reversed', label: 'Nghĩa ngược', type: 'richtext', grid: 'col-span-12 md:col-span-6' },
                    
                    { group: 'Chủ đề', grid: 'col-span-12' },
                    { name: 'theme_love', label: 'Chủ đề Tình yêu', type: 'richtext', grid: 'col-span-12 md:col-span-4' },
                    { name: 'theme_study', label: 'Chủ đề Học tập', type: 'richtext', grid: 'col-span-12 md:col-span-4' },
                    { name: 'theme_career', label: 'Chủ đề Sự nghiệp', type: 'richtext', grid: 'col-span-12 md:col-span-4' },
                ],
                render: (items) => renderTable(items),
            },
            profiles: {
                title: 'Quản lý Hồ sơ',
                table: 'profiles',
                defaultColumns: ['id', 'avatar_url', 'full_name', 'email', 'role'],
                fields: [
                    { name: 'id', label: 'ID (UUID)', type: 'text', readonly: true, grid: 'col-span-12' },
                    { name: 'full_name', label: 'Họ và tên', type: 'text', grid: 'col-span-12 sm:col-span-6' },
                    { name: 'email', label: 'Email', type: 'email', grid: 'col-span-12 sm:col-span-6' },
                    { name: 'phone_number', label: 'SĐT', type: 'text', grid: 'col-span-12 sm:col-span-6' },
                    { name: 'role', label: 'Vai trò', type: 'text', grid: 'col-span-12 sm:col-span-6' },
                    { name: 'avatar_url', label: 'Ảnh đại diện', type: 'file', storagePath: 'avatars', grid: 'col-span-12' },
                ],
                render: (items) => renderTable(items),
            },
            // START: THAY ĐỔI - Thêm cấu hình cho mục Slider
            sliders: {
                title: 'Quản lý Slider',
                table: 'sliders',
                defaultColumns: ['id', 'image_url', 'title', 'is_active', 'display_order'],
                fields: [
                    { name: 'id', label: 'ID', type: 'number', readonly: true, grid: 'col-span-12 sm:col-span-2' },
                    { name: 'display_order', label: 'Thứ tự hiển thị', type: 'number', grid: 'col-span-12 sm:col-span-4', required: true, defaultValue: 0 },
                    { name: 'is_active', label: 'Trạng thái', type: 'select', options: [{value: true, text: 'Hiển thị'}, {value: false, text: 'Ẩn'}], grid: 'col-span-12 sm:col-span-6', required: true, defaultValue: true },
                    { name: 'title', label: 'Tiêu đề chính', type: 'text', required: true, grid: 'col-span-12' },
                    { name: 'subtitle', label: 'Tiêu đề phụ', type: 'text', grid: 'col-span-12' },
                    { name: 'image_url', label: 'Hình ảnh nền (URL)', type: 'text', storagePath: 'sliders', required: true, grid: 'col-span-12' },
                    { name: 'button_text', label: 'Chữ trên nút', type: 'text', grid: 'col-span-12 sm:col-span-6' },
                    { name: 'button_link', label: 'Link của nút (URL)', type: 'url', grid: 'col-span-12 sm:col-span-6' },
                ],
                render: (items) => renderTable(items),
            },
            // END: THAY ĐỔI
            settings: {
                title: 'Cài đặt Website',
                table: 'website_settings',
                fields: [
                    { name: 'header_logo_url', label: 'Logo Header', type: 'file', storagePath: 'logos' },
                    { name: 'footer_logo_url', label: 'Logo Footer', type: 'file', storagePath: 'logos' },
                    { name: 'service_image_url', label: 'Ảnh Dịch vụ', type: 'file', storagePath: 'services' },
                    { name: 'promotion_image_url', label: 'Ảnh Popup Khuyến mãi', type: 'file', storagePath: 'promotions' },
                ],
                render: (item) => {
                    if (!item) {
                        contentDiv.innerHTML = '<p class="text-gray-600">Không tìm thấy cài đặt. Vui lòng đảm bảo có một bản ghi với id=1 trong bảng website_settings.</p>';
                        return;
                    }
                    const renderImage = (url, isPopup = false) => {
                        if (!url) return '<span class="text-gray-400">Chưa có ảnh</span>';
                        const imgClass = isPopup 
                            ? 'h-48 w-auto object-contain rounded border p-1 bg-white'
                            : 'h-16 w-auto object-contain rounded border p-1 bg-white';
                        return `<img src="${url}" alt="Preview" class="${imgClass}">`;
                    };
                    const html = `
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-bold mb-4">Cài đặt hiện tại</h2>
                            <div class="space-y-6">
                                <div><strong class="font-semibold block mb-2">Logo Header:</strong> ${renderImage(item.header_logo_url)}</div>
                                <div><strong class="font-semibold block mb-2">Logo Footer:</strong> ${renderImage(item.footer_logo_url)}</div>
                                <div><strong class="font-semibold block mb-2">Ảnh Dịch vụ:</strong> ${renderImage(item.service_image_url)}</div>
                                <div><strong class="font-semibold block mb-2">Ảnh Popup Khuyến mãi:</strong> ${renderImage(item.promotion_image_url, true)}</div>
                            </div>
                            <button onclick="window.handleEditClick(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="mt-6 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300">Chỉnh sửa Cài đặt</button>
                        </div>
                    `;
                    contentDiv.innerHTML = html;
                },
            },
        };

        // --- HELPER & RENDER FUNCTIONS ---
        
        function showToast(message, type = 'success') {
            toastMessage.innerHTML = message;
            toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500', 'opacity-0', 'translate-y-10');
            
            switch(type) {
                case 'error':
                    toast.classList.add('bg-red-500');
                    toastIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>`;
                    break;
                case 'info':
                    toast.classList.add('bg-blue-500');
                    toastIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg>`;
                    break;
                case 'success':
                default:
                    toast.classList.add('bg-green-500');
                    toastIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`;
                    break;
            }

            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 5000);
        }

        function timeAgo(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " năm trước";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " tháng trước";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " ngày trước";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " giờ trước";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " phút trước";
            return "vừa xong";
        }

        function renderDashboard(stats) {
            const isLoading = stats.loading;
            const statsCards = [
                { title: 'Tổng Người Dùng', value: stats.profiles, icon: `<i class="fa-solid fa-users w-8 h-8"></i>`, section: 'profiles' },
                { title: 'Tổng Khóa Học', value: stats.courses, icon: `<i class="fa-solid fa-graduation-cap w-8 h-8"></i>`, section: 'courses' },
                { title: 'Tổng Tài Liệu', value: stats.documents, icon: `<i class="fa-solid fa-file-lines w-8 h-8"></i>`, section: 'documents' },
                { title: 'Tổng Bài Viết', value: stats.posts, icon: `<i class="fa-solid fa-newspaper w-8 h-8"></i>`, section: 'posts' },
            ];

            const cardsHtml = statsCards.map(card => `
                <div onclick="window.switchSection('${card.section}')" class="bg-white p-6 rounded-xl shadow-md flex items-center transition-transform transform hover:scale-105 cursor-pointer">
                    <div class="bg-primary-100 text-primary-600 p-4 rounded-full mr-6 text-2xl flex items-center justify-center">
                        ${card.icon}
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">${card.title}</p>
                        <p class="text-3xl font-bold text-gray-800">${isLoading ? '...' : (card.value ?? 0)}</p>
                    </div>
                </div>
            `).join('');

            contentDiv.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            ${cardsHtml}
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl shadow-md h-full flex flex-col">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-3">Hoạt động gần đây</h3>
                            <div id="recent-activity-list" class="space-y-4 mt-4 flex-1 overflow-y-auto" style="max-height: 450px;">
                                ${[1,2,3,4,5].map(() => `
                                    <div class="flex items-center space-x-3 animate-pulse">
                                        <div class="flex-shrink-0 rounded-full bg-gray-200 h-8 w-8"></div>
                                        <div class="flex-1 space-y-2 py-1">
                                            <div class="h-3 bg-gray-200 rounded w-full"></div>
                                            <div class="h-2 bg-gray-200 rounded w-1/3"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateDashboardStats(stats) {
             const statsValues = [stats.profiles, stats.courses, stats.documents, stats.posts];
             const statElements = document.querySelectorAll('#content .text-3xl');
             if (statElements.length === statsValues.length) {
                 statElements.forEach((el, index) => {
                     el.textContent = statsValues[index] ?? 0;
                 });
             }
        }
        
        async function loadRecentActivities() {
            try {
                const fetchLimit = 25; 
                const [profilesRes, postsRes] = await Promise.all([
                    supabase.from('profiles').select('id, full_name, created_at').order('created_at', { ascending: false }).limit(fetchLimit),
                    supabase.from('posts').select('id, title, created_at').order('created_at', { ascending: false }).limit(fetchLimit)
                ]);

                const historicalActivities = [];

                if (profilesRes.data) {
                    profilesRes.data.forEach(item => historicalActivities.push({ type: 'user_registered', timestamp: item.created_at, data: item }));
                }
                if (postsRes.data) {
                    postsRes.data.forEach(item => historicalActivities.push({ type: 'new_post', timestamp: item.created_at, data: item }));
                }
                
                const realTimeActivities = recentActivities.filter(act => ['user_online', 'new_visitor'].includes(act.type));
                const combinedActivities = [...realTimeActivities, ...historicalActivities];

                recentActivities = combinedActivities
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 50);

                renderRecentActivities(recentActivities);

            } catch (error) {
                const activityList = document.getElementById('recent-activity-list');
                if(activityList) {
                     activityList.innerHTML = `<p class="text-red-500">Không thể tải hoạt động.</p>`;
                }
                console.error("Error loading recent activities:", error);
            }
        }

        function renderRecentActivities(activities) {
            const activityList = document.getElementById('recent-activity-list');
            if (!activityList) return;

            if (activities.length === 0) {
                activityList.innerHTML = '<p class="text-gray-500">Chưa có hoạt động nào.</p>';
                return;
            }

            const activityIcons = {
                user_registered: { icon: 'fa-user-plus', color: 'text-green-500', bg: 'bg-green-100' },
                new_post: { icon: 'fa-newspaper', color: 'text-blue-500', bg: 'bg-blue-100' },
                user_online: { icon: 'fa-wifi', color: 'text-teal-500', bg: 'bg-teal-100' },
                new_visitor: { icon: 'fa-user-secret', color: 'text-indigo-500', bg: 'bg-indigo-100' },
            };

            activityList.innerHTML = activities.map(activity => {
                const config = activityIcons[activity.type];
                if (!config) return ''; 
                
                let text = '';
                switch (activity.type) {
                    case 'user_registered':
                        text = `<strong>${activity.data.full_name || 'Người dùng mới'}</strong> vừa đăng ký.`;
                        break;
                    case 'new_post':
                        text = `Bài viết mới: <strong>${activity.data.title}</strong>.`;
                        break;
                    case 'user_online':
                        text = `<strong>${activity.data.full_name || 'Một người dùng'}</strong> vừa online.`;
                        break;
                    case 'new_visitor':
                        text = `<strong>${activity.data.alias}</strong> vừa truy cập trang <strong>${activity.data.pageName}</strong>.`;
                        break;
                }

                return `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 ${config.bg} ${config.color} rounded-full h-8 w-8 flex items-center justify-center">
                            <i class="fa-solid ${config.icon} text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-700 truncate">${text}</p>
                            <p class="text-xs text-gray-400 mt-0.5">${timeAgo(activity.timestamp)}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function addActivity(activity) {
            if (currentSection !== 'dashboard') return;
            recentActivities.unshift(activity);
            recentActivities = recentActivities.slice(0, 50);
            renderRecentActivities(recentActivities);
        }

        function formatCurrency(number) {
            if (number === null || typeof number === 'undefined') return '';
            return new Intl.NumberFormat('de-DE').format(number) + 'đ';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) { return dateString; }
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (error) { return dateString; }
        }

        function createPageLink(page, currentPage) {
             const baseClasses = "relative inline-flex items-center px-4 py-2 border text-sm font-medium";
             if (page === currentPage) {
                 return `<a href="#" aria-current="page" class="z-10 bg-primary-50 border-primary-500 text-primary-600 ${baseClasses} rounded-md"> ${page} </a>`;
             }
             return `<a href="#" onclick="window.handleChangePage(${page})" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 ${baseClasses} rounded-md"> ${page} </a>`;
        }

        function createEllipsis() {
             return `<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 rounded-md"> ... </span>`;
        }
        
        function generatePageLinks(totalPages, currentPage) {
            let links = '';
            const pageNeighbours = 1; 
            if (totalPages <= 5) {
                for (let i = 1; i <= totalPages; i++) { links += createPageLink(i, currentPage); }
                return links;
            }
            links += createPageLink(1, currentPage);
            if (currentPage > pageNeighbours + 2) { links += createEllipsis(); }
            let startPage = Math.max(2, currentPage - pageNeighbours);
            let endPage = Math.min(totalPages - 1, currentPage + pageNeighbours);
            for (let i = startPage; i <= endPage; i++) { links += createPageLink(i, currentPage); }
            if (currentPage < totalPages - (pageNeighbours + 1)) { links += createEllipsis(); }
            links += createPageLink(totalPages, currentPage);
            return links;
        }

        function renderPagination(totalItems, currentPage) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (totalPages <= 1) return '';

            const fromItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
            const toItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
            const prevDisabled = currentPage === 1;
            const nextDisabled = currentPage === totalPages;
            const prevClass = prevDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50';
            const nextClass = nextDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50';

            return `
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 mt-[-1px] rounded-b-lg">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <a href="#" onclick="${prevDisabled ? '' : `window.handleChangePage(${currentPage - 1})`}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white ${prevClass}">Trước</a>
                        <a href="#" onclick="${nextDisabled ? '' : `window.handleChangePage(${currentPage + 1})`}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white ${nextClass}">Sau</a>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Hiển thị từ <span class="font-medium">${fromItem}</span> đến <span class="font-medium">${toItem}</span> của <span class="font-medium">${totalItems}</span> kết quả
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm space-x-2" aria-label="Pagination">
                                <a href="#" onclick="${prevDisabled ? '' : `window.handleChangePage(${currentPage - 1})`}" class="relative inline-flex items-center px-2 py-2 rounded-md border border-gray-300 bg-white text-sm font-medium text-gray-500 ${prevClass}">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                </a>
                                ${generatePageLinks(totalPages, currentPage)}
                                <a href="#" onclick="${nextDisabled ? '' : `window.handleChangePage(${currentPage + 1})`}" class="relative inline-flex items-center px-2 py-2 rounded-md border border-gray-300 bg-white text-sm font-medium text-gray-500 ${nextClass}">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                </a>
                            </nav>
                        </div>
                    </div>
                </div>`;
        }
        
        function renderTable(items) {
            const visibleColumns = getVisibleColumns(currentSection);
            if (!items || items.length === 0) { return '<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-gray-500">Không có dữ liệu.</p></div>'; }
            if (visibleColumns.length === 0) { return '<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-gray-500">Không có cột nào được chọn để hiển thị. Vui lòng chọn trong menu "Cột".</p></div>'; }
            const headers = visibleColumns.map(colName => {
                const field = sections[currentSection].fields.find(f => f.name === colName);
                return field ? field.label : colName.replace(/_/g, ' ');
            });
            const rows = items.map(item => {
                const cells = visibleColumns.map((colName, index) => {
                    let value = item[colName];
                    const isImageUrl = typeof value === 'string' && (value.includes('supabase.co') || value.startsWith('http'));
                    const headerLabel = headers[index];
                    let tdClass = 'py-4 px-6';
                    
                    // START: THAY ĐỔI - Hiển thị trạng thái boolean đẹp hơn
                    if (typeof value === 'boolean') {
                        const statusClass = value ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const statusText = value ? 'Hiển thị' : 'Ẩn';
                        return `<td data-label="${headerLabel}" class="${tdClass}"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusText}</span></td>`;
                    }
                    // END: THAY ĐỔI

                    if (colName.includes('price_')) { value = formatCurrency(value); }
                    if (colName.endsWith('_at') || colName === 'published_at') { value = formatDate(value); }
                    if (colName === 'id' || colName === 'display_order') { tdClass += ' text-center'; }

                    if (isImageUrl) {
                        return `<td data-label="${headerLabel}" class="image-cell ${tdClass}"><img src="${value}" alt="${colName}" class="w-16 h-16 object-cover rounded-md shadow-sm"></td>`;
                    }
                    if (typeof value === 'string' && value.includes('<')) {
                         const tempDiv = document.createElement('div');
                         tempDiv.innerHTML = value;
                         value = tempDiv.textContent || tempDiv.innerText || '';
                         if (value.length > 100) value = value.substring(0, 100) + '...';
                    }
                    return `<td data-label="${headerLabel}" class="${tdClass}"><div class="td-content text-sm text-gray-700">${value !== null ? value : ''}</div></td>`;
                }).join('');
                const actionButtons = `
                    <div class="flex items-center justify-end space-x-1">
                        <button onclick="window.handleEditClick(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="group relative p-2 rounded-full hover:bg-blue-100 text-blue-600 transition-colors">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 whitespace-nowrap bg-gray-800 text-white text-xs px-2 py-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">Sửa</span>
                        </button>
                        ${(currentSection !== 'profiles') ? `
                        <button onclick="window.handleDeleteClick(${item.id})" class="group relative p-2 rounded-full hover:bg-red-100 text-red-600 transition-colors">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                            <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 whitespace-nowrap bg-gray-800 text-white text-xs px-2 py-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">Xóa</span>
                        </button>
                        ` : ''}
                    </div>
                `;
                return `<tr class="table-row-hover">${cells}<td data-label="Hành động" class="action-cell py-4 px-6">${actionButtons}</td></tr>`;
            }).join('');
            const tableHeaders = headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('');
            return `
                <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200 responsive-table">
                        <thead class="bg-gray-50"><tr>${tableHeaders}<th class="relative px-6 py-3 text-right">Hành động</th></tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">${rows}</tbody>
                    </table>
                </div>`;
        }

        function createFormFields(fields) {
            let html = '<div class="grid grid-cols-12 gap-x-6 gap-y-4">';
            fields.forEach(field => {
                const requiredAttr = field.required ? 'required' : '';
                const readonlyAttr = field.readonly ? 'readonly class="bg-gray-100 cursor-not-allowed"' : '';
                const commonClasses = "mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm";
                
                if (field.group) {
                    html += `<div class="${field.grid || 'col-span-12'} mt-4 mb-2 border-b pb-2">
                                <h4 class="text-lg font-semibold text-gray-700">${field.group}</h4>
                             </div>`;
                    return;
                }

                html += `<div class="${field.grid || 'col-span-12'}">`;
                html += `<label for="${field.name}" class="block text-sm font-medium text-gray-700">${field.label}${field.required ? '<span class="text-red-500 ml-1">*</span>' : ''}</label>`;

                switch (field.type) {
                    case 'file':
                        html += `
                            <div class="mt-2 flex items-center space-x-4">
                                <img id="${field.name}-preview" src="https://placehold.co/100x100/e2e8f0/a0aec0?text=Preview" alt="Xem trước" class="w-24 h-24 object-cover rounded-md bg-gray-100 border">
                                <div class="flex-1">
                                    <input type="file" id="${field.name}" name="${field.name}" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100" accept="image/*" onchange="window.previewFile('${field.name}')">
                                    <input type="hidden" id="${field.name}-hidden" name="${field.name}-hidden">
                                    <p class="text-xs text-gray-500 mt-1">Để trống nếu không muốn thay đổi ảnh.</p>
                                </div>
                            </div>`;
                        break;
                    case 'textarea':
                    case 'richtext':
                        html += `<textarea id="${field.name}" name="${field.name}" rows="${field.rows || 4}" class="${commonClasses}" ${requiredAttr}></textarea>`;
                        break;
                    // START: THAY ĐỔI - Cho phép select options là object
                    case 'select':
                        const optionsHtml = field.options.map(opt => {
                            if (typeof opt === 'object') {
                                return `<option value="${opt.value}">${opt.text}</option>`;
                            }
                            return `<option value="${opt}">${opt.charAt(0).toUpperCase() + opt.slice(1).replace(/_/g, ' ')}</option>`;
                        }).join('');
                        html += `<select id="${field.name}" name="${field.name}" class="${commonClasses}" ${requiredAttr}>${optionsHtml}</select>`;
                        break;
                    // END: THAY ĐỔI
                    default:
                        html += `<input type="${field.type}" id="${field.name}" name="${field.name}" class="${commonClasses}" ${requiredAttr} ${readonlyAttr}>`;
                        break;
                }
                html += `</div>`;
            });
            html += '</div>';
            return html;
        }

        function populateForm(item) {
            const config = sections[currentSection];
            config.fields.forEach(field => {
                if(field.group) return;
                const input = document.getElementById(field.name);
                if (!input) return;

                const value = item[field.name] != null ? item[field.name] : '';

                if (field.type === 'richtext') {
                    input.value = value;
                } else if (field.type === 'file') {
                    const preview = document.getElementById(`${field.name}-preview`);
                    const hiddenInput = document.getElementById(`${field.name}-hidden`);
                    if (value) {
                        preview.src = value;
                        hiddenInput.value = value;
                    } else {
                        preview.src = "https://placehold.co/100x100/e2e8f0/a0aec0?text=Preview";
                        hiddenInput.value = '';
                    }
                } else if (field.type === 'date' && value) {
                    input.value = new Date(value).toISOString().split('T')[0];
                } else {
                    input.value = value;
                }
            });
            if (currentSection === 'tarot_cards') {
                toggleSuitField();
            }
        }

        // --- DATA FETCHING & MANIPULATION ---
        async function loadData() {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL') return;
            loadingIndicator.style.display = 'block';
            contentDiv.innerHTML = '';
            const config = sections[currentSection];
            const isPaginated = !['dashboard', 'settings'].includes(currentSection);
            try {
                if (currentSection === 'dashboard') {
                    loadingIndicator.style.display = 'none';
                    config.render({ loading: true }); 
                    loadRecentActivities(); 

                    const [ { count: profilesCount, error: pErr }, { count: coursesCount, error: cErr }, { count: documentsCount, error: dErr }, { count: postsCount, error: poErr } ] = await Promise.all([
                        supabase.from('profiles').select('*', { count: 'exact', head: true }),
                        supabase.from('courses').select('*', { count: 'exact', head: true }),
                        supabase.from('documents').select('*', { count: 'exact', head: true }),
                        supabase.from('posts').select('*', { count: 'exact', head: true })
                    ]);
                    const errorMessages = [pErr, cErr, dErr, poErr].filter(Boolean).map(e => e.message).join(', ');
                    if(errorMessages) throw new Error(`Lỗi khi lấy dữ liệu thống kê: ${errorMessages}`);
                    
                    updateDashboardStats({ profiles: profilesCount, courses: coursesCount, documents: documentsCount, posts: postsCount });

                } else if (currentSection === 'settings') {
                    const { data, error } = await supabase.from(config.table).select('*').eq('id', 1).single();
                    if (error && error.code !== 'PGRST116') throw error;
                    config.render(data);
                } else {
                    let query = supabase.from(config.table).select('*', { count: 'exact' });
                    if (isPaginated) {
                        const from = (currentPage - 1) * ITEMS_PER_PAGE;
                        const to = from + ITEMS_PER_PAGE - 1;
                        query = query.range(from, to);
                    }
                    
                    // Sắp xếp mặc định
                    let orderByField = 'created_at';
                    let orderOpts = { ascending: false };
                    
                    if (currentSection === 'tarot_cards') {
                        orderByField = 'rank_order';
                        orderOpts = { ascending: true, nullsFirst: false };
                    } else if (currentSection === 'sliders') {
                        orderByField = 'display_order';
                        orderOpts = { ascending: true };
                    }
                    
                    query = query.order(orderByField, orderOpts);
                    if (currentSection === 'tarot_cards') {
                        query = query.order('name', { ascending: true });
                    }

                    const { data, error, count } = await query;
                    if (error) throw error;
                    contentDiv.innerHTML = config.render(data);
                    if (isPaginated && count > ITEMS_PER_PAGE) {
                       contentDiv.insertAdjacentHTML('beforeend', renderPagination(count, currentPage));
                    }
                }
            } catch (error) {
                showToast(`Lỗi tải dữ liệu: ${error.message}`, 'error');
                contentDiv.innerHTML = `<p class="text-red-500">Lỗi: ${error.message}</p>`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        async function handleFormSubmit() {
            saveButton.disabled = true;
            saveButton.textContent = 'Đang lưu...';
            const config = sections[currentSection];
            const formData = new FormData(dataForm);
            const record = {};

            try {
                for (const fieldName in editorInstances) {
                    record[fieldName] = editorInstances[fieldName].getData();
                }

                for (const field of config.fields) {
                    if (field.group || field.type === 'richtext') continue;

                    if (field.type === 'file') {
                        const fileInput = document.getElementById(field.name);
                        const file = fileInput.files[0];
                        if (file) {
                            const filePath = `${field.storagePath}/${Date.now()}_${file.name.replace(/\s/g, '_')}`;
                            const { error: uploadError } = await supabase.storage.from(BUCKET_NAME).upload(filePath, file);
                            if (uploadError) throw new Error(`Lỗi tải ảnh: ${uploadError.message}`);
                            const { data } = supabase.storage.from(BUCKET_NAME).getPublicUrl(filePath);
                            record[field.name] = data.publicUrl;
                        } else if (currentItemId) {
                            const hiddenInput = document.getElementById(`${field.name}-hidden`);
                            record[field.name] = hiddenInput.value || null;
                        } else {
                             record[field.name] = null;
                        }
                    } else if (!field.readonly) {
                        let value = formData.get(field.name);
                        
                        // START: THAY ĐỔI - Chuyển đổi giá trị boolean từ string
                        if (field.name === 'is_active' && typeof value === 'string') {
                            value = (value === 'true');
                        }
                        // END: THAY ĐỔI

                        if ((field.type === 'number') && value === '') {
                             value = null; // Chuyển chuỗi rỗng thành null cho kiểu số
                        }
                        
                        record[field.name] = value;
                    }
                }
                
                let error;
                if (currentItemId) {
                    const { error: updateError } = await supabase.from(config.table).update(record).eq('id', currentItemId);
                    error = updateError;
                } else {
                    const { error: insertError } = await supabase.from(config.table).insert([record]);
                    error = insertError;
                }
                if (error) throw error;
                showToast(`Đã ${currentItemId ? 'cập nhật' : 'tạo mới'} thành công!`);
                closeModal();
                loadData();
            } catch (err) {
                showToast(`Lỗi: ${err.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Lưu';
            }
        }
        
        async function performDelete() {
            if (!deleteHandler) return;
            const { error } = await deleteHandler();
            if (error) {
                showToast(`Lỗi xóa: ${error.message}`, 'error');
            } else {
                showToast('Đã xóa thành công!');
                loadData();
            }
            closeDeleteModal();
        }

        // --- EXCEL IMPORT FUNCTIONS ---
        function handleImportFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (jsonData.length < 2) {
                        showToast('File Excel trống hoặc không có dữ liệu.', 'error');
                        return;
                    }
                    const headers = jsonData[0];
                    excelData = jsonData.slice(1).map(row => {
                        let rowData = {};
                        headers.forEach((header, index) => { rowData[header] = row[index]; });
                        return rowData;
                    });
                    openImportModal(headers);
                } catch (error) {
                    showToast(`Lỗi đọc file Excel: ${error.message}`, 'error');
                }
            };
            reader.onerror = () => { showToast('Không thể đọc file đã chọn.', 'error'); };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function openImportModal(excelHeaders) {
            const config = sections[currentSection];
            const importableFields = config.fields.filter(f => f.import !== false && !f.readonly);
            columnMappingDiv.innerHTML = importableFields.map(field => `
                <div class="flex flex-col">
                    <label for="map-${field.name}" class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                    <select id="map-${field.name}" data-field-name="${field.name}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
                        <option value="">-- Bỏ qua --</option>
                        ${excelHeaders.map(header => `<option value="${header}">${header}</option>`).join('')}
                    </select>
                </div>
            `).join('');
            importPreviewHead.innerHTML = `<tr>${excelHeaders.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
            importPreviewBody.innerHTML = excelData.slice(0, 5).map(row => 
                `<tr>${excelHeaders.map(h => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row[h] || ''}</td>`).join('')}</tr>`
            ).join('');
            importModal.classList.remove('hidden');
            importModal.classList.add('flex');
        }

        function closeImportModal() {
            importModal.classList.add('hidden');
            importModal.classList.remove('flex');
            excelData = [];
            columnMappingDiv.innerHTML = '';
            importPreviewHead.innerHTML = '';
            importPreviewBody.innerHTML = '';
        }

        async function handleStartImport() {
            startImportButton.disabled = true;
            startImportButton.textContent = 'Đang xử lý...';
            const config = sections[currentSection];
            const mapping = {};
            document.querySelectorAll('#column-mapping select').forEach(select => {
                if (select.value) { mapping[select.dataset.fieldName] = select.value; }
            });
            if (Object.keys(mapping).length === 0) {
                showToast('Vui lòng ánh xạ ít nhất một cột.', 'error');
                startImportButton.disabled = false;
                startImportButton.textContent = 'Bắt đầu Import';
                return;
            }
            const recordsToInsert = excelData.map(row => {
                const newRecord = {};
                for (const fieldName in mapping) {
                    const excelColumn = mapping[fieldName];
                    newRecord[fieldName] = row[excelColumn] || null;
                }
                return newRecord;
            }).filter(record => Object.values(record).some(val => val !== null));
            if (recordsToInsert.length === 0) {
                showToast('Không có dữ liệu hợp lệ để import.', 'error');
            } else {
                try {
                    const { error } = await supabase.from(config.table).insert(recordsToInsert);
                    if (error) throw error;
                    showToast(`Đã import thành công ${recordsToInsert.length} mục!`);
                    closeImportModal();
                    loadData();
                } catch (err) {
                    showToast(`Lỗi khi import: ${err.message}`, 'error');
                }
            }
            startImportButton.disabled = false;
            startImportButton.textContent = 'Bắt đầu Import';
        }

        // --- COLUMN CUSTOMIZATION FUNCTIONS ---
        function loadColumnPreferences() {
            const prefs = localStorage.getItem('adminColumnPreferences');
            columnPreferences = prefs ? JSON.parse(prefs) : {};
        }

        function saveColumnPreferences() {
            localStorage.setItem('adminColumnPreferences', JSON.stringify(columnPreferences));
        }

        function getVisibleColumns(sectionId) {
            const config = sections[sectionId];
            if (!config || !config.fields) return [];
            const savedPrefs = columnPreferences[sectionId];
            if (savedPrefs && Array.isArray(savedPrefs)) { return savedPrefs; }
            return config.defaultColumns || [];
        }

        function populateColumnSelector() {
            const config = sections[currentSection];
            if (!config || !config.fields) { columnCheckboxes.innerHTML = ''; return; }
            const visibleColumns = getVisibleColumns(currentSection);
            columnCheckboxes.innerHTML = config.fields
                .filter(field => !field.group)
                .filter(field => field.type !== 'file' || field.name.includes('_url'))
                .map(field => `
                <div>
                    <label class="inline-flex items-center w-full cursor-pointer">
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-primary-600 rounded border-gray-300 focus:ring-primary-500" data-column-name="${field.name}" ${visibleColumns.includes(field.name) ? 'checked' : ''}>
                        <span class="ml-2 text-sm text-gray-700">${field.label}</span>
                    </label>
                </div>
            `).join('');
            document.querySelectorAll('#column-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', handleColumnSelectionChange);
            });
        }

        function handleColumnSelectionChange() {
            const selectedColumns = Array.from(document.querySelectorAll('#column-checkboxes input:checked'))
                                       .map(cb => cb.dataset.columnName);
            columnPreferences[currentSection] = selectedColumns;
            saveColumnPreferences();
            loadData();
        }


        // --- MODAL & NAVIGATION LOGIC ---
        function switchSection(sectionId) {
            currentSection = sectionId;
            currentPage = 1; 
            const config = sections[sectionId];
            pageTitle.textContent = config.title;
            addNewButton.style.display = (['dashboard', 'settings', 'profiles'].includes(sectionId)) ? 'none' : 'flex';
            if (['documents', 'posts'].includes(sectionId)) {
                importExcelButton.classList.remove('hidden');
            } else {
                importExcelButton.classList.add('hidden');
            }
            if (config && config.table && !['dashboard', 'settings'].includes(sectionId)) {
                columnToggleButton.classList.remove('hidden');
                populateColumnSelector();
            } else {
                columnToggleButton.classList.add('hidden');
                columnSelector.classList.add('hidden');
            }
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`nav-${sectionId}`).classList.add('active');
            loadData();
        }

        function toggleSuitField() {
            const subTypeSelect = document.getElementById('sub_type');
            const suitInput = document.getElementById('suit');
            if (subTypeSelect && suitInput) {
                const suitWrapper = suitInput.parentElement;
                if (subTypeSelect.value === 'major_arcana') {
                    suitWrapper.style.display = 'none';
                    suitInput.value = '';
                } else {
                    suitWrapper.style.display = 'block';
                }
            }
        }

        function initializeEditors() {
            const config = sections[currentSection];
            const editorFields = config.fields.filter(f => f.type === 'richtext');

            editorFields.forEach(field => {
                const element = document.querySelector('#' + field.name);
                if (element && !element.hasAttribute('data-ck-editor-initialized')) {
                    element.setAttribute('data-ck-editor-initialized', 'true');
                    ClassicEditor
                        .create(element, {
                            toolbar: [ 'heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'undo', 'redo' ]
                        })
                        .then(editor => {
                            editorInstances[field.name] = editor;
                        })
                        .catch(error => {
                            console.error(`Lỗi khởi tạo CKEditor cho #${field.name}:`, error);
                        });
                }
            });
        }

        async function destroyEditors() {
            for (const fieldName in editorInstances) {
                const editor = editorInstances[fieldName];
                if (editor) {
                    await editor.destroy();
                    const element = document.querySelector('#' + fieldName);
                    if(element) element.removeAttribute('data-ck-editor-initialized');
                }
            }
            editorInstances = {};
        }

        async function openModal(isEdit = false, item = null) {
            await destroyEditors();
            const config = sections[currentSection];
            dataForm.innerHTML = createFormFields(config.fields);
            
            if (isEdit) {
                modalTitle.textContent = `Chỉnh sửa: ${config.title.replace('Quản lý ', '')}`;
                currentItemId = item.id;
                populateForm(item);
            } else {
                modalTitle.textContent = `Thêm mới: ${config.title.replace('Quản lý ', '')}`;
                currentItemId = null;
                dataForm.reset();
                 config.fields.filter(f => f.type === 'file').forEach(field => {
                    if (field.group) return;
                     document.getElementById(`${field.name}-preview`).src = "https://placehold.co/100x100/e2e8f0/a0aec0?text=Preview";
                 });
                 // Set default values for new items
                 config.fields.forEach(field => {
                    if (field.defaultValue !== undefined) {
                        const input = document.getElementById(field.name);
                        if (input) input.value = field.defaultValue;
                    }
                 });
                 if (currentSection === 'tarot_cards') {
                    toggleSuitField();
                 }
            }
            
            setTimeout(initializeEditors, 50);
            
            if (currentSection === 'tarot_cards') {
                const subTypeSelect = document.getElementById('sub_type');
                if (subTypeSelect) {
                    subTypeSelect.addEventListener('change', toggleSuitField);
                }
            }

            formModal.classList.remove('hidden');
            formModal.classList.add('flex');
        }

        async function closeModal() {
            await destroyEditors();
            formModal.classList.add('hidden');
            formModal.classList.remove('flex');
            dataForm.innerHTML = '';
            currentItemId = null;
        }
        
        function openDeleteModal(id) {
            const config = sections[currentSection];
            deleteHandler = () => supabase.from(config.table).delete().eq('id', id);
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        }

        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
            deleteHandler = null;
        }

        // --- NOTIFICATION FUNCTIONS ---
        function toggleNotificationPanel() {
            const isOpen = notificationPanel.classList.toggle('open');
            notificationOverlay.classList.toggle('hidden', !isOpen);
            if (isOpen) {
                hasNewNotification = false;
                notificationBadge.classList.remove('active');
            }
        }

        function addNotificationEntry(text, email, time, iconClass, iconBg, iconColor) {
            const placeholder = notificationList.querySelector('.text-center');
            if (placeholder) { placeholder.remove(); }

            const notificationHTML = `
                <div class="p-3 rounded-lg hover:bg-gray-100 transition-colors duration-200 border-b">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 ${iconBg} ${iconColor} rounded-full p-2">
                            <i class="fa-solid ${iconClass} w-5 h-5"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-800">${text}</p>
                            ${email ? `<p class="text-xs text-gray-500">${email}</p>` : ''}
                            <p class="text-xs text-gray-400 mt-1">${time}</p>
                        </div>
                    </div>
                </div>
            `;
            notificationList.insertAdjacentHTML('afterbegin', notificationHTML);

            if (!notificationPanel.classList.contains('open')) {
                hasNewNotification = true;
                notificationBadge.classList.add('active');
            }
        }

        function initializeRealtimeNotifications() {
            const profilesChannel = supabase.channel('public:profiles');
            profilesChannel
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'profiles' }, (payload) => {
                    const profile = payload.new;
                    const text = `<span class="font-semibold">${profile.full_name || 'Người dùng mới'}</span> vừa đăng ký.`;
                    const time = new Date(profile.created_at).toLocaleTimeString('vi-VN');
                    addNotificationEntry(text, profile.email, time, 'fa-user-plus', 'bg-green-100', 'text-green-600');
                    addActivity({ type: 'user_registered', timestamp: profile.created_at, data: profile });
                })
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') { console.log('Successfully subscribed to realtime profiles notifications!'); }
                    if (status === 'CHANNEL_ERROR') {
                        console.error('Profiles subscription error:', err);
                        showToast('Lỗi kết nối thông báo người dùng.', 'error');
                    }
                });

            const postsChannel = supabase.channel('public:posts');
            postsChannel
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, (payload) => {
                    addActivity({ type: 'new_post', timestamp: payload.new.created_at, data: payload.new });
                })
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') { console.log('Successfully subscribed to realtime posts notifications!'); }
                    if (status === 'CHANNEL_ERROR') {
                        console.error('Posts subscription error:', err);
                        showToast('Lỗi kết nối thông báo bài viết.', 'error');
                    }
                });
        }
        
        function renderOnlineUsersList() {
            const allOnlineUsers = [...Object.values(onlinePresence), ...Object.values(onlineGuests)];
            onlineUsersCount.textContent = allOnlineUsers.length;

            if (allOnlineUsers.length === 0) {
                onlineUsersList.innerHTML = `<div class="p-4 text-center text-gray-500"><p>Chưa có ai online.</p></div>`;
                return;
            }

            onlineUsersList.innerHTML = allOnlineUsers.map(presence => {
                const user = presence[0];
                const isGuest = user.role === 'guest';
                const avatar = isGuest 
                    ? `https://placehold.co/40x40/93c5fd/ffffff?text=G`
                    : (user.avatar_url || 'https://placehold.co/40x40/e2e8f0/a0aec0?text=U');
                const name = isGuest ? user.full_name : (user.full_name || 'Người dùng');
                const id_display = isGuest ? `ID: ${user.user_id.substring(0, 8)}...` : (user.email || `Role: ${user.role || 'user'}`);
                const statusClass = isGuest ? 'status-dot guest' : 'status-dot online';

                return `
                    <div class="p-3 flex items-center space-x-3 hover:bg-gray-50 transition-colors user-list-item">
                        <div class="relative flex-shrink-0">
                            <img class="w-10 h-10 rounded-full object-cover" src="${avatar}" alt="${name}">
                            <span class="${statusClass}"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-800 truncate">${name}</p>
                            <p class="text-xs text-gray-500 truncate">${id_display}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function initializeRealtimeUsers() {
            const userChannel = supabase.channel('online-users');

            userChannel.on('presence', { event: 'sync' }, () => {
                const state = userChannel.presenceState();
                onlinePresence = {}; 
                const profileFetches = [];

                for (const id in state) {
                    const presence = state[id][0];
                    if (presence?.role !== 'admin' && presence?.role !== 'guest') {
                         profileFetches.push(
                            supabase.from('profiles').select('full_name, email').eq('id', presence.user_id).single()
                                .then(({ data: profileData }) => {
                                    if (profileData) {
                                        state[id][0].full_name = profileData.full_name || profileData.email;
                                        state[id][0].email = profileData.email;
                                    }
                                    onlinePresence[id] = state[id];
                                })
                        );
                    }
                }
                 Promise.all(profileFetches).then(() => {
                    renderOnlineUsersList();
                });
            });

            userChannel.on('presence', { event: 'join' }, async ({ key, newPresences }) => {
                let joinedUser = newPresences[0];
                if (!joinedUser || !joinedUser.user_id || joinedUser.role === 'admin' || joinedUser.role === 'guest') return; 
                
                try {
                    const { data: profileData, error } = await supabase.from('profiles').select('full_name, email').eq('id', joinedUser.user_id).single();
                    if (error) throw error;
                    if (profileData) {
                         joinedUser.full_name = profileData.full_name || profileData.email;
                         joinedUser.email = profileData.email;
                    }
                } catch (err) {
                    console.error(`Error fetching profile for ${joinedUser.user_id}:`, err);
                } finally {
                    if (pendingLeaveTimeouts.has(key)) {
                        clearTimeout(pendingLeaveTimeouts.get(key));
                        pendingLeaveTimeouts.delete(key);
                    } else {
                        if (pendingJoinActivityTimeouts.has(key)) {
                            clearTimeout(pendingJoinActivityTimeouts.get(key));
                        }
                        const timeoutId = setTimeout(() => {
                            addActivity({ type: 'user_online', timestamp: new Date().toISOString(), data: joinedUser });
                            
                            const displayName = joinedUser.full_name || 'Một người dùng';
                            const text = `<span class="font-semibold">${displayName}</span> vừa truy cập.`;
                            const time = new Date().toLocaleTimeString('vi-VN');
                            addNotificationEntry(text, joinedUser.email || `ID: ${joinedUser.user_id.substring(0,8)}...`, time, 'fa-wifi', 'bg-teal-100', 'text-teal-600');

                            pendingJoinActivityTimeouts.delete(key); 
                        }, JOIN_ACTIVITY_DELAY);
                        pendingJoinActivityTimeouts.set(key, timeoutId);
                    }
                    onlinePresence[key] = [joinedUser];
                    renderOnlineUsersList();
                }
            });

            userChannel.on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                const leftUser = (onlinePresence[key] && onlinePresence[key][0]) ? onlinePresence[key][0] : leftPresences[0];
                 if (!leftUser || !leftUser.user_id || leftUser.role === 'admin' || leftUser.role === 'guest') return;
                
                if (pendingJoinActivityTimeouts.has(key)) {
                    clearTimeout(pendingJoinActivityTimeouts.get(key));
                    pendingJoinActivityTimeouts.delete(key);
                }

                const timeoutId = setTimeout(() => {
                    const currentState = userChannel.presenceState();
                    if (!currentState[key]) {
                        delete onlinePresence[key];
                        renderOnlineUsersList();
                        
                        const displayName = leftUser.full_name || 'Một người dùng';
                        const text = `<span class="font-semibold">${displayName}</span> đã rời đi.`;
                        const time = new Date().toLocaleTimeString('vi-VN');
                        addNotificationEntry(text, leftUser.email || `ID: ${leftUser.user_id.substring(0,8)}...`, time, 'fa-person-walking-dashed-line-arrow-right', 'bg-gray-100', 'text-gray-600');
                    }
                    pendingLeaveTimeouts.delete(key);
                }, LEAVE_DELAY);

                pendingLeaveTimeouts.set(key, timeoutId);
            });

            userChannel.subscribe(async (status, err) => {
                if (status === 'SUBSCRIBED') {
                    console.log('Successfully subscribed to presence channel!');
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        await userChannel.track({
                            user_id: user.id,
                            full_name: 'Admin',
                            avatar_url: null,
                            role: 'admin'
                        });
                    }
                }
                if (status === 'CHANNEL_ERROR') {
                    console.error('Presence subscription error:', err || 'Lỗi không xác định. Hãy kiểm tra kết nối và cấu hình kênh.');
                    showToast('Lỗi kết nối danh sách người dùng online.', 'error');
                }
            });
        }
        
        function initializeVisitorListener() {
            const guestAliases = [
                'Nhà Thám Hiểm Vô Danh', 'Lữ Khách Bí Ẩn', 'Người Quan Sát Thầm Lặng',
                'Kẻ Mộng Mơ Qua Đường', 'Vị Khách Tò Mò', 'Bóng Ma Thân Thiện',
                'Người Tìm Kiếm Tri Thức', 'Kẻ Du Hành Thời Gian', 'Nhà Chiêm Tinh Học'
            ];

            const channel = supabase.channel('anonymous_visitors');

            channel.on('broadcast', { event: 'new_visitor' }, ({ payload }) => {
                const { visitorId, page } = payload;
                
                let pageName = 'Trang không xác định';
                if (page) {
                    if (page === '/' || page.includes('index.html')) pageName = 'Trang chủ';
                    else {
                        pageName = page.split('/').pop().replace('.html', '');
                        pageName = pageName.charAt(0).toUpperCase() + pageName.slice(1);
                    }
                }
                
                const randomAlias = guestAliases[Math.floor(Math.random() * guestAliases.length)];
                
                const toastMsg = `🕵️‍♂️ <strong>${randomAlias}</strong> vừa ghé thăm trang <strong>${pageName}</strong>.`;
                showToast(toastMsg, 'info');

                const notificationText = `<strong>${randomAlias}</strong> vừa truy cập trang <strong>${pageName}</strong>.`;
                const time = new Date().toLocaleTimeString('vi-VN');
                addNotificationEntry(notificationText, `ID: ${visitorId.substring(0,8)}...`, time, 'fa-user-secret', 'bg-blue-100', 'text-blue-600');
                
                addActivity({ type: 'new_visitor', timestamp: new Date().toISOString(), data: { alias: randomAlias, pageName } });

                const guestUser = [{
                    user_id: visitorId,
                    full_name: randomAlias,
                    role: 'guest'
                }];

                if (guestTimeouts.has(visitorId)) {
                    clearTimeout(guestTimeouts.get(visitorId));
                }

                onlineGuests[visitorId] = guestUser;
                renderOnlineUsersList();

                const timeoutId = setTimeout(() => {
                    delete onlineGuests[visitorId];
                    renderOnlineUsersList();
                    guestTimeouts.delete(visitorId);
                }, GUEST_TIMEOUT_MS);
                guestTimeouts.set(visitorId, timeoutId);
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log('Admin is now listening for new anonymous visitors.');
                } else {
                    console.error('Failed to subscribe to anonymous visitors channel.');
                    showToast('Lỗi kết nối kênh theo dõi khách.', 'error');
                }
            });
        }

        // --- AUTHENTICATION LOGIC ---
        async function handleLogin(e) {
            e.preventDefault();
            loginButton.disabled = true;
            loginButton.textContent = "Đang xử lý...";
            loginError.classList.add('hidden');
            const email = e.target.email.value;
            const password = e.target.password.value;
            const { data: loginData, error: loginErrorMsg } = await supabase.auth.signInWithPassword({ email, password });
            if (loginErrorMsg) {
                loginError.textContent = "Email hoặc mật khẩu không chính xác.";
                loginError.classList.remove('hidden');
                loginButton.disabled = false;
                loginButton.textContent = "Đăng nhập";
                return;
            }
            if (loginData.user) {
                const { data: profile, error: profileError } = await supabase
                    .from('profiles').select('role').eq('id', loginData.user.id).single();
                if (profileError || !profile || profile.role !== 'admin') {
                    loginError.textContent = "Tài khoản của bạn không có quyền truy cập.";
                    loginError.classList.remove('hidden');
                    await supabase.auth.signOut();
                } else {
                    loginForm.reset();
                }
            }
            loginButton.disabled = false;
            loginButton.textContent = "Đăng nhập";
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            localStorage.clear();
            window.location.reload();
        }

        supabase.auth.onAuthStateChange((event, session) => {
            if (session?.user) {
                loginScreen.style.display = 'none';
                adminPanel.style.display = 'flex';
                if (isInitialLoad) {
                    adminUserId = session.user.id; 
                    loadColumnPreferences();
                    switchSection('dashboard');
                    initializeRealtimeNotifications();
                    initializeRealtimeUsers();
                    initializeVisitorListener();
                    isInitialLoad = false;
                }
            } else {
                loginScreen.style.display = 'flex';
                adminPanel.style.display = 'none';
                isInitialLoad = true;
                adminUserId = null;
            }
        });


        // --- EVENT LISTENERS ---
        document.querySelectorAll('.sidebar-item').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = e.currentTarget.id.replace('nav-', '');
                switchSection(sectionId);
                if (window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                }
            });
        });
        menuButton.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
        });
        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        addNewButton.addEventListener('click', () => openModal(false));
        closeModalButton.addEventListener('click', closeModal);
        cancelButton.addEventListener('click', closeModal);
        
        formModal.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                const activeElement = document.activeElement;
                if (activeElement.tagName.toLowerCase() === 'textarea' || activeElement.closest('.ck-editor')) {
                    return;
                }
                e.preventDefault();
                handleFormSubmit();
            }
        });

        saveButton.addEventListener('click', handleFormSubmit);
        cancelDeleteButton.addEventListener('click', closeDeleteModal);
        confirmDeleteButton.addEventListener('click', performDelete);
        importExcelButton.addEventListener('click', () => excelFileInput.click());
        excelFileInput.addEventListener('change', handleImportFileSelect);
        closeImportModalButton.addEventListener('click', closeImportModal);
        cancelImportButton.addEventListener('click', closeImportModal);
        startImportButton.addEventListener('click', handleStartImport);
        columnToggleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            columnSelector.classList.toggle('hidden');
        });
        window.addEventListener('click', (e) => {
            if (!columnSelector.contains(e.target) && !columnToggleButton.contains(e.target)) {
                columnSelector.classList.add('hidden');
            }
        });
        notificationButton.addEventListener('click', toggleNotificationPanel);
        closeNotificationButton.addEventListener('click', toggleNotificationPanel);
        notificationOverlay.addEventListener('click', toggleNotificationPanel);

        usersPanelHeader.addEventListener('click', () => {
            realtimeUsersPanel.classList.toggle('open');
        });

        // --- GLOBAL FUNCTIONS ---
        window.handleEditClick = (item) => openModal(true, item);
        window.handleDeleteClick = (id) => openDeleteModal(id);
        window.handleChangePage = (page) => {
            currentPage = page;
            loadData();
        };
        window.previewFile = (fieldName) => {
            const preview = document.getElementById(`${fieldName}-preview`);
            const file = document.getElementById(fieldName).files[0];
            const reader = new FileReader();
            reader.onloadend = () => { preview.src = reader.result; }
            if (file) { reader.readAsDataURL(file); }
        }
        window.switchSection = switchSection;
    </script>
</body> 
</html>
