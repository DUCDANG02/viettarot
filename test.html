<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VietTarot - Làm Bài Tập</title>

    <link rel="icon" type="image/png" href="https://lkznteubcwladqkxyaqo.supabase.co/storage/v1/object/public/website-assets//logotab.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-blue: #4A6CF3;
            --primary-purple: #9B49F2;
            --text-primary: #1A1229;
            --text-secondary: #5A6474;
            --bg-white: #FFFFFF;
            --bg-off-white: #F8F7FA;
            --border-color: #E5E7EB;
            --danger-color: #dc3545;
            --warning-color: #FFC107;
            --success-color: #198754;
            --gradient-primary: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-purple) 100%);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-off-white);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        main {
            flex-grow: 1;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 1030;
            background-color: var(--bg-white);
            box-shadow: 0 10px 40px -15px rgba(74, 108, 243, 0.25);
            transition: all 0.3s ease-in-out;
        }

        .navbar {
            background-color: transparent !important;
            box-shadow: none !important;
            padding: 15px 0px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.75rem;
        }
        
        #header-logo {
            max-height: 40px;
            width: auto;
        }

        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .navbar-nav .nav-link {
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.4rem 1.7rem;
            margin: 0 0.6rem;
            border-radius: 20px;
            display: flex;
            align-items: center;
            position: relative;
            z-index: 1;
            overflow: hidden;
            transition: color 0.4s ease-in-out;
            background-color: transparent;
            white-space: nowrap; /* Thêm thuộc tính này để ngăn chữ xuống dòng */
        }

        .navbar-nav .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: var(--gradient-primary);
            z-index: -1;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease-in-out;
        }

        .navbar-nav .nav-link:hover {
            color: var(--bg-white);
        }

        .navbar-nav .nav-link:hover::before {
            transform: scaleX(1);
        }
        
        .navbar-nav .nav-link.active {
            color: var(--bg-white);
            font-weight: 600;
        }

        .navbar-nav .nav-link.active::before {
            transform: scaleX(1);
        }
        
        .navbar-nav .nav-link.active:hover {
            color: var(--bg-white);
        }

        @media (max-width: 991.98px) {
            .navbar-nav {
                padding-top: 1rem;
            }
            .navbar-nav .nav-item {
                margin-bottom: 0.5rem;
            }
            .navbar-nav .nav-link {
                margin: 0;
                padding: 0.75rem 1rem;
                justify-content: center;
            }
        }

        .dropdown-menu {
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 0.5rem 0;
            margin-top: 0.5rem !important;
        }

        .dropdown-item {
            padding: 0.5rem 1.2rem;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }
        
        .dropdown-item:hover,
        .dropdown-item:focus {
            background-color: var(--bg-off-white);
            color: var(--text-primary);
        }

        .dropdown-item .fa-fw {
            width: 20px;
            text-align: center;
            margin-right: 8px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            background-color: var(--border-color);
            border: 2px solid var(--primary-purple);
            box-shadow: 0 2px 8px rgba(155, 73, 242, 0.4);
        }

        .btn-gradient {
            background: var(--gradient-primary);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(120, 73, 242, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            background-size: 200% auto;
        }

        .btn-gradient:hover {
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(120, 73, 242, 0.5);
            background-position: right center;
        }
        
        .site-footer {
            background: var(--gradient-primary);
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            padding-top: 4rem;
            background-size: 200% 200%;
            animation: gradient-animation 10s ease infinite;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .footer-widget h5 {
            color: var(--bg-white);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        
        #footer-logo {
            max-height: 50px;
            width: auto;
        }

        .footer-links li {
            margin-bottom: 0.75rem;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--bg-white);
            padding-left: 5px;
        }

        .social-icons a {
            display: inline-flex;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--bg-white);
            justify-content: center;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }

        .social-icons a:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .footer-bottom {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 1.5rem 0;
            margin-top: 3rem;
        }

        /* === CSS CHO MODAL (TỪ INDEX.HTML) === */
        .modal.fade .modal-dialog { transform: translate(0, -25px); transition: transform 0.4s ease-out; }
        .modal.show .modal-dialog { transform: translate(0, 0); }
        .modal-content { border-radius: 1rem; border: none; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .modal-header { border-bottom: 1px solid var(--border-color); padding: 1.5rem; position: relative; }
        .modal-body { padding: 1.5rem; }
        .modal-title { font-weight: 700; color: var(--text-primary); }
        .modal-subtitle { font-size: 0.95rem; color: var(--text-secondary); }
        .btn-close { position: absolute; top: 1.5rem; right: 1.5rem; }
        .form-group-icon { position: relative; }
        .form-group-icon .form-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }
        .form-control { background-color: var(--bg-off-white); border: 1px solid var(--border-color); padding: 0.8rem 1rem; border-radius: 0.5rem; transition: all 0.3s ease; }
        .form-control-icon { padding-left: 2.8rem !important; }
        .form-control:focus { background-color: var(--bg-white); border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(74, 108, 243, 0.2); }
        .form-text a { color: var(--primary-blue); text-decoration: none; }
        .social-login-divider { display: flex; align-items: center; text-align: center; color: var(--text-secondary); font-size: 0.9rem; }
        .social-login-divider::before, .social-login-divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-color); }
        .social-login-divider:not(:empty)::before { margin-right: .5em; }
        .social-login-divider:not(:empty)::after { margin-left: .5em; }
        .btn-social { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; transition: all 0.3s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 0.3rem; text-decoration: none; }
        .btn-social:hover { background-color: var(--bg-off-white); border-color: #d1d5db; }
        .btn-social img { width: 22px; height: 22px; }
        .btn-social-text { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; }
        .password-toggle-icon { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-secondary); }
        .auth-alert { font-size: 0.9rem; padding: 0.75rem 1rem; }
        #password-match-feedback { font-size: 0.875em; margin-top: 0.25rem; width: 100%; }
        .password-match { color: var(--success-color); }
        .password-mismatch { color: var(--danger-color); }
        .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 18, 41, 0.7); z-index: 1060; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .fullscreen-overlay.show { opacity: 1; visibility: visible; }
        .success-notification { background-color: var(--bg-white); padding: 2.5rem 3rem; border-radius: 1rem; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .fullscreen-overlay.show .success-notification { transform: scale(1); }
        .success-icon { font-size: 4rem; color: var(--success-color); margin-bottom: 1rem; line-height: 1; }
        .success-title { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; }
        .success-message { font-size: 1rem; color: var(--text-secondary); margin-bottom: 0; }
        
        /* === CSS CHO NOTIFICATION BADGE === */
        .notification-badge { position: absolute; min-width: 22px; height: 22px; background-color: var(--danger-color); color: white; border-radius: 50%; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-white); transform: scale(1); animation: pulse-badge 1.5s infinite; z-index: 10; }
        #userDropdown .notification-badge { top: -2px; right: 0; }
        .navbar-toggler .notification-badge { position: absolute; top: 4px; right: 4px; width: 10px; height: 10px; min-width: auto; padding: 0; font-size: 0; border-width: 2px; }
        .dropdown-item .notification-badge { position: static; margin-left: auto; transform: scale(0.9); animation: none; border: none; padding: 0 6px; }
        @keyframes pulse-badge { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        /* === CSS Dành Riêng Cho Trang Quiz === */
        .quiz-wrapper { background-color: var(--bg-white); border-radius: 1rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08); padding: 2rem; border: 1px solid var(--border-color); }
        @media (min-width: 768px) { .quiz-wrapper { padding: 3rem; } }
        .quiz-header h1, .quiz-header h2 { font-weight: 700; color: var(--text-primary); }
        .quiz-header p { color: var(--text-secondary); font-size: 1.1rem; }
        .topic-card { border: 2px solid var(--border-color); border-radius: 1rem; padding: 2rem 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease; height: 100%; }
        .topic-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); border-color: var(--primary-blue); }
        .topic-card i { font-size: 3rem; margin-bottom: 1rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .topic-card h3 { font-weight: 600; color: var(--text-primary); }
        .quiz-card { border: 2px solid var(--border-color); border-radius: 1rem; transition: all 0.3s ease; height: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column; text-align: left; padding: 1.5rem; }
        @media (min-width: 768px) { .quiz-card { flex-direction: row; align-items: center; } }
        .quiz-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); border-color: var(--primary-blue); }
        .quiz-card-content { flex-grow: 1; }
        .quiz-card h3 { font-weight: 600; color: var(--text-primary); }
        .quiz-action-container { margin-top: 1rem; flex-shrink: 0; }
        @media (min-width: 768px) { .quiz-action-container { margin-top: 0; margin-left: 1.5rem; } }
        .quiz-badge { position: absolute; top: 1rem; right: 1rem; padding: 0.25rem 0.6rem; font-size: 0.75rem; font-weight: 700; border-radius: 50px; color: white; text-transform: uppercase; }
        .badge-free { background-color: var(--success-color); }
        .badge-membership { background-color: var(--primary-purple); }
        .badge-student { background: var(--warning-color); color: var(--text-primary); }
        .quiz-card.highlight { border-color: var(--warning-color); box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3); }
        .quiz-sidebar { background-color: var(--bg-off-white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--border-color); }
        @media (max-width: 991.98px) { .quiz-sidebar { margin-bottom: 2rem; } }
        #main-timer-card { text-align: center; background: var(--gradient-primary); color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        #main-timer-card .timer-text { font-size: 1rem; font-weight: 500; opacity: 0.9; }
        #main-timer { font-size: 2.25rem; font-weight: 700; letter-spacing: 2px; }
        .question-tracker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 0.75rem; }
        .tracker-item { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; border: 2px solid var(--border-color); border-radius: 50%; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .tracker-item:hover { background-color: var(--border-color); }
        .tracker-item.current { background-color: var(--primary-purple); border-color: var(--primary-purple); color: white; transform: scale(1.1); }
        .tracker-item.answered { background-color: var(--primary-blue); border-color: var(--primary-blue); color: white; }
        .progress { height: 10px; border-radius: 50px; }
        .progress-bar { background: var(--gradient-primary); border-radius: 50px; }
        .question-text { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; line-height: 1.5; }
        .answer-option { display: flex; align-items: center; width: 100%; text-align: left; padding: 0.7rem 1rem; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500; border: 2px solid var(--border-color); border-radius: 0.75rem; background-color: var(--bg-white); color: var(--text-primary); transition: all 0.3s ease; cursor: pointer; }
        .answer-option .answer-label { display: flex; justify-content: center; align-items: center; width: 26px; height: 26px; border: 2px solid var(--border-color); border-radius: 0.5rem; margin-right: 0.8rem; font-weight: 700; transition: all 0.3s ease; flex-shrink: 0; }
        .answer-option:hover { border-color: var(--primary-blue); }
        .answer-option:hover .answer-label { border-color: var(--primary-blue); color: var(--primary-blue); }
        .answer-option.selected { border-color: var(--primary-purple); background-color: #f5f0ff; }
        .answer-option.selected .answer-label { background-color: var(--primary-purple); border-color: var(--primary-purple); color: white; }
        .quiz-navigation .btn { padding: 0.75rem 2rem; font-size: 1rem; }
        .result-icon { font-size: 5rem; margin-bottom: 1.5rem; }
        .result-icon .fa-trophy { color: var(--warning-color); }
        .result-icon .fa-face-sad-tear { color: var(--text-secondary); }
        .result-score { font-size: 1.5rem; font-weight: 500; }
        .result-score span { font-weight: 700; font-size: 2rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .question-content-container { display: flex; flex-direction: column; min-height: 480px; }
        @media (max-width: 991.98px) { .question-content-container { min-height: 450px; } }
        .scrollable-question-area { flex: 1 1 auto; }
        .quiz-navigation { margin-top: auto; padding-top: 1rem; flex-shrink: 0; }
        .review-question-block { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .review-question-block:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .review-answer-option { opacity: 0.7; pointer-events: none; }
        .review-answer-option.correct-answer { border-color: var(--success-color); background-color: #e8f5e9; opacity: 1; }
        .review-answer-option.user-answer { opacity: 1; box-shadow: 0 0 0 3px var(--primary-blue); }
        .review-answer-option.user-answer.incorrect-answer { box-shadow: 0 0 0 3px var(--danger-color); border-color: var(--danger-color); background-color: #ffebee; }
        .review-answer-option.user-answer.correct-answer { box-shadow: 0 0 0 3px var(--success-color); }
        .modal-lg { max-width: 800px; }
        .teacher-comment-box { background-color: #fcf8e3; border-left: 4px solid var(--warning-color); padding: 1rem; border-radius: 0.5rem; }

        /* === CSS CHO BẢNG XẾP HẠNG === */
        .leaderboard-widget-container { position: fixed; bottom: 25px; right: 25px; z-index: 1050; display: flex; flex-direction: column; align-items: flex-end; }
        .leaderboard-panel { background-color: var(--bg-white); width: 320px; border-radius: 0.75rem; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15); margin-bottom: 15px; transform-origin: right bottom; transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.3s ease; }
        .leaderboard-icon-wrapper { position: relative; flex-shrink: 0; }
        .leaderboard-text-bubble { position: absolute; right: 100%; top: 50%; transform: translateY(-50%) scale(0); margin-right: 15px; background-color: var(--bg-white); padding: 10px 18px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15); color: var(--text-primary); font-weight: 500; font-size: 0.9rem; white-space: nowrap; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); opacity: 0; pointer-events: none; transform-origin: right center; }
        .leaderboard-widget-container.collapsed .leaderboard-icon-wrapper:hover .leaderboard-text-bubble { transform: translateY(-50%) scale(1); opacity: 1; }
        .leaderboard-widget-container.collapsed .leaderboard-panel { transform: scale(0); opacity: 0; pointer-events: none; display: none; }
        .leaderboard-widget-container:not(.collapsed) .leaderboard-panel { transform: scale(1); opacity: 1; pointer-events: auto; }
        .leaderboard-header { background: var(--gradient-primary); color: white; padding: 0.75rem 1rem; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
        .leaderboard-header h6 { margin: 0; font-weight: 600; }
        .leaderboard-body { max-height: 350px; overflow-y: auto; }
        .leaderboard-list { list-style: none; padding: 0.5rem; margin: 0; }
        .leaderboard-item { display: flex; align-items: center; padding: 0.6rem 0.5rem; transition: background-color 0.2s; }
        .leaderboard-item:not(:last-child) { border-bottom: 1px solid var(--border-color); }
        .leaderboard-item:nth-child(1) .leaderboard-rank { color: #FFD700; }
        .leaderboard-item:nth-child(2) .leaderboard-rank { color: #C0C0C0; }
        .leaderboard-item:nth-child(3) .leaderboard-rank { color: #CD7F32; }
        .leaderboard-rank { font-weight: 700; font-size: 1.1rem; width: 30px; text-align: center; flex-shrink: 0; }
        .leaderboard-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; margin: 0 10px; }
        .leaderboard-name { font-weight: 500; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .leaderboard-score { font-weight: 700; color: var(--primary-purple); }
        .leaderboard-fab-icon { width: 60px; height: 60px; background: var(--gradient-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; text-decoration: none; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; cursor: pointer; }
        .leaderboard-fab-icon:hover { transform: scale(1.1); box-shadow: 0 8px 25px rgba(120, 73, 242, 0.5); }
        .leaderboard-close-btn { position: absolute; top: -5px; right: -5px; width: 26px; height: 26px; background-color: var(--text-primary); color: white; border: 2px solid white; border-radius: 50%; font-size: 16px; line-height: 22px; text-align: center; cursor: pointer; z-index: 12; transition: all 0.3s ease; transform: scale(0); opacity: 0; }
        .leaderboard-widget-container:not(.collapsed) .leaderboard-close-btn { transform: scale(1); opacity: 1; }
        .leaderboard-widget-container.collapsed .leaderboard-fab-icon { transform: scale(0.85); }
        .leaderboard-widget-container.collapsed .leaderboard-fab-icon:hover { transform: scale(1); }
        .leaderboard-close-btn:hover { transform: scale(1.15) rotate(180deg); background-color: var(--danger-color); }
        .leaderboard-close-btn:active { transform: scale(0.9) rotate(90deg); transition: transform 0.1s ease; }
        .leaderboard-footer { padding: 0.75rem; border-top: 1px solid var(--border-color); font-size: 0.9rem; }
        .leaderboard-item.current-user { background-color: #f5f0ff; border-radius: 0.5rem; box-shadow: 0 0 0 2px var(--primary-purple); }

        /* === CSS CHO NÚT TIỆN ÍCH MỚI (TỪ INDEX.HTML) === */
        .community-widget-container {
            position: fixed;
            /* Đặt vị trí phía trên bảng xếp hạng */
            bottom: 100px; 
            right: 25px;
            z-index: 1050;
            display: flex;
            align-items: flex-end;
            gap: 15px;
            transition: gap 0.3s ease;
        }

        .community-widget-container.collapsed .community-text-bubble,
        .community-widget-container.collapsed .community-close-btn {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        .community-widget-container.collapsed .community-text-bubble {
            width: 0;
            padding-left: 0;
            padding-right: 0;
            margin-left: 0;
            margin-right: 0;
        }

        .community-widget-container.collapsed {
            gap: 0;
        }

        .community-widget-container.collapsed .community-fab-icon {
            transform: scale(0.85);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .community-widget-container.collapsed .community-fab-icon:hover {
            transform: scale(1);
        }

        .community-icon-wrapper {
            position: relative;
            flex-shrink: 0;
        }

        .community-fab-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            text-decoration: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .community-fab-icon:hover {
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(120, 73, 242, 0.5);
        }

        .community-text-bubble {
            background-color: var(--bg-white);
            padding: 12px 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
            max-width: 220px;
            margin-bottom: 5px;
            animation: pop-in 0.5s 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
            transform: scale(0);
            transform-origin: right bottom;
            transition: transform 0.3s ease, opacity 0.3s ease, width 0.3s ease, padding 0.3s ease, margin 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
        }

        .community-close-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 26px;
            height: 26px;
            background-color: var(--text-primary);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            font-size: 16px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            z-index: 12;
            transition: all 0.3s ease;
            padding: 0;
        }

        .community-close-btn:hover {
            transform: scale(1.15) rotate(180deg);
            background-color: var(--danger-color);
        }

        @keyframes pop-in {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        @media (max-width: 767.98px) {
            .community-widget-container {
                right: 15px;
                bottom: 90px;
                gap: 10px;
            }
            .leaderboard-widget-container {
                right: 15px;
                bottom: 15px;
            }
            .community-fab-icon, .leaderboard-fab-icon {
                width: 55px;
                height: 55px;
                font-size: 24px;
            }
            .community-close-btn, .leaderboard-close-btn {
                width: 24px;
                height: 24px;
                font-size: 14px;
                line-height: 20px;
            }
        }
    </style>
</head>

<body>
    <!-- ======================= HEADER (ĐÃ CẬP NHẬT) ======================= -->
    <header>
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" href="index.html">
                    <img src="https://placehold.co/150x40/E5E7EB/1A1229?text=Loading..." alt="VietTarot Logo" id="header-logo">
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="mainNavbar">
                    <ul class="navbar-nav mx-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="fas fa-home me-2"></i>
                                Trang chủ
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle active" href="#" id="coursesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-graduation-cap me-2"></i>
                                Khoá học
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="coursesDropdown">
                                <li><a class="dropdown-item" href="#"><i class="fas fa-chalkboard-teacher fa-fw"></i>Bài giảng</a></li>
                                <li><a class="dropdown-item active" href="nhap.html"><i class="fas fa-file-alt fa-fw"></i>Làm bài tập</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="document.html">
                                <i class="fas fa-book me-2"></i>
                                Tài liệu
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="blog.html">
                                <i class="fas fa-scroll me-2"></i>
                                Bài Viết
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="cards.html">
                                <i class="fas fa-layer-group me-2"></i>
                                Ý nghĩa lá bài
                            </a>
                        </li>
                    </ul>

                    <div id="auth-container" class="d-flex justify-content-center mt-3 mt-lg-0">
                        <!-- NỘI DUNG AUTH SẼ ĐƯỢC TẢI BẰNG JAVASCRIPT -->
                    </div>

                </div>
            </div>
        </nav>
    </header>
    
    <main class="py-5">
        <div class="container">
            <div class="quiz-wrapper">
                <div id="topic-screen">
                    <div class="quiz-header text-center">
                        <h1 class="mb-3">Bài Kiểm Tra Kiến Thức</h1>
                        <p class="lead mb-5">Hãy chọn chủ đề bạn muốn kiểm tra kiến thức nhé!</p>
                    </div>
                    <div class="row g-4 justify-content-center" id="topic-container">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Đang tải chủ đề...</p>
                        </div>
                    </div>
                </div>

                <div id="quiz-list-screen" class="d-none">
                    <div class="quiz-header d-flex justify-content-between align-items-center mb-5 flex-wrap">
                        <div>
                            <h1 id="quiz-list-title" class="mb-1">Chọn bài kiểm tra</h1>
                            <p class="lead mb-0">Thử sức với các bài kiểm tra dưới đây.</p>
                        </div>
                        <button id="back-to-topics-btn" class="btn btn-outline-secondary mt-3 mt-md-0"><i class="fas fa-arrow-left me-2"></i>Quay lại</button>
                    </div>
                    <div class="row g-4" id="quiz-list-container">
                        </div>
                </div>

                <div id="quiz-screen" class="d-none">
                    <div class="row">
                        <div class="col-lg-4 order-lg-2">
                            <div class="quiz-sidebar">
                                <div id="main-timer-card">
                                    <div class="timer-text">Thời gian còn lại</div>
                                    <div id="main-timer">10:00</div>
                                </div>
                                <h5 class="mb-3">Câu hỏi</h5>
                                <div id="question-tracker" class="question-tracker-grid"></div>
                            </div>
                        </div>
                        <div class="col-lg-8 order-lg-1">
                            <div class="question-content-container">
                                <div>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h2 id="quiz-title" class="h4 mb-0">Bài kiểm tra Tarot</h2>
                                        <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill fs-6">Câu <span id="current-question-indicator">1</span>/<span id="total-questions-indicator">10</span></span>
                                    </div>
                                    <div class="progress mb-4">
                                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                                    </div>
                                </div>
                                <div class="scrollable-question-area">
                                    <p id="question-text" class="question-text"></p>
                                    <div id="answer-buttons"></div>
                                </div>
                                <div class="quiz-navigation d-flex justify-content-between">
                                    <button id="prev-btn" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i> Quay lại</button>
                                    <button id="next-btn" class="btn btn-gradient">Tiếp theo <i class="fas fa-arrow-right ms-2"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="result-screen" class="d-none text-center">
                     <div class="quiz-header">
                        <h1 class="mb-3">Hoàn thành!</h1>
                    </div>
                    <div id="result-icon" class="result-icon"></div>
                    <p id="result-message" class="lead fw-bold mb-3"></p>
                    <p id="result-score" class="result-score mb-4">Điểm trắc nghiệm: <span><span id="score"></span>/<span id="total-score"></span></span></p>
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <button id="restart-btn" class="btn btn-gradient"><i class="fas fa-redo me-2"></i>Làm lại bài khác</button>
                        <button id="review-answers-btn" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#reviewModal"><i class="fas fa-eye me-2"></i>Xem đáp án</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-6 mb-4 mb-lg-0"><div class="footer-widget"><a class="footer-logo" href="index.html"><img src="https://placehold.co/180x50/E5E7EB/1A1229?text=Loading..." alt="VietTarot Logo" id="footer-logo"></a><p class="mt-3">Nền tảng học Tarot và Huyền học trực tuyến hàng đầu Việt Nam.</p></div></div>
                <div class="col-lg-2 col-md-6 mb-4 mb-lg-0"><div class="footer-widget"><h5>Khám Phá</h5><ul class="list-unstyled footer-links"><li><a href="index.html">Trang chủ</a></li><li><a href="#">Khoá học</a></li><li><a href="document.html">Tài liệu</a></li></ul></div></div>
                <div class="col-lg-3 col-md-6 mb-4 mb-md-0"><div class="footer-widget"><h5>Tài Liệu</h5><ul class="list-unstyled footer-links"><li><a href="cards.html">Ý nghĩa 78 lá bài Tarot</a></li><li><a href="#">Các trải bài thông dụng</a></li></ul></div></div>
                <div class="col-lg-3 col-md-6"><div class="footer-widget"><h5>Kết Nối</h5><div class="social-icons mt-3"><a href="#" title="Facebook"><i class="fab fa-facebook-f"></i></a><a href="#" title="Instagram"><i class="fab fa-instagram"></i></a><a href="#" title="Youtube"><i class="fab fa-youtube"></i></a><a href="#" title="Tiktok"><i class="fab fa-tiktok"></i></a></div></div></div>
            </div>
        </div>
        <div class="footer-bottom"><div class="container text-center"><p class="mb-0">&copy; 2025 được phát triển bởi hệ thống VietTarot</p></div></div>
    </footer>


     <!-- ======================= WIDGET CỘNG ĐỒNG (MỚI) ======================= -->
    <div class="community-widget-container" id="community-widget-container">
        <div class="community-text-bubble">
            <p class="mb-0">Tham gia nhóm cộng đồng</p>
        </div>
        <div class="community-icon-wrapper">
            <button class="community-close-btn" id="community-close-btn" title="Ẩn">&times;</button>
            <a href="https://m.me/YOUR_PAGE_ID" class="community-fab-icon" target="_blank" title="Nhắn tin cho chúng tôi">
                <i class="fas fa-users"></i>
            </a>
        </div>
    </div>


    <!-- ======================= WIDGET BẢNG XẾP HẠNG ======================= -->
    <div class="leaderboard-widget-container collapsed" id="leaderboard-widget-container">
        <div class="leaderboard-panel">
             <div class="leaderboard-header">
                <h6><i class="fas fa-trophy me-2"></i>Bảng Xếp Hạng Reader</h6>
             </div>
             <div class="leaderboard-body">
                <ol class="leaderboard-list" id="leaderboard-list-container"></ol>
             </div>
             <div class="leaderboard-footer" id="user-rank-container"></div>
        </div>
        <div class="leaderboard-icon-wrapper">
            <div class="leaderboard-text-bubble">
                <p class="mb-0">Bảng Xếp Hạng</p>
            </div>
            <button class="leaderboard-close-btn" title="Đóng Bảng Xếp Hạng">&times;</button>
            <div class="leaderboard-fab-icon" title="Mở Bảng Xếp Hạng">
                <i class="fas fa-trophy"></i>
            </div>
        </div>
    </div>
    
   

    <!-- ======================= CÁC MODALS ======================= -->
    <!-- Modal Login/Register (Mới) -->
    <div id="fullscreen-success-overlay" class="fullscreen-overlay">
        <div class="success-notification">
            <div class="success-icon"><i class="fas fa-check-circle"></i></div>
            <h4 class="success-title">Thành Công!</h4>
            <p class="success-message">Bạn đã tạo tài khoản thành công.</p>
        </div>
    </div>
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="loginModalLabel">Đăng nhập</h5>
                        <p class="mb-0 modal-subtitle">Chào mừng bạn trở lại VietTarot!</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div id="login-alert"></div>
                        <div class="mb-3 form-group-icon">
                            <i class="fas fa-envelope form-icon"></i>
                            <input type="email" class="form-control form-control-icon" id="loginEmail" placeholder="Email" required>
                        </div>
                        <div class="mb-3 form-group-icon">
                            <i class="fas fa-lock form-icon"></i>
                            <input type="password" class="form-control form-control-icon" id="loginPassword" placeholder="Mật khẩu" required>
                            <i class="fas fa-eye password-toggle-icon" id="toggleLoginPassword"></i>
                        </div>
                        <div class="mb-4 text-end">
                            <div id="passwordHelp" class="form-text"><a href="#">Quên mật khẩu?</a></div>
                        </div>
                        <button type="submit" id="login-submit-btn" class="btn btn-gradient w-100 py-2">Đăng nhập</button>
                    </form>
                    <div class="social-login-divider my-4">Hoặc tiếp tục với</div>
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-social" title="Đăng nhập với Google"><img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google logo"><span class="btn-social-text">Google</span></button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-social" title="Đăng nhập với Facebook" id="facebook-login-btn"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/2021_Facebook_icon.svg" alt="Facebook logo"><span class="btn-social-text">Facebook</span></button>
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                        <p class="mb-0 text-secondary">Chưa có tài khoản? <a href="#" class="fw-bold text-decoration-none" data-bs-toggle="modal" data-bs-target="#registerModal" style="color: var(--primary-blue);">Đăng ký ngay</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="registerModalLabel">Tạo tài khoản</h5>
                        <p class="mb-0 modal-subtitle">Bắt đầu hành trình khám phá Tarot của bạn!</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm" novalidate>
                        <div id="register-alert"></div>
                        <div class="mb-3 form-group-icon"><i class="fas fa-user form-icon"></i><input type="text" class="form-control form-control-icon" id="registerName" placeholder="Họ và tên" required></div>
                        <div class="mb-3 form-group-icon"><i class="fas fa-envelope form-icon"></i><input type="email" class="form-control form-control-icon" id="registerEmail" placeholder="Email" required></div>
                        <div class="mb-3 form-group-icon"><i class="fas fa-phone form-icon"></i><input type="tel" class="form-control form-control-icon" id="registerPhone" placeholder="Số điện thoại" required></div>
                        <div class="mb-3 form-group-icon"><i class="fas fa-lock form-icon"></i><input type="password" class="form-control form-control-icon" id="registerPassword" placeholder="Mật khẩu" required><i class="fas fa-eye password-toggle-icon" id="toggleRegisterPassword"></i></div>
                        <div class="mb-4 form-group-icon"><i class="fas fa-check-circle form-icon"></i><input type="password" class="form-control form-control-icon" id="confirmPassword" placeholder="Xác nhận mật khẩu" required><i class="fas fa-eye password-toggle-icon" id="toggleConfirmPassword"></i><div id="password-match-feedback" class="mt-1"></div></div>
                        <button type="submit" id="register-submit-btn" class="btn btn-gradient w-100 py-2" disabled>Tạo tài khoản</button>
                    </form>
                    <div class="mt-4 text-center">
                        <p class="mb-0 text-secondary">Đã có tài khoản? <a href="#" class="fw-bold text-decoration-none" data-bs-toggle="modal" data-bs-target="#loginModal" style="color: var(--primary-blue);">Đăng nhập ngay</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Xem Lại Đáp Án -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="reviewModalLabel">Xem Lại Bài Làm</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
          <div class="modal-body" id="review-modal-body"></div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
        </div>
      </div>
    </div>

    <!-- Modal Xác Nhận Nộp Bài -->
    <div class="modal fade" id="confirmSubmitModal" tabindex="-1" aria-labelledby="confirmSubmitModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="confirmSubmitModalLabel">Xác nhận nộp bài</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
          <div class="modal-body">Bạn có chắc chắn muốn nộp bài không? Mọi câu trả lời sẽ được ghi nhận và không thể thay đổi.</div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-primary" id="confirm-submit-btn">Xác nhận nộp bài</button></div>
        </div>
      </div>
    </div>

    <!-- Modal Cảnh Báo Chuyển Tab -->
    <div class="modal fade" id="tabSwitchWarningModal" tabindex="-1" aria-labelledby="tabSwitchWarningModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-warning border-3">
          <div class="modal-header bg-warning text-dark"><h5 class="modal-title" id="tabSwitchWarningModalLabel"><i class="fas fa-exclamation-triangle me-2"></i> Cảnh báo gian lận</h5></div>
          <div class="modal-body"><p>Chúng tôi phát hiện bạn đã rời khỏi màn hình làm bài. Hành động này được xem là vi phạm quy chế thi.</p><p>Số lần vi phạm: <strong id="tab-switch-count">1</strong>/<strong id="tab-switch-limit">3</strong></p><p class="fw-bold text-danger">Nếu vi phạm quá 3 lần, bài thi của bạn sẽ bị tự động nộp!</p></div>
          <div class="modal-footer"><button type="button" class="btn btn-warning" data-bs-dismiss="modal">Tôi đã hiểu</button></div>
        </div>
      </div>
    </div>

    <!-- Modal Tự Động Nộp Bài -->
    <div class="modal fade" id="autoSubmitModal" tabindex="-1" aria-labelledby="autoSubmitModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger border-3">
          <div class="modal-header bg-danger text-white"><h5 class="modal-title" id="autoSubmitModalLabel"><i class="fas fa-ban me-2"></i> Bài thi đã kết thúc</h5></div>
          <div class="modal-body"><p>Bạn đã vi phạm quy chế thi bằng cách rời khỏi màn hình làm bài quá 3 lần.</p><p class="fw-bold">Bài thi của bạn đã được tự động nộp.</p></div>
        </div>
      </div>
    </div>
    
    <!-- Modal Thông Báo Chung -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="notificationModalLabel">Thông báo</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
          <div class="modal-body" id="notificationModalBody"></div>
          <div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đã hiểu</button></div>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- Cấu hình Supabase & Các biến toàn cục ---
            const SUPABASE_URL = 'https://lkznteubcwladqkxyaqo.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxrem50ZXViY3dsYWRxa3h5YXFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjcwODksImV4cCI6MjA2NzgwMzA4OX0.7P4-H_ujbLG2KLEFiVtlGIs8o515OkqNw9MVPDF7sCY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // =====================================================================
            // ===== BẮT ĐẦU: CODE THEO DÕI KHÁCH TRUY CẬP (ĐÃ THÊM) =====
            // =====================================================================
            async function trackAnonymousVisitor(supabase) {
                const VISITOR_ID_KEY = 'anonymous_visitor_id';
                let visitorId = localStorage.getItem(VISITOR_ID_KEY);

                if (!visitorId) {
                    visitorId = crypto.randomUUID(); 
                    localStorage.setItem(VISITOR_ID_KEY, visitorId);
                    const channel = supabase.channel('anonymous_visitors');
                    channel.subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            channel.send({
                                type: 'broadcast',
                                event: 'new_visitor',
                                payload: { 
                                    visitorId: visitorId, 
                                    visitedAt: new Date().toISOString(),
                                    page: window.location.pathname
                                },
                            });
                        }
                    });
                }
            }
            trackAnonymousVisitor(supabase);
            // =====================================================================
            // ===== KẾT THÚC: CODE THEO DÕI KHÁCH TRUY CẬP =====
            // =====================================================================

            // --- Các biến và DOM elements cho Auth & UI chung ---
            const authContainer = document.getElementById('auth-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('registerForm');
            const facebookLoginBtn = document.getElementById('facebook-login-btn');
            const defaultAvatarIcon = "data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='50' fill='%23E5E7EB'/%3E%3Cpath d='M66.95 66.78a25.02 25.02 0 00-33.9 0C24.4 71.3 20 79.95 20 90h60c0-10.05-4.4-18.7-13.05-23.22zM50 55c-10.33 0-18.7-8.37-18.7-18.7S39.67 17.6 50 17.6s18.7 8.37 18.7 18.7-8.37 18.7-18.7 18.7z' fill='%23A0AEC0'/%3E%3C/svg%3E";
            const NOTIFICATION_KEY = 'newDocumentsCount';
            let presenceChannel = null;
            let currentUser = null;
            let currentUserRole = 'guest';

            // --- Các hàm xử lý Auth & UI chung (ĐÃ THÊM/CẬP NHẬT) ---
            function initializeRealtimePresence(user) {
                if (presenceChannel && presenceChannel.state === 'joined') return;
                const userChannel = supabase.channel('online-users', { config: { presence: { key: user.id } } });
                userChannel.subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await userChannel.track({
                            user_id: user.id,
                            full_name: user.user_metadata?.full_name || user.email,
                            avatar_url: user.user_metadata?.avatar_url,
                            role: 'user'
                        });
                    }
                });
                presenceChannel = userChannel;
            }

            async function leavePresenceChannel() {
                if (presenceChannel) {
                    await presenceChannel.unsubscribe();
                    presenceChannel = null;
                }
            }
            
            function getNotificationCount() { return parseInt(localStorage.getItem(NOTIFICATION_KEY) || '0', 10); }
            function setNotificationCount(count) { localStorage.setItem(NOTIFICATION_KEY, Math.max(0, count)); }

            function updateAllNotifications() {
                const count = getNotificationCount();
                const userDropdown = document.getElementById('userDropdown');
                const profileDropdownItem = document.getElementById('profile-dropdown-item');
                const navbarToggler = document.querySelector('.navbar-toggler'); 

                if (userDropdown) {
                    userDropdown.style.position = 'relative';
                    let badge = userDropdown.querySelector('.notification-badge');
                    if (count > 0) {
                        if (!badge) { badge = document.createElement('span'); badge.className = 'notification-badge'; userDropdown.appendChild(badge); }
                        badge.textContent = count;
                    } else { if (badge) badge.remove(); }
                }
                if (profileDropdownItem) {
                    let badge = profileDropdownItem.querySelector('.notification-badge');
                    if (count > 0) {
                        if (!badge) { badge = document.createElement('span'); badge.className = 'notification-badge'; profileDropdownItem.appendChild(badge); }
                        badge.textContent = `+${count}`;
                    } else { if (badge) badge.remove(); }
                }
                if (navbarToggler) {
                    let badge = navbarToggler.querySelector('.notification-badge');
                    if (count > 0) {
                        if (!badge) { badge = document.createElement('span'); badge.className = 'notification-badge'; navbarToggler.appendChild(badge); }
                    } else { if (badge) badge.remove(); }
                }
            }

            function translateSupabaseError(errorMessage) {
                if (!errorMessage) return "Đã có lỗi xảy ra. Vui lòng thử lại.";
                if (errorMessage.includes("User already registered")) return "Email này đã được đăng ký.";
                if (errorMessage.includes("Password should be at least 6 characters")) return "Mật khẩu phải có ít nhất 6 ký tự.";
                if (errorMessage.includes("Invalid login credentials")) return "Email hoặc mật khẩu không chính xác.";
                if (errorMessage.includes("Unable to validate email address: invalid format")) return "Địa chỉ email không hợp lệ.";
                return `Đã xảy ra lỗi: ${errorMessage}`;
            }

            function showAlert(containerId, message, type = 'danger') {
                const alertContainer = document.getElementById(containerId);
                if (alertContainer) {
                    alertContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show auth-alert" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
                }
            }
            
            function updateUI(user) {
                currentUser = user;
                if (!authContainer) return;
                if (user) {
                    const fullName = user.user_metadata?.full_name || user.email;
                    const avatarUrl = user.user_metadata?.avatar_url || defaultAvatarIcon;
                    authContainer.innerHTML = `<div class="nav-item dropdown"><a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: transparent; padding: 0.1rem 0.5rem; margin:0; border-radius: 50px;"><img src="${avatarUrl}" alt="${fullName}" class="user-avatar"><span class="gradient-text fw-bold">${fullName}</span></a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown"><li><a class="dropdown-item" id="profile-dropdown-item" href="infor-user.html"><i class="fas fa-user-circle fa-fw"></i> Hồ sơ của tôi</a></li><li><hr class="dropdown-divider"></li><li><a class="dropdown-item" href="#" id="logout-button"><i class="fas fa-sign-out-alt fa-fw"></i> Đăng xuất</a></li></ul></div>`;
                    document.getElementById('logout-button').addEventListener('click', handleLogout);
                } else {
                    authContainer.innerHTML = `<a href="#" class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#loginModal"><i class="fa-solid fa-user me-2"></i><span>Đăng ký / Đăng nhập</span></a>`;
                }
                updateAllNotifications();
            }

            async function handleRegister(event) {
                event.preventDefault();
                const name = document.getElementById('registerName').value, email = document.getElementById('registerEmail').value, phone = document.getElementById('registerPhone').value, password = document.getElementById('registerPassword').value;
                const registerButton = document.getElementById('register-submit-btn');
                document.getElementById('register-alert').innerHTML = '';
                registerButton.disabled = true;
                registerButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Đang xử lý...`;
                const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { full_name: name, phone: phone } } });
                if (error) {
                    showAlert('register-alert', translateSupabaseError(error.message));
                    registerButton.disabled = false;
                    registerButton.innerHTML = 'Tạo tài khoản';
                } else {
                    bootstrap.Modal.getInstance(document.getElementById('registerModal'))?.hide();
                    document.getElementById('fullscreen-success-overlay')?.classList.add('show');
                    setTimeout(() => {
                        document.getElementById('fullscreen-success-overlay')?.classList.remove('show');
                        registerForm.reset();
                        registerButton.disabled = true;
                        registerButton.innerHTML = 'Tạo tài khoản';
                    }, 2500);
                }
            }

            async function handleLogin(event) {
                event.preventDefault();
                const email = document.getElementById('loginEmail').value, password = document.getElementById('loginPassword').value;
                const loginButton = document.getElementById('login-submit-btn');
                document.getElementById('login-alert').innerHTML = '';
                loginButton.disabled = true;
                loginButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Đang đăng nhập...`;
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) showAlert('login-alert', translateSupabaseError(error.message));
                else if (data.user) bootstrap.Modal.getInstance(document.getElementById('loginModal'))?.hide();
                loginButton.disabled = false;
                loginButton.innerHTML = 'Đăng nhập';
            }

            async function signInWithFacebook() {
                const { error } = await supabase.auth.signInWithOAuth({ provider: 'facebook' });
                if (error) showAlert('login-alert', 'Không thể đăng nhập bằng Facebook. Vui lòng thử lại.');
            }

            async function handleLogout(event) {
                event.preventDefault();
                await leavePresenceChannel();
                await supabase.auth.signOut();
            }

            function setupPasswordToggle(toggleId, passwordId) {
                const toggleIcon = document.getElementById(toggleId), passwordInput = document.getElementById(passwordId);
                if (toggleIcon && passwordInput) {
                    toggleIcon.addEventListener('click', function() {
                        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
                        this.classList.toggle('fa-eye'); this.classList.toggle('fa-eye-slash');
                    });
                }
            }

            async function fetchUserProfile(user) {
                if (!user) { currentUserRole = 'guest'; return; }
                const { data, error } = await supabase.from('profiles').select('role').eq('id', user.id).single();
                currentUserRole = error ? 'user' : (data ? data.role : 'user');
            }
            
            // --- Logic chính của trang Quiz ---
            const topicScreen = document.getElementById('topic-screen');
            const quizListScreen = document.getElementById('quiz-list-screen');
            const quizScreen = document.getElementById('quiz-screen');
            const resultScreen = document.getElementById('result-screen');
            const topicContainer = document.getElementById('topic-container');
            const quizListContainer = document.getElementById('quiz-list-container');
            const questionTextEl = document.getElementById('question-text');
            const answerButtonsEl = document.getElementById('answer-buttons');
            const progressBarEl = document.getElementById('progress-bar');
            const questionTrackerEl = document.getElementById('question-tracker');
            const mainTimerEl = document.getElementById('main-timer');
            
            let currentQuiz, currentQuestionIndex, userAnswers, mainTimerInterval, quizEndTime;
            let tabSwitchCount = 0, tabSwitchWarningModal, autoSubmitModal, notificationModal;
            const MAX_TAB_SWITCH = 3;

            function showNotification(title, message) {
                document.getElementById('notificationModalLabel').innerText = title;
                document.getElementById('notificationModalBody').innerText = message;
                notificationModal.show();
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            async function fetchTopics() {
                const { data, error } = await supabase.from('quiz_topics').select('*').order('display_order');
                if (error) { console.error("Lỗi tải chủ đề:", error); return []; }
                return data;
            }

            async function fetchQuizzesForTopic(topicId) {
                const { data, error } = await supabase.from('quizzes').select('*, quiz_questions(id)').eq('topic_id', topicId).order('created_at');
                if (error) { console.error("Lỗi tải danh sách bài kiểm tra:", error); return []; }
                return data;
            }
            
            async function fetchQuestionsForQuiz(quizId) {
                const { data, error } = await supabase.from('quiz_questions').select('*, quiz_answers(*)').eq('quiz_id', quizId);
                if (error) { console.error("Lỗi tải câu hỏi:", error); return null; }
                return data;
            }

            function setupEventListeners() {
                // Event listener cho các nút auth
                if (registerForm) {
                    registerForm.addEventListener('submit', handleRegister);
                    const inputs = registerForm.querySelectorAll('input'), registerSubmitBtn = document.getElementById('register-submit-btn'), passwordInput = document.getElementById('registerPassword'), confirmPasswordInput = document.getElementById('confirmPassword'), feedbackDiv = document.getElementById('password-match-feedback');
                    const validateRegisterForm = () => {
                        let allFilled = Array.from(inputs).every(input => input.value.trim() !== '');
                        const passwordsMatch = passwordInput.value === confirmPasswordInput.value;
                        if (confirmPasswordInput.value !== '') { feedbackDiv.textContent = passwordsMatch ? 'Mật khẩu đã khớp!' : 'Mật khẩu không khớp!'; feedbackDiv.className = passwordsMatch ? 'password-match' : 'password-mismatch'; } 
                        else { feedbackDiv.textContent = ''; }
                        registerSubmitBtn.disabled = !(allFilled && passwordsMatch);
                    };
                    inputs.forEach(input => input.addEventListener('input', validateRegisterForm));
                }
                if (loginForm) loginForm.addEventListener('submit', handleLogin);
                if (facebookLoginBtn) facebookLoginBtn.addEventListener('click', signInWithFacebook);
                setupPasswordToggle('toggleLoginPassword', 'loginPassword');
                setupPasswordToggle('toggleRegisterPassword', 'registerPassword');
                setupPasswordToggle('toggleConfirmPassword', 'confirmPassword');

                // Event listener cho các hành động trên trang
                document.body.addEventListener('click', async (e) => {
                    const target = e.target;
                    if (target.closest('#back-to-topics-btn')) { quizListScreen.classList.add('d-none'); topicScreen.classList.remove('d-none'); }
                    const topicCard = target.closest('.topic-card'); if (topicCard) selectTopic(topicCard.dataset.topicId, topicCard.dataset.topicTitle);
                    const startButton = target.closest('.start-quiz-btn');
                    if (startButton && !startButton.disabled) {
                        if (!currentUser) { showNotification('Yêu cầu đăng nhập', 'Bạn cần đăng nhập để làm bài kiểm tra và lưu kết quả!'); return; }
                        const quizId = startButton.dataset.quizId;
                        startButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`; startButton.disabled = true;
                        const { data: selectedQuizData } = await supabase.from('quizzes').select('*').eq('id', quizId).single();
                        const questions = await fetchQuestionsForQuiz(quizId);
                        if (questions && selectedQuizData) { selectedQuizData.questions = shuffleArray(questions); startQuiz(selectedQuizData); } 
                        else { showNotification("Lỗi", "Không thể tải dữ liệu bài kiểm tra."); startButton.innerHTML = `Bắt đầu`; startButton.disabled = false; }
                    }
                    if (target.closest('#prev-btn')) showPreviousQuestion();
                    if (target.closest('#next-btn')) handleNextButton();
                    if (target.closest('#restart-btn')) { resultScreen.classList.add('d-none'); topicScreen.classList.remove('d-none'); renderTopicSelection(); }
                    if (target.closest('#review-answers-btn')) showReviewModal();
                    if (target.closest('#confirm-submit-btn')) { bootstrap.Modal.getInstance(document.getElementById('confirmSubmitModal'))?.hide(); await showResult(); }
                    
                    // Widget listeners
                    const leaderboardWidget = document.getElementById('leaderboard-widget-container');
                    if (target.closest('.leaderboard-fab-icon')) leaderboardWidget.classList.remove('collapsed');
                    if (target.closest('.leaderboard-close-btn')) leaderboardWidget.classList.add('collapsed');

                    const communityWidget = document.getElementById('community-widget-container');
                    if (target.closest('.community-fab-icon')) { if (communityWidget.classList.contains('collapsed')) { e.preventDefault(); communityWidget.classList.remove('collapsed'); sessionStorage.removeItem('communityCollapsed'); } }
                    if (target.closest('#community-close-btn')) { e.stopPropagation(); communityWidget.classList.add('collapsed'); sessionStorage.setItem('communityCollapsed', 'true'); }
                });
            }

            async function renderTopicSelection() {
                topicContainer.innerHTML = `<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Đang tải chủ đề...</p></div>`;
                const topics = await fetchTopics();
                topicContainer.innerHTML = topics.length === 0 ? `<p class="text-center text-secondary">Chưa có chủ đề nào.</p>` : '';
                topics.forEach(topic => {
                    topicContainer.innerHTML += `<div class="col-md-4 col-sm-6"><div class="topic-card" data-topic-id="${topic.id}" data-topic-title="${topic.title}"><i class="fas ${topic.icon_class || 'fa-question-circle'}"></i><h3>${topic.title}</h3></div></div>`;
                });
            }

            async function selectTopic(topicId, topicTitle) {
                topicScreen.classList.add('d-none');
                quizListScreen.classList.remove('d-none');
                quizListScreen.dataset.topic = topicId;
                quizListScreen.dataset.topicTitle = topicTitle;
                document.getElementById('quiz-list-title').innerText = `Chủ đề: ${topicTitle}`;
                await renderQuizList(topicId);
            }
            
            async function renderQuizList(topicId) {
                quizListContainer.innerHTML = `<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Đang tải...</p></div>`;
                const quizzes = await fetchQuizzesForTopic(topicId);
                if (quizzes.length === 0) { quizListContainer.innerHTML = `<p class="text-center text-secondary">Chủ đề này chưa có bài kiểm tra.</p>`; return; }
                let attemptedQuizzes = new Map();
                if (currentUser) {
                    const { data: attempts } = await supabase.from('quiz_attempts').select('quiz_id, score, total_possible_score').eq('user_id', currentUser.id).in('quiz_id', quizzes.map(q => q.id));
                    if (attempts) attempts.forEach(attempt => attemptedQuizzes.set(attempt.quiz_id, attempt));
                }
                quizListContainer.innerHTML = '';
                quizzes.forEach(quiz => {
                    const attempt = attemptedQuizzes.get(quiz.id);
                    const hasAccess = () => (currentUserRole === 'admin' || currentUserRole === 'student' || quiz.access_type === 'free' || (currentUserRole === 'membership' && quiz.access_type === 'membership'));
                    const isLocked = !hasAccess();
                    let lockReason = isLocked ? (quiz.access_type === 'membership' ? 'Yêu cầu Member' : 'Yêu cầu Học viên') : '';
                    let badgeClass = '', badgeText = '';
                    switch(quiz.access_type) { case 'free': badgeClass = 'badge-free'; badgeText = 'Miễn phí'; break; case 'membership': badgeClass = 'badge-membership'; badgeText = 'Member'; break; case 'student': badgeClass = 'badge-student'; badgeText = 'Học viên'; break; }
                    const badgeHtml = `<span class="quiz-badge ${badgeClass}">${badgeText}</span>`;
                    const highlightClass = quiz.access_type === 'student' ? 'highlight' : '';
                    let actionHtml = '';
                    if (attempt) actionHtml = `<div class="quiz-action-container text-end"><p class="mb-1 small text-secondary">Điểm của bạn</p><h5 class="fw-bold text-success mb-2">${attempt.score}/${attempt.total_possible_score}</h5><button class="btn btn-success" disabled><i class="fas fa-check-circle me-2"></i>Đã hoàn thành</button></div>`;
                    else if (isLocked) actionHtml = `<div class="quiz-action-container"><button class="btn btn-outline-secondary w-100" disabled><i class="fas fa-lock me-2"></i>${lockReason}</button></div>`;
                    else actionHtml = `<div class="quiz-action-container"><button class="btn btn-gradient start-quiz-btn w-100" data-quiz-id="${quiz.id}">Bắt đầu</button></div>`;
                    quizListContainer.innerHTML += `<div class="col-12"><div class="quiz-card ${highlightClass}">${badgeHtml}<div class="quiz-card-content"><h3 class="mb-2">${quiz.title}</h3><p class="text-secondary mb-md-0 mb-3">${quiz.description || ''}</p><div class="d-flex small text-secondary mt-2"><span class="me-4"><i class="fas fa-list-ol me-2"></i>${quiz.quiz_questions.length} câu</span><span><i class="fas fa-clock me-2"></i>${Math.ceil(quiz.duration_seconds / 60)} phút</span></div></div>${actionHtml}</div></div>`;
                });
            }

            async function handleVisibilityChange() {
                if (document.hidden && !quizScreen.classList.contains('d-none')) {
                    tabSwitchCount++;
                    if (tabSwitchCount >= MAX_TAB_SWITCH) {
                        document.removeEventListener('visibilitychange', handleVisibilityChange);
                        if (tabSwitchWarningModal._isShown) tabSwitchWarningModal.hide();
                        bootstrap.Modal.getInstance(document.getElementById('confirmSubmitModal'))?.hide();
                        autoSubmitModal.show();
                        await showResult(true, false);
                    } else {
                        document.getElementById('tab-switch-count').innerText = tabSwitchCount;
                        document.getElementById('tab-switch-limit').innerText = MAX_TAB_SWITCH;
                        tabSwitchWarningModal.show();
                    }
                }
            }

            function startQuiz(quizData) {
                currentQuiz = quizData; currentQuestionIndex = 0; userAnswers = new Array(currentQuiz.questions.length).fill(null);
                quizListScreen.classList.add('d-none'); resultScreen.classList.add('d-none'); quizScreen.classList.remove('d-none');
                document.getElementById('quiz-title').innerText = currentQuiz.title;
                document.getElementById('total-questions-indicator').innerText = currentQuiz.questions.length;
                tabSwitchCount = 0;
                document.addEventListener('visibilitychange', handleVisibilityChange);
                renderTracker(); showQuestion(); startMainTimer();
            }
            
            function startMainTimer() {
                quizEndTime = new Date().getTime() + currentQuiz.duration_seconds * 1000;
                clearInterval(mainTimerInterval);
                const updateTimer = async () => {
                    const timeLeft = Math.round((quizEndTime - new Date().getTime()) / 1000);
                    if (timeLeft <= 0) {
                        mainTimerEl.textContent = '00:00';
                        clearInterval(mainTimerInterval);
                        if (quizScreen.classList.contains('d-none')) return;
                        await showResult(false, true);
                    } else {
                        mainTimerEl.textContent = `${Math.floor(timeLeft / 60).toString().padStart(2, '0')}:${(timeLeft % 60).toString().padStart(2, '0')}`;
                    }
                };
                updateTimer();
                mainTimerInterval = setInterval(updateTimer, 1000);
            }

            function renderTracker() {
                questionTrackerEl.innerHTML = '';
                for (let i = 0; i < currentQuiz.questions.length; i++) {
                    const item = document.createElement('div');
                    item.className = 'tracker-item'; item.textContent = i + 1; item.dataset.index = i;
                    item.addEventListener('click', () => goToQuestion(i));
                    questionTrackerEl.appendChild(item);
                }
            }

            function updateTracker() {
                document.querySelectorAll('.tracker-item').forEach((item, index) => {
                    item.classList.remove('current', 'answered');
                    if (userAnswers[index] !== null && userAnswers[index] !== '') item.classList.add('answered');
                    if (index === currentQuestionIndex) item.classList.add('current');
                });
            }

            function showQuestion() {
                const question = currentQuiz.questions[currentQuestionIndex];
                questionTextEl.innerText = question.question_text;
                answerButtonsEl.innerHTML = '';
                if (question.question_type === 'essay') {
                    const textarea = document.createElement('textarea');
                    textarea.className = 'form-control'; textarea.rows = 4; textarea.placeholder = 'Nhập câu trả lời...';
                    textarea.value = userAnswers[currentQuestionIndex] || '';
                    textarea.addEventListener('input', saveAnswer);
                    answerButtonsEl.appendChild(textarea);
                } else {
                    const shuffledAnswers = shuffleArray([...question.quiz_answers]);
                    shuffledAnswers.forEach((answer, index) => {
                        const button = document.createElement('button');
                        button.className = 'btn answer-option';
                        button.innerHTML = `<span class="answer-label">${['A', 'B', 'C', 'D'][index]}</span> <span>${answer.answer_text}</span>`;
                        button.dataset.answerId = answer.id;
                        if (userAnswers[currentQuestionIndex] === answer.id) button.classList.add('selected');
                        button.addEventListener('click', saveAnswer);
                        answerButtonsEl.appendChild(button);
                    });
                }
                updateUIComponents();
            }
            
            function saveAnswer(e) {
                const target = e.currentTarget;
                if (target.tagName === 'BUTTON') {
                    userAnswers[currentQuestionIndex] = parseInt(target.dataset.answerId);
                    document.querySelectorAll('.answer-option').forEach(btn => btn.classList.remove('selected'));
                    target.classList.add('selected');
                } else if (target.tagName === 'TEXTAREA') {
                    userAnswers[currentQuestionIndex] = target.value;
                }
                updateTracker();
            }

            function updateUIComponents() {
                progressBarEl.style.width = `${((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100}%`;
                document.getElementById('current-question-indicator').innerText = currentQuestionIndex + 1;
                document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
                document.getElementById('next-btn').innerHTML = currentQuestionIndex === currentQuiz.questions.length - 1 ? 'Nộp bài <i class="fas fa-check-circle ms-2"></i>' : 'Tiếp theo <i class="fas fa-arrow-right ms-2"></i>';
                updateTracker();
            }
            
            function handleNextButton() {
                if (currentQuestionIndex < currentQuiz.questions.length - 1) { currentQuestionIndex++; showQuestion(); } 
                else { new bootstrap.Modal(document.getElementById('confirmSubmitModal')).show(); }
            }
            
            function showPreviousQuestion() { if (currentQuestionIndex > 0) { currentQuestionIndex--; showQuestion(); } }
            function goToQuestion(index) { currentQuestionIndex = index; showQuestion(); }

            async function showResult(isAutoSubmittedByCheat = false, isAutoSubmittedByTime = false) {
                document.removeEventListener('visibilitychange', handleVisibilityChange);
                clearInterval(mainTimerInterval);
                if (autoSubmitModal._isShown) setTimeout(() => autoSubmitModal.hide(), 1500);
                let score = 0, multipleChoiceCount = 0;
                currentQuiz.questions.forEach((q, i) => {
                    if (q.question_type === 'multiple_choice') {
                        multipleChoiceCount++;
                        const correctAnswer = q.quiz_answers.find(a => a.is_correct);
                        if (correctAnswer && userAnswers[i] === correctAnswer.id) score++;
                    }
                });
                if (currentUser) await saveQuizAttempt(score, multipleChoiceCount);
                quizScreen.classList.add('d-none'); resultScreen.classList.remove('d-none');
                document.getElementById('score').innerText = score;
                document.getElementById('total-score').innerText = multipleChoiceCount;
                const percentage = multipleChoiceCount > 0 ? (score / multipleChoiceCount) * 100 : 100;
                const resultIconEl = document.getElementById('result-icon'), resultMessageEl = document.getElementById('result-message');
                resultMessageEl.className = 'lead fw-bold mb-3';
                if (isAutoSubmittedByCheat) { resultIconEl.innerHTML = '<i class="fas fa-gavel text-danger"></i>'; resultMessageEl.innerText = "Bài thi đã nộp tự động do vi phạm quy chế!"; resultMessageEl.classList.add('text-danger'); } 
                else if (isAutoSubmittedByTime) { resultIconEl.innerHTML = '<i class="fas fa-clock text-info"></i>'; resultMessageEl.innerText = "Hết giờ! Bài thi của bạn đã được nộp tự động."; } 
                else {
                    if (percentage >= 80) { resultIconEl.innerHTML = '<i class="fas fa-trophy"></i>'; resultMessageEl.innerText = "Xuất sắc! Bạn là một chuyên gia thực thụ!"; } 
                    else if (percentage >= 50) { resultIconEl.innerHTML = '<i class="fas fa-thumbs-up text-success"></i>'; resultMessageEl.innerText = "Khá lắm! Kiến thức nền tảng của bạn rất tốt."; } 
                    else { resultIconEl.innerHTML = '<i class="fas fa-face-sad-tear"></i>'; resultMessageEl.innerText = "Cần cố gắng hơn! Hãy tiếp tục học hỏi nhé."; }
                }
            }

            async function saveQuizAttempt(score, totalPossibleScore) {
                if (!currentUser) return;
                try {
                    const { count } = await supabase.from('quiz_attempts').select('id', { count: 'exact' }).eq('user_id', currentUser.id).eq('quiz_id', currentQuiz.id);
                    if (count > 0) return;
                    const { data: attemptData, error: attemptError } = await supabase.from('quiz_attempts').insert({ user_id: currentUser.id, quiz_id: currentQuiz.id, completed_at: new Date().toISOString(), score, total_possible_score }).select().single();
                    if (attemptError) { showNotification('Lỗi', 'Không thể lưu kết quả bài làm.'); return; }
                    const answersToSave = userAnswers.map((answer, index) => ({ attempt_id: attemptData.id, question_id: currentQuiz.questions[index].id, selected_answer_id: currentQuiz.questions[index].question_type === 'multiple_choice' ? answer : null, essay_answer_text: currentQuiz.questions[index].question_type === 'essay' ? answer : null })).filter(a => a.selected_answer_id !== null || (a.essay_answer_text && a.essay_answer_text.trim() !== ''));
                    if (answersToSave.length > 0) await supabase.from('quiz_attempt_answers').insert(answersToSave);
                    const { error: rpcError } = await supabase.rpc('increment_user_score', { user_id_param: currentUser.id, score_to_add: score });
                    if (rpcError) showNotification('Lỗi', 'Không thể cập nhật tổng điểm của bạn.');
                    else await renderLeaderboard();
                } catch (error) { showNotification('Lỗi Hệ Thống', 'Đã có lỗi xảy ra khi lưu kết quả.'); }
            }

            function showReviewModal() {
                const modalBody = document.getElementById('review-modal-body');
                modalBody.innerHTML = '';
                currentQuiz.questions.forEach((q, index) => {
                    const questionBlock = document.createElement('div');
                    questionBlock.className = 'review-question-block';
                    let content = `<p class="fw-bold">${index + 1}. ${q.question_text}</p>`;
                    if (q.question_type === 'essay') {
                        content += `<div><h6 class="text-muted small">Câu trả lời của bạn:</h6><p class="fst-italic bg-light p-2 rounded">${userAnswers[index] || 'Chưa trả lời'}</p></div><div class="teacher-comment-box mt-3"><h6 class="text-muted small"><i class="fas fa-comment-dots me-2"></i>Nhận xét:</h6><textarea class="form-control" rows="2" placeholder="Giáo viên sẽ nhận xét ở đây..." disabled></textarea></div>`;
                    } else {
                        const correctAnswerId = q.quiz_answers.find(a => a.is_correct)?.id;
                        q.quiz_answers.forEach((answer, i) => {
                            let classes = 'btn answer-option review-answer-option';
                            if (answer.id === correctAnswerId) classes += ' correct-answer';
                            if (answer.id === userAnswers[index]) { classes += ' user-answer'; if (answer.id !== correctAnswerId) classes += ' incorrect-answer'; }
                            content += `<button class="${classes}" disabled><span class="answer-label">${['A', 'B', 'C', 'D'][i]}</span> <span>${answer.answer_text}</span></button>`;
                        });
                    }
                    questionBlock.innerHTML = content;
                    modalBody.appendChild(questionBlock);
                });
            }

            async function renderLeaderboard() {
                const listContainer = document.getElementById('leaderboard-list-container'), userRankContainer = document.getElementById('user-rank-container');
                listContainer.innerHTML = `<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></div>`;
                userRankContainer.innerHTML = '';
                const { data: topUsers } = await supabase.from('profiles').select('id, full_name, avatar_url, total_quiz_score').not('total_quiz_score', 'is', null).order('total_quiz_score', { ascending: false }).limit(10);
                if (!topUsers || topUsers.length === 0) { listContainer.innerHTML = `<p class="text-center text-secondary p-3">Chưa có ai trên BXH.</p>`; } 
                else {
                    listContainer.innerHTML = '';
                    topUsers.forEach((user, index) => {
                        const item = document.createElement('li');
                        item.className = 'leaderboard-item';
                        if (currentUser && user.id === currentUser.id) item.classList.add('current-user');
                        item.innerHTML = `<span class="leaderboard-rank">${index + 1}</span><img src="${user.avatar_url || defaultAvatarIcon}" alt="${user.full_name}" class="leaderboard-avatar"><span class="leaderboard-name">${user.full_name || 'Anonymous'}</span><span class="leaderboard-score">${user.total_quiz_score || 0}</span>`;
                        listContainer.appendChild(item);
                    });
                }
                if (currentUser) {
                    const { data: userProfile } = await supabase.from('profiles').select('total_quiz_score').eq('id', currentUser.id).single();
                    if (!userProfile || userProfile.total_quiz_score === null) { userRankContainer.innerHTML = `<p class="text-center text-secondary mb-0">Bạn chưa có hạng. Hãy làm bài nhé!</p>`; return; }
                    const userScore = userProfile.total_quiz_score;
                    const { count } = await supabase.from('profiles').select('*', { count: 'exact', head: true }).gt('total_quiz_score', userScore);
                    const userRank = (count ?? 0) + 1;
                    if (!topUsers.some(user => user.id === currentUser.id)) {
                         userRankContainer.innerHTML = `<div class="leaderboard-item current-user"><span class="leaderboard-rank">${userRank}</span><img src="${currentUser.user_metadata?.avatar_url || defaultAvatarIcon}" class="leaderboard-avatar"><span class="leaderboard-name">${currentUser.user_metadata?.full_name || 'Anonymous'}</span><span class="leaderboard-score">${userScore}</span></div>`;
                    } else {
                        userRankContainer.innerHTML = `<p class="text-center fw-bold mb-0">Vị trí của bạn: <span class="gradient-text">${userRank}</span></p>`;
                    }
                } else {
                     userRankContainer.innerHTML = `<p class="text-center text-secondary mb-0">Đăng nhập để xem hạng.</p>`;
                }
            }

            async function loadWebsiteSettings() {
                const { data } = await supabase.from('website_settings').select('*').eq('id', 1).single();
                if (data) {
                    const headerLogo = document.getElementById('header-logo'), footerLogo = document.getElementById('footer-logo');
                    if (headerLogo && data.header_logo_url) headerLogo.src = data.header_logo_url;
                    if (footerLogo && data.footer_logo_url) footerLogo.src = data.footer_logo_url;
                }
            }

            async function main() {
                tabSwitchWarningModal = new bootstrap.Modal(document.getElementById('tabSwitchWarningModal'));
                autoSubmitModal = new bootstrap.Modal(document.getElementById('autoSubmitModal'));
                notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));

                // Lấy trạng thái đăng nhập ban đầu
                const { data: { session } } = await supabase.auth.getSession();
                updateUI(session ? session.user : null);
                await fetchUserProfile(session ? session.user : null);
                if (session?.user) initializeRealtimePresence(session.user);
                
                // Lắng nghe thay đổi trạng thái đăng nhập
                supabase.auth.onAuthStateChange(async (_event, session) => {
                    const wasLoggedIn = !!currentUser;
                    const isLoggedIn = !!(session?.user);
                    updateUI(session ? session.user : null);
                    await fetchUserProfile(session ? session.user : null);
                    if (session?.user) initializeRealtimePresence(session.user); else await leavePresenceChannel();
                    if (wasLoggedIn !== isLoggedIn && !quizListScreen.classList.contains('d-none')) {
                        const topicId = quizListScreen.dataset.topic;
                        if (topicId) await renderQuizList(topicId);
                    }
                });
                
                setupEventListeners();
                const communityWidget = document.getElementById('community-widget-container');
                if (sessionStorage.getItem('communityCollapsed') === 'true') communityWidget.classList.add('collapsed');

                await renderTopicSelection();
                await renderLeaderboard();
                await loadWebsiteSettings();
            }

            main();
        });
    </script>
</body>

</html>
