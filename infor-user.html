<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ Sơ Của Tôi - VietTarot</title>

    <!-- Các link CSS và Font từ trang chủ -->
    <link rel="icon" type="image/png" href="https://lkznteubcwladqkxyaqo.supabase.co/storage/v1/object/public/website-assets//logotab.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-blue: #4A6CF3;
            --primary-purple: #9B49F2;
            --text-primary: #1A1229;
            --text-secondary: #5A6474;
            --bg-white: #FFFFFF;
            --bg-off-white: #F8F7FA;
            --border-color: #E5E7EB;
            --danger-color: #dc3545;
            --warning-color: #FFC107;
            --success-color: #198754;
            --info-color: #0dcaf0;
            --gradient-primary: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-purple) 100%);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-off-white);
            color: var(--text-primary);
        }

        /* ======================= CSS HEADER & FOOTER (ĐỒNG BỘ TỪ INDEX.HTML) ======================= */
        header {
            position: sticky;
            top: 0;
            z-index: 1030;
            background-color: var(--bg-white);
            box-shadow: 0 10px 40px -15px rgba(74, 108, 243, 0.25);
        }
        .navbar {
            background-color: transparent !important;
            box-shadow: none !important;
            padding: 15px 0px;
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 1.75rem;
        }
        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: var(--primary-blue);
        }
        .navbar-toggler {
            position: relative;
        }
        .navbar-nav .nav-link {
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.4rem 1.7rem;
            margin: 0 0.6rem;
            border-radius: 20px;
            display: flex;
            align-items: center;
            position: relative;
            z-index: 1;
            overflow: hidden;
            transition: color 0.4s ease-in-out;
            background-color: transparent;
        }
        .navbar-nav .nav-link::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: var(--gradient-primary);
            z-index: -1;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease-in-out;
        }
        .navbar-nav .nav-link:hover { color: var(--bg-white); }
        .navbar-nav .nav-link:hover::before { transform: scaleX(1); }
        .navbar-nav .nav-link.active {
            color: var(--bg-white);
            font-weight: 600;
        }
        .navbar-nav .nav-link.active::before { transform: scaleX(1); }
        .navbar-nav .nav-link.active:hover { color: var(--bg-white); }
        .dropdown-menu {
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -2px rgba(0,0,0,0.05);
            padding: 0.5rem 0;
            margin-top: 0.5rem !important;
        }
        .dropdown-item {
            padding: 0.5rem 1.2rem;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }
        .dropdown-item:hover, .dropdown-item:focus {
            background-color: var(--bg-off-white);
            color: var(--text-primary);
        }
        .dropdown-item .fa-fw {
            width: 20px;
            text-align: center;
            margin-right: 8px;
        }
        .btn-gradient {
            background: var(--gradient-primary);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(120, 73, 242, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            background-size: 200% auto;
        }
        .btn-gradient:hover {
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(120, 73, 242, 0.5);
            background-position: right center;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            background-color: var(--border-color);
            border: 2px solid var(--primary-purple);
            box-shadow: 0 2px 8px rgba(155, 73, 242, 0.4);
        }
        #header-logo, #footer-logo-img {
            max-height: 40px; 
            width: auto;      
        }
        #footer-logo-img { max-height: 50px; }
        .site-footer {
            background: var(--gradient-primary);
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            padding-top: 4rem;
        }
        .footer-widget h5 {
            color: var(--bg-white);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        .footer-links li { margin-bottom: 0.75rem; }
        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .footer-links a:hover {
            color: var(--bg-white);
            padding-left: 5px;
        }
        .social-icons a {
            display: inline-flex;
            width: 40px; height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--bg-white);
            justify-content: center;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }
        .social-icons a:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .footer-bottom {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 1.5rem 0;
            margin-top: 3rem;
        }
        .footer-bottom p { color: var(--bg-white); }
        
        /* ======================= CSS CHO TRANG HỒ SƠ ======================= */
        .profile-section { padding: 4rem 0; }
        .profile-sidebar {
            background-color: var(--bg-white);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            height: 100%;
        }
        .profile-user-info {
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .profile-avatar-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
            cursor: pointer;
        }
        .profile-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-purple);
        }
        .profile-avatar-wrapper .edit-avatar-icon {
            position: absolute;
            bottom: 0; right: 0;
            width: 36px; height: 36px;
            background-color: var(--primary-purple);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            transition: all 0.3s ease;
            opacity: 0;
            transform: scale(0.8);
        }
        .profile-avatar-wrapper:hover .edit-avatar-icon {
            opacity: 1;
            transform: scale(1);
        }
        .profile-user-info .user-name {
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        .profile-user-info .user-email {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .profile-nav .nav-link {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            position: relative; /* Cần cho huy hiệu thông báo */
        }
        .profile-nav .nav-link .nav-icon {
            width: 20px;
            margin-right: 1rem;
            text-align: center;
        }
        .profile-nav .nav-link:hover {
            background-color: var(--bg-off-white);
            color: var(--text-primary);
        }
        .profile-nav .nav-link.active {
            background: var(--gradient-primary);
            color: var(--bg-white);
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(74, 108, 243, 0.3);
        }
        .profile-content-panel { display: none; }
        .profile-content-panel.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        .card-header {
            background-color: var(--bg-white);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }
        .card-header h5 { margin: 0; font-weight: 600; }
        .card-body { padding: 1.5rem; }
        .form-label {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .form-control {
            background-color: var(--bg-white);
            border: 1px solid var(--border-color);
            padding: 0.8rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            background-color: var(--bg-white);
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(74, 108, 243, 0.2);
        }
        .form-control:disabled {
            background-color: var(--bg-off-white);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        .password-wrapper { position: relative; }
        .password-toggle-icon {
            position: absolute;
            right: 1rem;
            top: 75%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-secondary);
        }
        .placeholder-content {
            text-align: center;
            padding: 3rem;
            border: 2px dashed var(--border-color);
            border-radius: 0.75rem;
        }
        .placeholder-content .icon {
            font-size: 3rem;
            color: var(--border-color);
            margin-bottom: 1rem;
        }
        .placeholder-content h6 {
            font-weight: 600;
            color: var(--text-secondary);
        }
        .placeholder-content p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .toast-container { z-index: 1100; }
        .toast-body { font-weight: 500; }
        #avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .avatar-option {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            cursor: pointer;
            border: 4px solid transparent;
            transition: all 0.3s ease;
            background-color: var(--bg-off-white);
        }
        .avatar-option:hover {
            transform: scale(1.05);
            border-color: rgba(155, 73, 242, 0.5);
        }
        .avatar-option.selected {
            border-color: var(--primary-purple);
            box-shadow: 0 0 15px rgba(155, 73, 242, 0.5);
            transform: scale(1.05);
        }

        .saved-document-list { list-style: none; padding: 0; }
        .saved-document-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }
        .saved-document-item:not(:last-child) { border-bottom: 1px solid var(--border-color); }
        .saved-document-item:hover { 
            background-color: var(--bg-off-white); 
            transform: translateX(5px);
        }
        .saved-document-item .saved-document-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-grow: 1;
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }
        .saved-document-item:active {
            transform: translateX(5px) scale(0.98);
            background-color: #e9e7ec;
        }
        .saved-document-stt {
            font-weight: 600;
            color: var(--text-secondary);
            width: 25px;
            flex-shrink: 0;
            text-align: center;
        }
        .saved-document-thumbnail {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            object-fit: contain;
            background-color: #f0f0f0;
        }
        .saved-document-info { flex-grow: 1; }
        .saved-document-info h6 { font-weight: 600; margin-bottom: 0.25rem; }
        .saved-document-info p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0;
        }
        
        .pagination-container { margin-top: 2rem; }
        .pagination .page-link {
            border-radius: 50% !important;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 5px;
            border: 1px solid var(--border-color);
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
         .pagination .page-link:hover {
            background-color: var(--bg-off-white);
            color: var(--primary-blue);
            border-color: var(--primary-blue);
        }
        .pagination .page-item.disabled .page-link {
            background-color: transparent;
            color: #ced4da;
            border-color: var(--border-color);
        }
        .pagination .page-item.active .page-link {
             background: var(--gradient-primary);
             border-color: transparent;
             color: white;
             box-shadow: 0 4px 15px rgba(120, 73, 242, 0.3);
        }

        #pdf-loader-overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-off-white);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 2rem;
            opacity: 1; visibility: visible;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #pdf-loader-overlay.hidden { opacity: 0; visibility: hidden; }
        #pdf-loader-overlay .progress-bar {
            background: var(--gradient-primary);
            transition: width 0.1s linear;
        }
        #pdf-iframe {
            border: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #pdf-iframe.loaded { opacity: 1; }
        #pdf-viewer-custom-header {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 48px;
            background-color: var(--bg-white);
            z-index: 5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem 0 1.5rem;
            border-bottom: 1px solid var(--border-color);
            opacity: 0; visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #pdf-viewer-title-placeholder {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 60%;
        }
        
        /* CSS CHO THÔNG BÁO (ĐỒNG BỘ TỪ INDEX.HTML) */
        .notification-badge {
            position: absolute;
            min-width: 22px;
            height: 22px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-white);
            transform: scale(1);
            animation: pulse-badge 1.5s infinite;
            z-index: 10;
        }
        #userDropdown .notification-badge {
             top: -2px;
             right: 0;
        }
        .navbar-toggler .notification-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 10px;
            height: 10px;
            min-width: auto;
            padding: 0;
            font-size: 0;
            border-width: 2px;
        }
        .profile-nav .nav-link .notification-badge {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            min-width: 20px;
            height: 20px;
            font-size: 11px;
            animation: none; /* Tắt animation pulse trong menu */
        }
        @keyframes pulse-badge {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        
        #deleteConfirmModal .modal-header {
            border-bottom: none;
            padding-bottom: 0;
        }
        #deleteConfirmModal .modal-body {
            text-align: center;
        }
        #deleteConfirmModal .delete-icon {
            font-size: 3rem;
            color: var(--danger-color);
            margin-bottom: 1rem;
        }
        #deleteConfirmModal .modal-title {
            font-weight: 600;
        }

        /* ======================= TÙY CHỈNH CHO GIAO DIỆN MOBILE ======================= */
        @media (max-width: 576px) {
            .saved-document-item {
                align-items: flex-start;
                gap: 0.75rem;
                padding: 0.75rem;
            }
            .saved-document-stt { display: none; }
            .saved-document-thumbnail {
                width: 65px;
                height: 65px;
            }
            .saved-document-info h6 {
                font-size: 0.9rem;
                line-height: 1.3;
            }
            .saved-document-info p { font-size: 0.8rem; }
            .btn-remove-saved {
                padding: .25rem .6rem;
                font-size: .8rem;
                margin-left: auto; 
            }
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" href="index.html">
                    <img src="https://placehold.co/150x40/E5E7EB/1A1229?text=VietTarot" alt="VietTarot Logo" id="header-logo">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="mainNavbar">
                    <ul class="navbar-nav mx-auto">
                         <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="fas fa-home me-2"></i>Trang chủ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="test.html">
                                <i class="fas fa-graduation-cap me-2"></i>Khoá học
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="document.html">
                                <i class="fas fa-book me-2"></i>Tài liệu
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="blog.html">
                                <i class="fas fa-scroll me-2"></i>Bài Viết
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="cards.html">
                                <i class="fas fa-layer-group me-2"></i>
                                Ý nghĩa lá bài
                            </a>
                        </li>
                    </ul>
                    <div id="auth-container" class="d-flex justify-content-center mt-3 mt-lg-0">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="profile-section">
            <div class="container">
                <div class="row">
                    <div class="col-lg-4 mb-4 mb-lg-0">
                        <div class="profile-sidebar">
                            <div class="profile-user-info">
                                <div class="profile-avatar-wrapper" data-bs-toggle="modal" data-bs-target="#avatarSelectionModal" title="Nhấp để thay đổi ảnh đại diện">
                                    <img src="https://placehold.co/120x120/E5E7EB/A0AEC0?text=User" alt="User Avatar" class="profile-avatar" id="profile-avatar-img">
                                    <span class="edit-avatar-icon">
                                        <i class="fas fa-camera"></i>
                                    </span>
                                </div>
                                <h5 class="user-name" id="profile-user-name">Đang tải...</h5>
                                <p class="user-email" id="profile-user-email">email@example.com</p>
                            </div>
                            <nav class="nav flex-column profile-nav" id="profile-nav-menu">
                                <a class="nav-link active" href="#personal-info" data-target="personal-info-panel">
                                    <i class="fas fa-user-edit nav-icon"></i> Thông tin cá nhân
                                </a>
                                <a class="nav-link" href="#my-courses" data-target="my-courses-panel">
                                    <i class="fas fa-graduation-cap nav-icon"></i> Khoá học của tôi
                                </a>
                                <a class="nav-link" href="#my-documents" data-target="my-documents-panel">
                                    <i class="fas fa-file-alt nav-icon"></i> Tài liệu của tôi
                                </a>
                                <a class="nav-link" href="#order-history" data-target="order-history-panel">
                                    <i class="fas fa-history nav-icon"></i> Lịch sử giao dịch
                                </a>
                                <a class="nav-link" href="#settings" data-target="settings-panel">
                                    <i class="fas fa-cog nav-icon"></i> Cài đặt
                                </a>
                                <a class="nav-link" href="#" id="profile-logout-button">
                                    <i class="fas fa-sign-out-alt nav-icon"></i> Đăng xuất
                                </a>
                            </nav>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div id="personal-info-panel" class="profile-content-panel active">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Thông tin cá nhân</h5>
                                </div>
                                <div class="card-body">
                                    <form id="update-profile-form">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="profileFullName" class="form-label">Họ và tên</label>
                                                <input type="text" class="form-control" id="profileFullName" placeholder="Nhập họ và tên của bạn" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="profilePhone" class="form-label">Số điện thoại</label>
                                                <input type="tel" class="form-control" id="profilePhone" placeholder="Nhập số điện thoại của bạn">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="profileEmail" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="profileEmail" disabled>
                                        </div>
                                        <button type="submit" class="btn btn-gradient">
                                            <i class="fas fa-save me-2"></i>Lưu thay đổi
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h5>Thay đổi mật khẩu</h5>
                                </div>
                                <div class="card-body">
                                    <form id="update-password-form">
                                        <div class="mb-3 password-wrapper">
                                            <label for="currentPassword" class="form-label">Mật khẩu hiện tại</label>
                                            <input type="password" class="form-control" id="currentPassword" placeholder="Để trống nếu không muốn đổi" >
                                        </div>
                                        <div class="mb-3 password-wrapper">
                                            <label for="newPassword" class="form-label">Mật khẩu mới</label>
                                            <input type="password" class="form-control" id="newPassword" placeholder="Nhập mật khẩu mới (ít nhất 6 ký tự)">
                                            <i class="fas fa-eye password-toggle-icon" data-target="newPassword"></i>
                                        </div>
                                        <div class="mb-3 password-wrapper">
                                            <label for="confirmNewPassword" class="form-label">Xác nhận mật khẩu mới</label>
                                            <input type="password" class="form-control" id="confirmNewPassword" placeholder="Nhập lại mật khẩu mới">
                                            <i class="fas fa-eye password-toggle-icon" data-target="confirmNewPassword"></i>
                                        </div>
                                        <button type="submit" class="btn btn-gradient">
                                            <i class="fas fa-key me-2"></i>Cập nhật mật khẩu
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div id="my-courses-panel" class="profile-content-panel">
                            <div class="card">
                                <div class="card-header"><h5>Khoá học của tôi</h5></div>
                                <div class="card-body">
                                    <div class="placeholder-content">
                                        <div class="icon"><i class="fas fa-book-open"></i></div>
                                        <h6>Bạn chưa tham gia khóa học nào</h6>
                                        <p>Hãy khám phá các khóa học tuyệt vời của chúng tôi nhé!</p>
                                        <a href="#" class="btn btn-gradient mt-2">Xem khóa học</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="my-documents-panel" class="profile-content-panel">
                            <div class="card">
                                <div class="card-header"><h5>Tài liệu của tôi</h5></div>
                                <div class="card-body" id="my-documents-content">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-secondary">Đang tải tài liệu của bạn...</p>
                                    </div>
                                </div>
                                <nav class="pagination-container d-flex justify-content-center pb-4">
                                    <ul class="pagination" id="saved-documents-pagination"></ul>
                                </nav>
                            </div>
                        </div>

                        <div id="order-history-panel" class="profile-content-panel">
                             <div class="card">
                                <div class="card-header"><h5>Lịch sử giao dịch</h5></div>
                                <div class="card-body">
                                    <div class="placeholder-content">
                                        <div class="icon"><i class="fas fa-receipt"></i></div>
                                        <h6>Không có giao dịch nào</h6>
                                        <p>Tất cả các giao dịch mua của bạn sẽ được hiển thị tại đây.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="settings-panel" class="profile-content-panel">
                             <div class="card">
                                <div class="card-header"><h5>Cài đặt</h5></div>
                                <div class="card-body">
                                    <div class="placeholder-content">
                                        <div class="icon"><i class="fas fa-tools"></i></div>
                                        <h6>Tính năng đang được phát triển</h6>
                                        <p>Chúng tôi sẽ sớm cập nhật mục này. Vui lòng quay lại sau.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-6 mb-4 mb-lg-0">
                    <div class="footer-widget">
                        <a class="footer-logo" href="index.html">
                             <img src="https://placehold.co/180x50/E5E7EB/1A1229?text=VietTarot" alt="VietTarot Logo" id="footer-logo-img">
                        </a>
                        <p class="mt-3">Nền tảng học Tarot và Huyền học trực tuyến hàng đầu Việt Nam. Khai phá tiềm năng, thấu hiểu bản thân và định hướng tương lai.</p>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 mb-4 mb-lg-0">
                    <div class="footer-widget">
                        <h5>Khám Phá</h5>
                        <ul class="list-unstyled footer-links">
                            <li><a href="index.html">Trang chủ</a></li>
                            <li><a href="#">Khoá học</a></li>
                            <li><a href="#">Tài liệu</a></li>
                            <li><a href="#">Về chúng tôi</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4 mb-md-0">
                    <div class="footer-widget">
                        <h5>Hỗ Trợ</h5>
                        <ul class="list-unstyled footer-links">
                            <li><a href="#">Câu hỏi thường gặp</a></li>
                            <li><a href="#">Chính sách bảo mật</a></li>
                            <li><a href="#">Điều khoản dịch vụ</a></li>
                            <li><a href="#">Liên hệ</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="footer-widget">
                        <h5>Kết Nối Với Chúng Tôi</h5>
                        <div class="social-icons mt-3">
                            <a href="#" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
                            <a href="#" title="Youtube"><i class="fab fa-youtube"></i></a>
                            <a href="#" title="Tiktok"><i class="fab fa-tiktok"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="container text-center">
                <p class="mb-0">&copy; 2025 được phát triển bởi hệ thống VietTarot</p>
            </div>
        </div>
    </footer>

    <!-- Modal để chọn Avatar -->
    <div class="modal fade" id="avatarSelectionModal" tabindex="-1" aria-labelledby="avatarSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="avatarSelectionModalLabel">Chọn ảnh đại diện của bạn</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-secondary text-center mb-3">Hãy chọn một ảnh đại diện thật xinh nhé!</p>
                    <div id="avatar-grid">
                        <div class="text-center w-100">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-gradient" id="save-avatar-button">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Trình xem PDF -->
    <div class="modal fade" id="pdfViewerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-body p-0" style="position: relative;">
                    <div id="pdf-loader-overlay">
                        <div class="pdf-loader-content text-center">
                            <div class="progress mb-3" style="height: 10px;">
                                <div id="pdf-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <p class="mb-0 fw-bold"><span id="pdf-progress-text">Đang tải tài liệu: 0%</span></p>
                        </div>
                    </div>
                    
                    <div id="pdf-viewer-custom-header">
                        <span id="pdf-viewer-title-placeholder" class="gradient-text">Tên tài liệu...</span>
                        <button type="button" class="btn btn-sm btn-gradient rounded-pill" data-bs-dismiss="modal" aria-label="Close">
                            <i class="fas fa-times me-sm-1"></i>
                            <span class="d-none d-sm-inline">Đóng trình xem</span>
                        </button>
                    </div>

                    <iframe id="pdf-iframe" src="" width="100%" height="100%"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- THÊM MỚI: Modal Xác nhận Xóa -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Xác nhận Xóa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="delete-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <p>Bạn có chắc chắn muốn xóa tài liệu này khỏi sổ tay không? Hành động này không thể hoàn tác.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ======================= SUPABASE CLIENT INITIALIZATION =======================
            const SUPABASE_URL = 'https://lkznteubcwladqkxyaqo.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxrem50ZXViY3dsYWRxa3h5YXFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjcwODksImV4cCI6MjA2NzgwMzA4OX0.7P4-H_ujbLG2KLEFiVtlGIs8o515OkqNw9MVPDF7sCY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            

            // =========================================================================
            // ===== BẮT ĐẦU: LOGIC MỚI CHO CHỨC NĂNG NGƯỜI DÙNG ONLINE (ĐÃ THÊM) =====
            // =========================================================================
            let presenceChannel = null;

            function initializeRealtimePresence(user) {
                if (presenceChannel && presenceChannel.state === 'joined') {
                    return;
                }
                const userChannel = supabase.channel('online-users', {
                    config: {
                        presence: {
                            key: user.id,
                        },
                    },
                });

                userChannel.subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        const trackStatus = await userChannel.track({
                            user_id: user.id,
                            full_name: user.user_metadata?.full_name || user.email,
                            avatar_url: user.user_metadata?.avatar_url,
                            role: 'user'
                        });
                        if (trackStatus !== 'ok') {
                            console.error('Lỗi khi phát tín hiệu online.');
                        }
                    }
                });
                presenceChannel = userChannel;
            }

            async function leavePresenceChannel() {
                if (presenceChannel) {
                    await presenceChannel.unsubscribe();
                    presenceChannel = null;
                }
            }
            // =========================================================================
            // ===== KẾT THÚC: LOGIC MỚI CHO CHỨC NĂNG NGƯỜI DÙNG ONLINE =====
            // =========================================================================


            // ======================= START: LOGIC THÔNG BÁO MỚI (ĐỒNG BỘ TỪ INDEX.HTML) =======================
            const NOTIFICATION_KEY = 'newDocumentsCount';

            function getNotificationCount() {
                return parseInt(localStorage.getItem(NOTIFICATION_KEY) || '0', 10);
            }

            function setNotificationCount(count) {
                localStorage.setItem(NOTIFICATION_KEY, Math.max(0, count));
            }
            
            function updateAllNotifications() {
                const count = getNotificationCount();
                const userDropdown = document.getElementById('userDropdown');
                const documentsLink = document.querySelector('.profile-nav .nav-link[data-target="my-documents-panel"]');
                const navbarToggler = document.querySelector('.navbar-toggler');

                // Cập nhật badge trên avatar header
                if (userDropdown) {
                    let badge = userDropdown.querySelector('.notification-badge');
                    if (count > 0) {
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'notification-badge';
                            userDropdown.appendChild(badge);
                        }
                        badge.textContent = count;
                    } else {
                        if (badge) badge.remove();
                    }
                }
                
                // Cập nhật badge trên nút menu mobile
                if (navbarToggler) {
                    let badge = navbarToggler.querySelector('.notification-badge');
                    if (count > 0) {
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'notification-badge';
                            navbarToggler.appendChild(badge);
                        }
                    } else {
                        if (badge) badge.remove();
                    }
                }

                // Cập nhật badge trong menu profile
                if (documentsLink) {
                    let badge = documentsLink.querySelector('.notification-badge');
                    if (count > 0) {
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'notification-badge';
                            documentsLink.appendChild(badge);
                        }
                        badge.textContent = `+${count}`;
                    } else {
                        if (badge) badge.remove();
                    }
                }
            }

            function clearAllNotifications() {
                setNotificationCount(0);
                updateAllNotifications();
            }
            // ======================= END: LOGIC THÔNG BÁO MỚI =======================

            // ======================= DOM ELEMENT SELECTORS =======================
            const authContainer = document.getElementById('auth-container');
            const profileAvatarImg = document.getElementById('profile-avatar-img');
            const profileUserName = document.getElementById('profile-user-name');
            const profileUserEmail = document.getElementById('profile-user-email');
            const profileNavMenu = document.getElementById('profile-nav-menu');
            const profileLogoutButton = document.getElementById('profile-logout-button');
            const updateProfileForm = document.getElementById('update-profile-form');
            const updatePasswordForm = document.getElementById('update-password-form');
            const profileFullNameInput = document.getElementById('profileFullName');
            const profilePhoneInput = document.getElementById('profilePhone');
            const profileEmailInput = document.getElementById('profileEmail');
            const contentPanels = document.querySelectorAll('.profile-content-panel');
            const avatarGrid = document.getElementById('avatar-grid');
            const saveAvatarButton = document.getElementById('save-avatar-button');
            const avatarSelectionModalEl = document.getElementById('avatarSelectionModal');
            let selectedAvatarUrl = null;
            const myDocumentsContent = document.getElementById('my-documents-content');
            const pdfViewerModalEl = document.getElementById('pdfViewerModal');
            const pdfIframe = document.getElementById('pdf-iframe');
            const pdfLoaderOverlay = document.getElementById('pdf-loader-overlay');
            const pdfProgressBar = document.getElementById('pdf-progress-bar');
            const pdfProgressText = document.getElementById('pdf-progress-text');
            const pdfCustomHeader = document.getElementById('pdf-viewer-custom-header');
            const pdfTitlePlaceholder = document.getElementById('pdf-viewer-title-placeholder');
            const savedDocsPaginationContainer = document.getElementById('saved-documents-pagination');
            
            const deleteConfirmModalEl = document.getElementById('deleteConfirmModal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const deleteConfirmModal = new bootstrap.Modal(deleteConfirmModalEl);


            let allSavedDocuments = [];
            let currentSavedDocsPage = 1;
            const savedDocsPerPage = 7;

            const defaultAvatarIcon = "data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='50' fill='%23E5E7EB'/%3E%3Cpath d='M66.95 66.78a25.02 25.02 0 00-33.9 0C24.4 71.3 20 79.95 20 90h60c0-10.05-4.4-18.7-13.05-23.22zM50 55c-10.33 0-18.7-8.37-18.7-18.7S39.67 17.6 50 17.6s18.7 8.37 18.7 18.7-8.37 18.7-18.7 18.7z' fill='%23A0AEC0'/%3E%3C/svg%3E";

            // ======================= HELPER FUNCTIONS =======================
            
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) return;

                let iconClass, bgClass;
                switch(type) {
                    case 'danger': iconClass = 'fa-times-circle'; bgClass = 'text-bg-danger'; break;
                    case 'info': iconClass = 'fa-info-circle'; bgClass = 'text-bg-info'; break;
                    default: iconClass = 'fa-check-circle'; bgClass = 'text-bg-success';
                }
                
                const toastId = 'toast-' + Math.random().toString(36).substring(2, 9);
                const toastHTML = `
                    <div id="${toastId}" class="toast align-items-center ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body"><i class="fas ${iconClass} me-2"></i>${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>`;
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
                toast.show();
                toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
            }
            
            function updateHeaderUI(user) {
                if (!authContainer) return;
                if (user) {
                    const fullName = user.user_metadata?.full_name || user.email;
                    const avatarUrl = user.user_metadata?.avatar_url || defaultAvatarIcon;
                    authContainer.innerHTML = `
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" 
                               style="background-color: transparent; padding: 0.1rem 0.5rem; margin:0; border-radius: 50px;">
                                <img src="${avatarUrl}" alt="${fullName}" class="user-avatar">
                                <span class="gradient-text fw-bold">${fullName}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item active" href="infor-user.html"><i class="fas fa-user-circle fa-fw"></i> Hồ sơ của tôi</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="header-logout-button"><i class="fas fa-sign-out-alt fa-fw"></i> Đăng xuất</a></li>
                            </ul>
                        </div>`;
                    document.getElementById('header-logout-button').addEventListener('click', handleLogout);
                    updateAllNotifications(); // Cập nhật tất cả thông báo
                } else {
                    const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                    window.location.replace(baseUrl + 'index.html');
                }
            }
            
            async function updateProfilePageUI(user) {
                if (!user) return;
                const metadata = user.user_metadata;
                profileAvatarImg.src = metadata?.avatar_url || defaultAvatarIcon;
                profileUserName.textContent = metadata?.full_name || 'Chưa có tên';
                profileUserEmail.textContent = user.email;
                profileFullNameInput.value = metadata?.full_name || '';
                
                const { data: profileData, error } = await supabase.from('profiles').select('phone_number').eq('id', user.id).single();
                
                if (profileData && profileData.phone_number) {
                    profilePhoneInput.value = profileData.phone_number;
                    profilePhoneInput.disabled = true;
                } else {
                    profilePhoneInput.value = '';
                    profilePhoneInput.disabled = false;
                    if(error) console.error("Lỗi khi lấy hồ sơ:", error.message);
                }
                profileEmailInput.value = user.email;
            }
            
            function setupPasswordToggles() {
                document.querySelectorAll('.password-toggle-icon').forEach(icon => {
                    icon.addEventListener('click', function() {
                        const targetId = this.dataset.target;
                        const passwordInput = document.getElementById(targetId);
                        if (passwordInput) {
                            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                            passwordInput.setAttribute('type', type);
                            this.classList.toggle('fa-eye');
                            this.classList.toggle('fa-eye-slash');
                        }
                    });
                });
            }

            // ======================= AUTHENTICATION & DATA HANDLING =======================
            
            // SỬA: Cập nhật hàm đăng xuất
            async function handleLogout(event) {
                if(event) event.preventDefault();
                showToast('Đang đăng xuất, vui lòng chờ...', 'info');
                await leavePresenceChannel(); // Rời kênh online trước
                const { error } = await supabase.auth.signOut();
                if (error) {
                    showToast(`Lỗi khi đăng xuất: ${error.message}`, 'danger');
                }
                // onAuthStateChange sẽ tự động xử lý chuyển hướng
            }

            async function handleUpdateProfile(e) {
                e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang lưu...`;

                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: updatedUser, error: userError } = await supabase.auth.updateUser({ 
                    data: { full_name: profileFullNameInput.value.trim() } 
                });

                if (userError) {
                    showToast(`Lỗi cập nhật tên: ${userError.message}`, 'danger');
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                    return;
                }
                
                const profileUpdateData = { full_name: updatedUser.user.user_metadata.full_name };
                if (!profilePhoneInput.disabled && profilePhoneInput.value.trim()) {
                    profileUpdateData.phone_number = profilePhoneInput.value.trim();
                }

                const { error: profileError } = await supabase.from('profiles').update(profileUpdateData).eq('id', user.id);
                
                if (profileError) {
                    showToast(`Lỗi cập nhật hồ sơ: ${profileError.message}`, 'danger');
                } else {
                    showToast('Cập nhật thông tin thành công!', 'success');
                    await updateHeaderUI(updatedUser.user);
                    await updateProfilePageUI(updatedUser.user);
                }

                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }

            async function handleUpdatePassword(e) {
                e.preventDefault();
                const newPassword = document.getElementById('newPassword').value;
                if (!newPassword) {
                    showToast('Vui lòng nhập mật khẩu mới.', 'info');
                    return;
                }
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                if (newPassword.length < 6) { showToast('Mật khẩu mới phải có ít nhất 6 ký tự.', 'danger'); return; }
                if (newPassword !== confirmNewPassword) { showToast('Mật khẩu mới và xác nhận không khớp.', 'danger'); return; }

                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang cập nhật...`;
                
                const { error } = await supabase.auth.updateUser({ password: newPassword });

                if (error) {
                    showToast(`Lỗi cập nhật mật khẩu: ${error.message}`, 'danger');
                } else {
                    showToast('Cập nhật mật khẩu thành công!', 'success');
                    e.target.reset();
                }
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
            
            async function handleSaveAvatar() {
                if (!selectedAvatarUrl) { showToast('Bạn chưa chọn ảnh đại diện nào.', 'info'); return; }
                showToast('Đang cập nhật ảnh đại diện...', 'info');
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;
                const { data: updatedUser, error: userUpdateError } = await supabase.auth.updateUser({ data: { avatar_url: selectedAvatarUrl } });
                if (userUpdateError) { showToast(`Lỗi cập nhật tài khoản: ${userUpdateError.message}`, 'danger'); return; }
                const { error: profileUpdateError } = await supabase.from('profiles').update({ avatar_url: selectedAvatarUrl }).eq('id', user.id);
                if (profileUpdateError) {
                    showToast(`Lỗi cập nhật hồ sơ: ${profileUpdateError.message}`, 'danger');
                } else {
                    showToast('Cập nhật ảnh đại diện thành công!', 'success');
                    updateHeaderUI(updatedUser.user);
                    updateProfilePageUI(updatedUser.user);
                    const modalInstance = bootstrap.Modal.getInstance(avatarSelectionModalEl);
                    if (modalInstance) modalInstance.hide();
                }
            }
            
            async function loadWebsiteSettings() {
                const { data, error } = await supabase.from('website_settings').select('header_logo_url, footer_logo_url').eq('id', 1).single();
                if (error) { console.error('Lỗi khi tải cài đặt website:', error.message); return; }
                if (data) {
                    const headerLogo = document.getElementById('header-logo');
                    const footerLogo = document.getElementById('footer-logo-img');
                    if (headerLogo && data.header_logo_url) headerLogo.src = data.header_logo_url;
                    if (footerLogo && data.footer_logo_url) footerLogo.src = data.footer_logo_url;
                }
            }
            
            function populateAvatarModal() {
                if (!avatarGrid) return;
                avatarGrid.innerHTML = '';
                const avatarStyles = ['adventurer', 'avataaars', 'big-ears', 'big-smile', 'bottts', 'croodles', 'fun-emoji', 'icons', 'identicon', 'initials', 'lorelei', 'micah', 'miniavs', 'open-peeps', 'personas', 'pixel-art'];
                const avatarSeeds = ['Felix', 'Milo', 'Luna', 'Simba', 'Zoe', 'Leo', 'Cleo', 'Rocky', 'Coco', 'Toby', 'Penny', 'Gizmo', 'Oreo', 'Tiger', 'Shadow', 'Bella'];
                avatarSeeds.forEach(seed => {
                    const style = avatarStyles[Math.floor(Math.random() * avatarStyles.length)];
                    const avatarUrl = `https://api.dicebear.com/8.x/${style}/svg?seed=${seed}&radius=50`;
                    const img = document.createElement('img');
                    img.src = avatarUrl;
                    img.alt = `Avatar ${seed}`;
                    img.className = 'avatar-option';
                    img.dataset.avatarUrl = avatarUrl;
                    img.addEventListener('click', () => {
                        const currentSelected = avatarGrid.querySelector('.selected');
                        if (currentSelected) currentSelected.classList.remove('selected');
                        img.classList.add('selected');
                        selectedAvatarUrl = img.dataset.avatarUrl;
                    });
                    avatarGrid.appendChild(img);
                });
            }

            async function loadSavedDocuments() {
                if (!myDocumentsContent) return;
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data, error } = await supabase
                    .from('saved_documents')
                    .select(`id, saved_at, documents (id, title, author_name, image_url, document_url)`)
                    .eq('user_id', user.id)
                    .order('saved_at', { ascending: false });

                if (error) {
                    console.error("Lỗi tải tài liệu đã lưu:", error);
                    myDocumentsContent.innerHTML = `<p class="text-danger">Đã xảy ra lỗi khi tải tài liệu của bạn.</p>`;
                    return;
                }

                allSavedDocuments = data || [];
                
                const totalPages = Math.ceil(allSavedDocuments.length / savedDocsPerPage);
                if (currentSavedDocsPage > totalPages && totalPages > 0) {
                    currentSavedDocsPage = totalPages;
                }

                if (allSavedDocuments.length === 0) {
                    myDocumentsContent.innerHTML = `
                        <div class="placeholder-content">
                            <div class="icon"><i class="fas fa-folder-open"></i></div>
                            <h6>Bạn chưa có tài liệu nào</h6>
                            <p>Các tài liệu bạn đã lưu sẽ được hiển thị tại đây.</p>
                            <a href="document.html" class="btn btn-gradient mt-2">Khám phá tài liệu</a>
                        </div>`;
                    savedDocsPaginationContainer.innerHTML = ''; 
                } else {
                    updateSavedDocumentsDisplay();
                }
            }

            function renderSavedDocuments(itemsToRender, page, itemsPerPage) {
                if (!myDocumentsContent) return;
                const listHtml = itemsToRender.map((item, index) => {
                    const doc = item.documents;
                    if (!doc) return '';
                    const stt = (page - 1) * itemsPerPage + index + 1;
                    return `
                        <li class="saved-document-item">
                            <a href="#" class="saved-document-link" 
                                data-doc-url="${doc.document_url || '#'}" 
                                data-doc-title="${doc.title || 'Tài liệu'}" 
                                data-bs-toggle="modal" 
                                data-bs-target="#pdfViewerModal">
                                <span class="saved-document-stt">${stt}.</span>
                                <img src="${doc.image_url || 'https://placehold.co/80x80/cccccc/ffffff?text=Doc'}" alt="${doc.title}" class="saved-document-thumbnail">
                                <div class="saved-document-info">
                                    <h6>${doc.title}</h6>
                                    <p>Tác giả: ${doc.author_name || 'Không rõ'}</p>
                                </div>
                            </a>
                            <button class="btn btn-sm btn-outline-danger btn-remove-saved ms-auto" data-saved-id="${item.id}" title="Xóa khỏi sổ tay">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </li>`;
                }).join('');
                myDocumentsContent.innerHTML = `<ul class="saved-document-list">${listHtml}</ul>`;
                myDocumentsContent.querySelectorAll('.btn-remove-saved').forEach(button => {
                    button.addEventListener('click', handleRemoveSavedDocument);
                });
            }

            function handleRemoveSavedDocument(event) {
                event.stopPropagation();
                const button = event.currentTarget;
                const savedId = button.dataset.savedId;
                confirmDeleteBtn.dataset.savedId = savedId;
                deleteConfirmModal.show();
            }
            
            function setupSavedDocsPagination(items, wrapper, rows_per_page) {
                wrapper.innerHTML = "";
                let page_count = Math.ceil(items.length / rows_per_page);
                if (page_count <= 1) {
                    wrapper.parentElement.style.display = 'none';
                    return;
                }
                wrapper.parentElement.style.display = 'flex';

                const createPageItem = (page, isActive = false, isDisabled = false, text = null) => {
                    const li = document.createElement('li');
                    li.classList.add('page-item');
                    if (isActive) li.classList.add('active');
                    if (isDisabled) li.classList.add('disabled');
                    const a = document.createElement('a');
                    a.classList.add('page-link');
                    a.href = '#';
                    a.innerHTML = text || page;
                    li.appendChild(a);
                    if (!isDisabled) {
                        a.addEventListener('click', (e) => {
                            e.preventDefault();
                            if (page === '&laquo;') {
                                if (currentSavedDocsPage > 1) currentSavedDocsPage--;
                            } else if (page === '&raquo;') {
                                if (currentSavedDocsPage < page_count) currentSavedDocsPage++;
                            } else {
                                currentSavedDocsPage = page;
                            }
                            updateSavedDocumentsDisplay();
                        });
                    }
                    return li;
                };
                
                wrapper.appendChild(createPageItem('&laquo;', false, currentSavedDocsPage === 1));
                
                const delta = 1;
                let lastPage = 0;
                for (let i = 1; i <= page_count; i++) {
                    const isFirstPage = i === 1;
                    const isLastPage = i === page_count;
                    const isInRange = i >= currentSavedDocsPage - delta && i <= currentSavedDocsPage + delta;

                    if (isFirstPage || isLastPage || isInRange) {
                        if (lastPage && i - lastPage > 1) {
                            wrapper.appendChild(createPageItem('...', false, true));
                        }
                        wrapper.appendChild(createPageItem(i, i === currentSavedDocsPage));
                        lastPage = i;
                    }
                }
                wrapper.appendChild(createPageItem('&raquo;', false, currentSavedDocsPage === page_count));
            }

            function displaySavedDocsPage(items, wrapper, rows_per_page, page) {
                let start = rows_per_page * (page - 1);
                let end = start + rows_per_page;
                let paginatedItems = items.slice(start, end);
                renderSavedDocuments(paginatedItems, page, rows_per_page);
            }

            function updateSavedDocumentsDisplay() {
                displaySavedDocsPage(allSavedDocuments, myDocumentsContent, savedDocsPerPage, currentSavedDocsPage);
                setupSavedDocsPagination(allSavedDocuments, savedDocsPaginationContainer, savedDocsPerPage);
            }

            // ======================= UI INTERACTIONS =======================

            function handleNavClick(e) {
                e.preventDefault();
                const link = e.target.closest('.nav-link');
                if (!link || link.id === 'profile-logout-button') return;
                const currentActive = profileNavMenu.querySelector('.nav-link.active');
                if (currentActive) currentActive.classList.remove('active');
                link.classList.add('active');
                contentPanels.forEach(panel => panel.classList.remove('active'));
                const targetPanelId = link.dataset.target;
                const targetPanel = document.getElementById(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.add('active');
                    if (targetPanelId === 'my-documents-panel') {
                        clearAllNotifications();
                        loadSavedDocuments();
                    }
                }
            }
            
            if (pdfViewerModalEl) {
                pdfViewerModalEl.addEventListener('show.bs.modal', function(event) {
                    const triggerElement = event.relatedTarget;
                    const docUrl = triggerElement.dataset.docUrl;
                    const docTitle = triggerElement.dataset.docTitle || 'Tài liệu';

                    pdfLoaderOverlay.classList.remove('hidden');
                    pdfIframe.classList.remove('loaded');
                    pdfIframe.src = '';
                    pdfCustomHeader.style.opacity = '0';
                    pdfCustomHeader.style.visibility = 'hidden';
                    pdfProgressBar.style.width = '0%';
                    pdfProgressBar.setAttribute('aria-valuenow', '0');
                    pdfProgressText.textContent = 'Đang tải tài liệu: 0%';
                    pdfTitlePlaceholder.textContent = docTitle;
                    
                    if (!docUrl || docUrl === '#') {
                        pdfProgressText.textContent = 'Lỗi: Không tìm thấy đường dẫn tài liệu.';
                        return;
                    }

                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += Math.floor(Math.random() * 5) + 1;
                        if (progress > 100) progress = 100;
                        pdfProgressBar.style.width = progress + '%';
                        pdfProgressBar.setAttribute('aria-valuenow', progress);
                        pdfProgressText.textContent = `Đang tải tài liệu: ${progress}%`;
                        if (progress === 100) {
                            clearInterval(interval);
                            setTimeout(() => {
                                pdfLoaderOverlay.classList.add('hidden');
                                pdfIframe.classList.add('loaded');
                                pdfCustomHeader.style.opacity = '1';
                                pdfCustomHeader.style.visibility = 'visible';
                            }, 300);
                        }
                    }, 100);
                    const embedUrl = docUrl.replace("/view", "/preview");
                    pdfIframe.src = embedUrl;
                });
                pdfViewerModalEl.addEventListener('hidden.bs.modal', function() {
                    pdfIframe.src = '';
                    pdfIframe.classList.remove('loaded');
                    pdfCustomHeader.style.opacity = '0';
                    pdfCustomHeader.style.visibility = 'hidden';
                });
            }

            // ======================= INITIALIZATION =======================
            
            // SỬA: Sử dụng onAuthStateChange để khởi tạo trang
            supabase.auth.onAuthStateChange(async (event, session) => {
                const user = session ? session.user : null;

                if (user) {
                    // Người dùng đã đăng nhập
                    updateHeaderUI(user);
                    updateProfilePageUI(user);
                    initializeRealtimePresence(user);

                    // Chỉ chạy các hàm thiết lập một lần
                    if (!document.body.dataset.initialized) {
                        document.body.dataset.initialized = "true";
                        
                        loadWebsiteSettings();
                        updateAllNotifications();
                        populateAvatarModal();
                        setupPasswordToggles();

                        if (profileLogoutButton) profileLogoutButton.addEventListener('click', handleLogout);
                        if (updateProfileForm) updateProfileForm.addEventListener('submit', handleUpdateProfile);
                        if (updatePasswordForm) updatePasswordForm.addEventListener('submit', handleUpdatePassword);
                        if (profileNavMenu) profileNavMenu.addEventListener('click', handleNavClick);
                        if (saveAvatarButton) saveAvatarButton.addEventListener('click', handleSaveAvatar);
                        
                        confirmDeleteBtn.addEventListener('click', async function() {
                            const savedId = this.dataset.savedId;
                            if (!savedId) return;

                            this.disabled = true;
                            this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xóa...`;

                            const { error } = await supabase.from('saved_documents').delete().eq('id', savedId);
                            
                            this.disabled = false;
                            this.innerHTML = 'Xóa';

                            deleteConfirmModal.hide();

                            if (error) {
                                showToast(`Lỗi khi xóa: ${error.message}`, 'danger');
                            } else {
                                showToast('Đã xóa tài liệu khỏi sổ tay.', 'success');
                                setNotificationCount(getNotificationCount() - 1);
                                updateAllNotifications();
                                await loadSavedDocuments();
                            }
                        });
                    }
                } else {
                    // Người dùng đã đăng xuất hoặc chưa đăng nhập
                    leavePresenceChannel();
                    const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                    window.location.replace(baseUrl + 'index.html');
                }
            });
        });
    </script>
</body>

</html>

