<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VietTarot - Bài Giảng</title>

    <link rel="icon" type="image/png" sizes="16x16" href="image/iconlogo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="image/iconlogo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="image/iconlogo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="components.js"></script>

    <style>
        #header-placeholder { position: sticky; top: 0; z-index: 1000; }
        body { background-color: var(--bg-off-white); color: var(--text-primary); display: flex; flex-direction: column; min-height: 100vh; }
        .py-5 { margin-top: 7rem; }
        main { flex-grow: 1; }
        .lecture-wrapper { background-color: var(--bg-white); border-radius: 1rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08); padding: 2rem; border: 1px solid var(--border-color); }
        @media (min-width: 768px) { .lecture-wrapper { padding: 3rem; } }
        .lecture-header h1, .lecture-header h2 { font-weight: 700; color: var(--text-primary); }
        .lecture-header p { color: var(--text-secondary); font-size: 1.1rem; }
        
        /* CSS cho Cấp 1: Chủ đề chính */
        .main-category-card { border: 2px solid var(--border-color); border-radius: 1rem; padding: 2rem 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease; height: 100%; }
        .main-category-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); border-color: var(--primary-blue); }
        .main-category-card i { font-size: 3rem; margin-bottom: 1rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .main-category-card h3 { font-weight: 600; color: var(--text-primary); }

        /* CSS cho Cấp 2: Lưới khóa học */
        .course-grid-card { display: flex; flex-direction: column; width: 100%; min-height: 230px; border-radius: 1rem; padding: 1.5rem; color: white; text-decoration: none; transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; overflow: hidden; position: relative; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .course-grid-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .course-grid-card-content { flex-grow: 1; }
        .course-grid-card-title { font-weight: 700; font-size: 1.5rem; margin-bottom: 0.5rem; line-height: 1.3; }
        .course-grid-card-subtitle { font-size: 0.95rem; opacity: 0.9; font-weight: 500; }
        .course-grid-card-footer { display: flex; align-items: center; gap: 1.25rem; font-size: 0.9rem; opacity: 0.95; margin-top: 1.5rem; padding-top: 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.25); }

        /* CSS cho Cấp 3: Giao diện học */
        .lecture-sidebar { background-color: var(--bg-off-white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--border-color); max-height: 80vh; overflow-y: auto; }
        @media (max-width: 991.98px) { .lecture-sidebar { margin-bottom: 2rem; max-height: 400px; } }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0; }
        #video-lock-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 18, 41, 0.8); z-index: 10; display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; color: white; padding: 2rem; }
        #video-lock-overlay i { font-size: 3rem; margin-bottom: 1rem; }
        .lecture-playlist { list-style: none; padding: 0; margin: 0; }
        .playlist-item { display: flex; align-items: flex-start; gap: 1rem; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.3s; border-bottom: 1px solid var(--border-color); }
        .playlist-item:last-child { border-bottom: none; }
        .playlist-item:hover { background-color: #e9ecef; }
        .playlist-item.active { background-color: var(--primary-blue); color: white; }
        .playlist-item.active .playlist-item-title, .playlist-item.active .playlist-item-duration { color: white !important; }
        .playlist-item-index { font-weight: 600; font-size: 1.1rem; }
        .lecture-navigation .btn { padding: 0.75rem 2rem; font-size: 1rem; }
    </style>
</head>

<body>
    <div id="header-placeholder"></div>
    
    <main class="py-5">
        <div class="container">
            <div class="lecture-wrapper">
                
                <div id="main-category-screen">
                     <div class="lecture-header text-center mb-5">
                        <h1 class="mb-3">Khám Phá Tri Thức</h1>
                        <p class="lead mb-0">Hãy chọn lĩnh vực bạn quan tâm để bắt đầu.</p>
                    </div>
                    <div class="row g-4 justify-content-center" id="main-category-container">
                        </div>
                </div>

                <div id="course-screen" class="d-none">
                    <div class="lecture-header d-flex justify-content-between align-items-center mb-5 flex-wrap">
                        <div>
                            <h1 id="course-list-title" class="mb-1">Chọn khóa học</h1>
                            <p class="lead mb-0">Khám phá các khóa học chi tiết trong chủ đề này.</p>
                        </div>
                        <button id="back-to-main-categories-btn" class="btn btn-gradient mt-3 mt-md-0"><i class="fas fa-arrow-left me-2"></i>Chọn chủ đề khác</button>
                    </div>
                    <div class="row" id="course-container">
                        </div>
                </div>

                <div id="lecture-detail-screen" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h1 id="lecture-title" class="h2 mb-0"></h1>
                        <button id="back-to-courses-btn" class="btn btn-gradient mt-3 mt-md-0"><i class="fas fa-arrow-left me-2"></i>Danh sách khóa học</button>
                    </div>
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="video-container mb-4">
                                <div id="video-lock-overlay" class="d-none"></div>
                                <div id="video-player-container"></div>
                            </div>
                            <div id="lecture-content"></div>
                        </div>
                        <div class="col-lg-4">
                            <h4 class="mb-3">Danh sách phát</h4>
                            <div class="lecture-sidebar">
                                <ul id="lecture-playlist" class="lecture-playlist"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="lecture-navigation d-flex justify-content-between mt-4 pt-3 border-top">
                        <button id="prev-lecture-btn" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i> Bài trước</button>
                        <button id="next-lecture-btn" class="btn btn-gradient">Bài tiếp theo <i class="fas fa-arrow-right ms-2"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>
    <div id="modals-placeholder"></div>
    <div id="floating-widgets-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Đợi 100ms để đảm bảo `components.js` đã kịp khởi tạo Supabase
            setTimeout(() => {
                // KIỂM TRA SUPABASE CLIENT
                if (!window.viettarotApp || !window.viettarotApp.supabase) {
                    console.error('Lỗi: Supabase client không tìm thấy. Hãy đảm bảo components.js được tải và khởi tạo trước script này.');
                    document.getElementById('main-category-container').innerHTML = `<p class="text-center text-danger">Không thể tải dữ liệu. Vui lòng thử lại sau.</p>`;
                    return;
                }
                // Gán client Supabase vào biến cục bộ
                const supabase = window.viettarotApp.supabase;
                
                // === KHAI BÁO BIẾN ===
                let currentUserRole = 'guest'; // Mặc định là 'guest', sẽ được cập nhật sau
                let allCourses = [];
                let currentCategory = null;
                let currentCourseLectures = [];
                let currentLectureIndex = -1;

                // === DOM ELEMENTS ===
                const mainCategoryScreen = document.getElementById('main-category-screen');
                const courseScreen = document.getElementById('course-screen');
                const lectureDetailScreen = document.getElementById('lecture-detail-screen');
                const mainCategoryContainer = document.getElementById('main-category-container');
                const courseContainer = document.getElementById('course-container');

                // === CÁC HÀM TRUY VẤN CSDL (ĐÃ CẬP NHẬT) ===

                /**
                 * SỬA ĐỔI: Lấy vai trò (role) của người dùng hiện tại từ bảng 'profiles'
                 */
                async function fetchCurrentUserRole() {
                    try {
                        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                        if (sessionError) throw sessionError;
                        if (!session) return 'guest'; // Người dùng chưa đăng nhập

                        const { data: profile, error: profileError } = await supabase
                            .from('profiles')
                            .select('role')
                            .eq('id', session.user.id)
                            .single();

                        if (profileError) throw profileError;
                        
                        return profile ? profile.role : 'user'; // Trả về role (vd: 'user', 'membership', 'student', 'admin')
                    } catch (error) {
                        console.error('Error fetching current user role:', error.message);
                        return 'guest'; // An toàn trả về 'guest' nếu có lỗi
                    }
                }

                /**
                 * SỬA ĐỔI: Lấy danh sách chủ đề chính từ CSDL
                 */
                async function fetchMainCategories() {
                    const { data, error } = await supabase
                        .from('lecture_categories')
                        .select('*')
                        .order('display_order', { ascending: true });

                    if (error) {
                        console.error('Error fetching main categories:', error);
                        return [];
                    }
                    return data;
                }

                /**
                 * SỬA ĐỔI: Lấy TẤT CẢ các khóa học từ CSDL
                 */
                async function fetchCourses() {
                    const { data, error } = await supabase
                        .from('courses')
                        .select('*')
                        .order('display_order', { ascending: true });
                        
                    if (error) {
                        console.error('Error fetching courses:', error);
                        return [];
                    }
                    return data;
                }

                /**
                 * SỬA ĐỔI: Lấy các bài giảng cho một khóa học cụ thể
                 */
                async function fetchLecturesForTopic(courseId) {
                    console.log(`Fetching SUPABASE lectures for course ID: ${courseId}`);
                    const { data, error } = await supabase
                        .from('lectures')
                        .select('*')
                        .eq('course_id', courseId)
                        .order('display_order', { ascending: true });

                    if (error) {
                        console.error(`Error fetching lectures for course ${courseId}:`, error);
                        return [];
                    }
                    return data;
                }

                // === RENDER FUNCTIONS (Logic không đổi, chỉ nhận dữ liệu từ CSDL) ===
                async function renderMainCategories() {
                    mainCategoryContainer.innerHTML = `<div class="col-12 text-center"><div class="spinner-border text-primary"></div></div>`;
                    const categories = await fetchMainCategories();
                    mainCategoryContainer.innerHTML = '';
                    if (categories.length === 0) {
                         mainCategoryContainer.innerHTML = `<p class="text-center text-secondary">Chưa có chủ đề nào.</p>`;
                         return;
                    }
                    categories.forEach(cat => {
                        mainCategoryContainer.innerHTML += `
                            <div class="col-md-4 col-sm-6">
                                <div class="main-category-card" data-category-id="${cat.id}" data-category-name="${cat.name}">
                                    <i class="fas ${cat.icon_class || 'fa-star'}"></i>
                                    <h3>${cat.name}</h3>
                                </div>
                            </div>`;
                    });
                }

                async function renderCoursesForCategory(categoryId, categoryName) {
    courseContainer.innerHTML = `<div class="col-12 text-center"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div></div>`;
    document.getElementById('course-list-title').innerText = `Chủ đề: ${categoryName}`;
    
    const coursesForCategory = allCourses.filter(c => c.category_id === categoryId);
    
    if (coursesForCategory.length === 0) {
        courseContainer.innerHTML = `<p class="text-center text-secondary">Chưa có khóa học nào trong chủ đề này.</p>`;
        return;
    }

    const cardGradients = ['linear-gradient(to top right, #6a11cb 0%, #2575fc 100%)', 'linear-gradient(to top right, #f857a6 0%, #ff5858 100%)', 'linear-gradient(to top right, #4facfe 0%, #00f2fe 100%)', 'linear-gradient(to top right, #43e97b 0%, #38f9d7 100%)'];
    
    const lectureDataPromises = coursesForCategory.map(course => fetchLecturesForTopic(course.id));
    const allCourseLectures = await Promise.all(lectureDataPromises);

    courseContainer.innerHTML = '';
    coursesForCategory.forEach((course, index) => {
        const lectures = allCourseLectures[index] || [];
        const lectureCount = lectures.length;
        const totalDuration = lectures.reduce((sum, lec) => sum + (lec.duration_minutes || 0), 0);
        const durationString = totalDuration > 0 ? `${Math.floor(totalDuration/60)}h${totalDuration%60}p` : '';
        
        // Determine the access type for the entire course
        const courseAccessType = lectures.every(lec => lec.access_type === 'free') ? 'free' : 'paid';

        courseContainer.innerHTML += `
            <div class="col-xl-3 col-lg-4 col-md-6 col-12 mb-4 d-flex">
                <div class="course-grid-card" data-course-id="${course.id}" data-course-title="${course.title}" data-access-type="${courseAccessType}" style="background: ${cardGradients[index % cardGradients.length]};">
                    <div class="course-grid-card-content">
                        <h3 class="course-grid-card-title">${course.title}</h3>
                        <p class="course-grid-card-subtitle">${course.description || ''}</p>
                    </div>
                    <div class="course-grid-card-footer">
                        ${lectureCount > 0 ? `<span><i class="fas fa-book-open me-2"></i>${lectureCount} bài</span>` : '<span><i class="fas fa-hourglass-half me-2"></i>Sắp ra mắt</span>'}
                        ${durationString ? `<span><i class="fas fa-clock me-2"></i>${durationString}</span>` : ''}
                    </div>
                </div>
            </div>`;
    });
}

                function viewLecture(index, lectureList) {
    if (!lectureList || lectureList.length === 0 || index < 0 || index >= lectureList.length) return;

    const lecture = lectureList[index];
    const hasAccess = () => (
        currentUserRole === 'admin' ||
        currentUserRole === 'student' ||
        lecture.access_type === 'free' ||
        (currentUserRole === 'membership' && lecture.access_type === 'membership')
    );

    if (!hasAccess() && currentUserRole === 'guest') {
        const notificationModalEl = document.getElementById('notificationModal');
        document.getElementById('notificationModalLabel').innerText = 'Yêu Cầu Đăng Nhập';
        document.getElementById('notificationModalBody').innerText = 'Bạn cần đăng nhập để xem nội dung này.';
        const notificationModal = bootstrap.Modal.getOrCreateInstance(notificationModalEl);
        notificationModal.show();

        const modalFooter = notificationModalEl.querySelector('.modal-footer');
        if (modalFooter) {
            modalFooter.innerHTML = '<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Đăng nhập</button>';
        }
        return;
    }

    currentLectureIndex = index;
    document.getElementById('lecture-title').textContent = lecture.title;
    document.getElementById('lecture-content').innerHTML = lecture.content || '<p>Nội dung đang được cập nhật...</p>';
    renderVideoPlayer(lecture);
    renderPlaylist(lectureList);
    updateNavigationButtons(lectureList);
}

                function renderVideoPlayer(lecture) {
    const videoContainer = document.getElementById('video-player-container');
    const lockOverlay = document.getElementById('video-lock-overlay');

    const hasAccess = () => (
        currentUserRole === 'admin' ||
        currentUserRole === 'student' ||
        lecture.access_type === 'free' ||
        (currentUserRole === 'membership' && lecture.access_type === 'membership')
    );

    if (hasAccess()) {
        lockOverlay.classList.add('d-none');
        if (lecture.video_url) {
            let embedUrl = '';
            if (lecture.video_url.includes('youtube.com') || lecture.video_url.includes('youtu.be')) {
                const videoIdMatch = lecture.video_url.match(/(?:v=|\/|embed\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                if (videoIdMatch) embedUrl = `https://www.youtube.com/embed/${videoIdMatch[1]}`;
            }
            if (embedUrl) {
                videoContainer.innerHTML = `<iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            } else {
                videoContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center bg-dark text-white h-100 p-3 text-center" style="border-radius: 0.75rem;">Định dạng video không hợp lệ.</div>';
            }
        } else {
            videoContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center bg-dark text-white h-100 p-3 text-center" style="border-radius: 0.75rem;">Không có video cho bài giảng này.</div>';
        }
    } else {
        lockOverlay.classList.remove('d-none');
        if (currentUserRole === 'guest') {
            lockOverlay.innerHTML = `<i class="fas fa-lock"></i><h4>Nội dung bị khóa</h4><p class="mb-3">Bạn cần <strong>đăng nhập</strong> để xem nội dung này.</p><button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#loginModal">Đăng nhập ngay</button>`;
        } else {
            let requiredRole = 'Học Viên';
            if (lecture.access_type === 'membership') {
                requiredRole = 'Member';
            }
            lockOverlay.innerHTML = `<i class="fas fa-lock"></i><h4>Nội dung bị khóa</h4><p class="mb-3">Bạn cần là <strong>${requiredRole}</strong> để xem nội dung này.</p><button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#upgradeModal">Nâng cấp ngay</button>`;
        }
        videoContainer.innerHTML = '';
    }
}

function renderPlaylist(lectureList) {
    const playlistEl = document.getElementById('lecture-playlist');
    playlistEl.innerHTML = '';
    lectureList.forEach((lec, index) => {
        const hasAccess = () => (
            currentUserRole === 'admin' ||
            currentUserRole === 'student' ||
            lec.access_type === 'free' ||
            (currentUserRole === 'membership' && lec.access_type === 'membership')
        );
        const lockIcon = hasAccess() ? '' : '<i class="fas fa-lock me-2 text-warning"></i>';
        const item = document.createElement('li');
        item.className = `playlist-item ${index === currentLectureIndex ? 'active' : ''}`;
        if (hasAccess()) {
            item.dataset.index = index;
        } else {
            item.style.cursor = 'not-allowed';
        }
        item.innerHTML = `
            <span class="playlist-item-index">${String(index + 1).padStart(2, '0')}</span>
            <div class="playlist-item-content">
                <p class="playlist-item-title mb-0">${lockIcon}${lec.title}</p>
                ${lec.duration_minutes ? `<small class="playlist-item-duration">${lec.duration_minutes} phút</small>`: ''}
            </div>
        `;
        playlistEl.appendChild(item);
    });
}
                
                function updateNavigationButtons(lectureList) {
                    document.getElementById('prev-lecture-btn').disabled = currentLectureIndex === 0;
                    document.getElementById('next-lecture-btn').disabled = currentLectureIndex >= lectureList.length - 1;
                }

                // === EVENT LISTENERS & FLOW CONTROL (Không đổi) ===
                function setupEventListeners() {
                    document.body.addEventListener('click', async (e) => {
                        // Cấp 1 -> Cấp 2
                        const categoryCard = e.target.closest('.main-category-card');
                        if (categoryCard) {
                            currentCategory = { id: categoryCard.dataset.categoryId, name: categoryCard.dataset.categoryName };
                            mainCategoryScreen.classList.add('d-none');
                            courseScreen.classList.remove('d-none');
                            await renderCoursesForCategory(currentCategory.id, currentCategory.name);
                        }

                        // Cấp 2 -> Cấp 3
                        const courseCard = e.target.closest('.course-grid-card');
if (courseCard) {
    const courseId = courseCard.dataset.courseId;
    const courseAccessType = courseCard.dataset.accessType;

    if (currentUserRole === 'guest' && courseAccessType !== 'free') {
        const notificationModalEl = document.getElementById('notificationModal');
        if (notificationModalEl) {
            const notificationModal = bootstrap.Modal.getOrCreateInstance(notificationModalEl);
            document.getElementById('notificationModalLabel').innerText = 'Yêu Cầu Đăng Nhập';
            document.getElementById('notificationModalBody').innerText = 'Bạn cần đăng nhập để xem nội dung này.';
            const modalFooter = notificationModalEl.querySelector('.modal-footer');
            if (modalFooter) {
                modalFooter.innerHTML = '<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Đăng nhập</button>';
            }
            notificationModal.show();
        }
    } else {
        currentCourseLectures = await fetchLecturesForTopic(courseId);
        if (currentCourseLectures.length > 0) {
            courseScreen.classList.add('d-none');
            lectureDetailScreen.classList.remove('d-none');
            viewLecture(0, currentCourseLectures);
        } else {
            const notificationModalEl = document.getElementById('notificationModal');
            if (notificationModalEl) {
                const notificationModal = bootstrap.Modal.getOrCreateInstance(notificationModalEl);
                document.getElementById('notificationModalLabel').innerText = 'Thông Báo';
                document.getElementById('notificationModalBody').innerText = `Khóa học "${courseCard.dataset.courseTitle}" hiện chưa có bài giảng hoặc đang được cập nhật. Vui lòng quay lại sau.`;
                const modalFooter = notificationModalEl.querySelector('.modal-footer');
                if (modalFooter) {
                    modalFooter.innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>';
                }
                notificationModal.show();
            }
        }
    }
}

                        // Quay lại: Cấp 2 -> Cấp 1
                        if (e.target.closest('#back-to-main-categories-btn')) {
                            courseScreen.classList.add('d-none');
                            mainCategoryScreen.classList.remove('d-none');
                        }

                        // Quay lại: Cấp 3 -> Cấp 2
                        if (e.target.closest('#back-to-courses-btn')) {
                            lectureDetailScreen.classList.add('d-none');
                            courseScreen.classList.remove('d-none');
                            // Tải lại các khóa học cho chủ đề hiện tại (để đảm bảo mượt mà)
                            if (currentCategory) {
                                await renderCoursesForCategory(currentCategory.id, currentCategory.name);
                            }
                        }
                        
                        // Điều hướng trong Cấp 3
                        const playlistItem = e.target.closest('.playlist-item');
if (playlistItem) {
    if (playlistItem.dataset.index) {
        viewLecture(parseInt(playlistItem.dataset.index), currentCourseLectures);
    } else {
        const notificationModalEl = document.getElementById('notificationModal');
        document.getElementById('notificationModalLabel').innerText = 'Yêu Cầu Đăng Nhập';
        document.getElementById('notificationModalBody').innerText = 'Bạn cần đăng nhập để xem nội dung này.';
        const notificationModal = bootstrap.Modal.getOrCreateInstance(notificationModalEl);
        notificationModal.show();

        const modalFooter = notificationModalEl.querySelector('.modal-footer');
        if (modalFooter) {
            modalFooter.innerHTML = '<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Đăng nhập</button>';
        }
    }
}
                        if (e.target.closest('#prev-lecture-btn') && currentLectureIndex > 0) viewLecture(currentLectureIndex - 1, currentCourseLectures);
                        if (e.target.closest('#next-lecture-btn') && currentLectureIndex < currentCourseLectures.length - 1) viewLecture(currentLectureIndex + 1, currentCourseLectures);
                    });
                }

                /**
                 * SỬA ĐỔI: Hàm main() cập nhật để lấy vai trò người dùng
                 */
                async function main() {
    // Lấy vai trò của người dùng hiện tại
    currentUserRole = await fetchCurrentUserRole();
    console.log(`Current user role: ${currentUserRole}`);

    // Tải và cache tất cả các khóa học
    allCourses = await fetchCourses();
    
    // Bắt đầu bằng cách hiển thị các chủ đề chính
    await renderMainCategories();

    // Thiết lập các trình xử lý sự kiện sau khi đã có dữ liệu
    setupEventListeners();
}

                main(); // Chạy hàm main
                
            }, 100);
        });
    </script>
</body>
</html>