<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tài Liệu - VietTarot</title>

    <link rel="icon" type="image/png" href="https://lkznteubcwladqkxyaqo.supabase.co/storage/v1/object/public/website-assets//logotab.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* CSS Preloader - Giữ lại để hiển thị ngay lập tức khi tải trang */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F8F7FA;
            color: #1A1229;
        }

        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #FFFFFF;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.75s ease, visibility 0.75s ease;
            opacity: 1;
            visibility: visible;
        }

        #preloader.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        .preloader-content {
            text-align: center;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid #4A6CF3;
            border-top-color: #9B49F2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .loading-text {
            margin-top: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
            color: #5A6474;
            letter-spacing: 1px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* CSS dành riêng cho trang tài liệu */

        #header-placeholder{
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .page-header {
            padding: 3rem 0;
            text-align: center;
            position: relative;
            background: linear-gradient(90deg, #4A6CF3 0%, #9B49F2 100%);
            margin-bottom: 100px;
            border-radius: 0 0 1.5rem 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .page-header .container {
            position: relative;
            z-index: 2;
        }

        .page-header h1 {
            font-weight: 700;
            color: #FFFFFF;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.3);
        }

        .page-header .lead {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2rem;
        }

        .header-search-form {
            position: relative;
            max-width: 700px;
            margin: 0 auto;
        }

        .header-search-form .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: #5A6474;
            font-size: 1.1rem;
            z-index: 3;
            pointer-events: none;
        }

        .header-search-form #document-search {
            width: 100%;
            padding: 1rem 8.5rem 1rem 3.5rem;
            border-radius: 50px;
            border: 1px solid #E5E7EB;
            background-color: #FFFFFF;
            box-shadow: none;
            transition: all 0.3s ease;
            color: #1A1229;
            height: 56px;
        }

        .header-search-form #document-search::placeholder {
            color: #5A6474;
        }

        .header-search-form .btn-gradient {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 50px;
            padding: 0.5rem 1.2rem;
            white-space: nowrap;
            z-index: 2;
            font-size: 0.9rem;
            box-shadow: none;
        }
        
         .header-search-form .btn-gradient:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 15px rgba(120, 73, 242, 0.4);
        }

        .document-container-wrapper {
            background-color: #FFFFFF;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
            margin-top: -80px;
            position: relative;
            z-index: 5;
        }

        .document-card {
            background-color: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 1rem;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            height: 100%;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        .document-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .document-card-thumbnail {
            display: block;
            position: relative;
            overflow: hidden;
            aspect-ratio: 4 / 3;
            background-color: #F8F7FA;
        }

        .document-card-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .document-card:hover .document-card-thumbnail img {
            transform: scale(1.05);
        }

        .document-card-category {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: linear-gradient(90deg, #4A6CF3 0%, #9B49F2 100%);
            color: #FFFFFF;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .document-card-body {
            padding: 1.25rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .document-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 0.65rem;
            min-height: 3.1em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            color: #1A1229;
        }

        .document-card-price {
            margin-bottom: 0.3rem;
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
            flex-wrap: nowrap;
        }

        .price-sale {
            font-size: 1.2rem;
            font-weight: 700;
            color: #dc3545;
        }

        .price-original {
            font-size: 0.7rem;
            color: #5A6474;
            text-decoration: line-through;
        }

        .price-free {
            font-size: 1.25rem;
            font-weight: 600;
            color: #198754;
        }

        .document-card-footer {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.4rem;
            font-size: 0.9rem;
            color: #5A6474;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            overflow: hidden;
            width: 100%;
        }

        .author-name-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-widget {
            background-color: #FFFFFF;
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            border: 1px solid #EDF2F7;
        }

        .sidebar-widget-title {
            font-weight: 600;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #E5E7EB;
            position: relative;
            display: flex;
            align-items: center;
        }

        .sidebar-widget-title::before {
            content: '';
            position: absolute;
            left: 0;
            bottom: -1px;
            width: 50px;
            height: 2px;
            background: linear-gradient(90deg, #4A6CF3 0%, #9B49F2 100%);
        }

        .sidebar-widget-title i {
            font-size: 1.1rem;
            margin-right: 0.6rem;
        }

        .sidebar-widget-title .icon-popular { color: #FF6B6B; }
        .sidebar-widget-title .icon-latest { color: #4A6CF3; }

        .widget-post-list .widget-post-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            transition: background-color 0.3s ease, transform 0.3s ease;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin: 0 -0.5rem;
        }

        .widget-post-list .widget-post-item:not(:last-child) {
            margin-bottom: 0.5rem;
        }

         .widget-post-item:hover {
            background-color: #F8F7FA;
            transform: translateX(5px);
        }

        .widget-post-thumbnail {
            flex-shrink: 0;
            width: 70px;
            height: 70px;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .widget-post-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .widget-post-content h6 {
            margin-bottom: 0.25rem;
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .widget-post-content h6 a {
            text-decoration: none;
            color: #1A1229;
            transition: color 0.3s ease;
        }

        .widget-post-content h6 a:hover {
            color: #4A6CF3;
        }

        .widget-post-meta {
            font-size: 0.8rem;
            color: #5A6474;
        }

        .no-results-message {
            background-color: #FFFFFF;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            color: #5A6474;
            border: 1px solid #E5E7EB;
        }

        .filter-btn {
            background-color: #FFFFFF;
            border: 1px solid #E5E7EB;
            color: #5A6474;
            font-weight: 500;
            border-radius: 50px;
            padding: 0.5rem 1.2rem;
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        .filter-btn:hover:not(.active) {
            transform: translateY(-2px);
            background-color: #e9e7ec;
            border-color: #d1d5db;
        }
        .filter-btn.active {
            background: linear-gradient(90deg, #4A6CF3 0%, #9B49F2 100%);
            color: #FFFFFF;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(120, 73, 242, 0.3);
        }
        
        .filter-dropdown {
            background-color: #FFFFFF !important;
            border: 1px solid #E5E7EB !important;
            color: #1A1229 !important;
            font-weight: 500 !important;
            border-radius: 50px !important;
        }
        .filter-dropdown:focus {
            box-shadow: 0 0 0 0.25rem rgba(74, 108, 243, 0.25) !important;
        }

        .pagination-container {
            margin-top: 2.5rem;
        }
        .pagination .page-link {
            border-radius: 50% !important;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 5px;
            border: 1px solid #E5E7EB;
            font-weight: 500;
            color: #5A6474;
            transition: all 0.3s ease;
        }
         .pagination .page-link:hover {
            background-color: #F8F7FA;
            color: #4A6CF3;
            border-color: #4A6CF3;
        }
        .pagination .page-item.disabled .page-link {
            background-color: transparent;
            color: #ced4da;
            border-color: #E5E7EB;
        }
        .pagination .page-item.active .page-link {
             background: linear-gradient(90deg, #4A6CF3 0%, #9B49F2 100%);
             border-color: transparent;
             color: white;
             box-shadow: 0 4px 15px rgba(120, 73, 242, 0.3);
        }
        
        /* Modal Styles */
        #documentDetailModal.fade .modal-dialog {
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.3s ease;
        }

        #documentDetailModal.show .modal-dialog {
            transform: scale(1);
            opacity: 1;
        }
        
        #documentDetailModal .modal-body {
            display: flex;
            gap: 1.5rem;
        }
        #documentDetailModal .modal-body img {
            max-width: 250px;
            height: auto;
            object-fit: cover;
            border-radius: 0.75rem;
            align-self: flex-start;
        }
        #documentDetailInfo h3 {
            font-weight: 600;
            color: #1A1229;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        #documentDetailInfo .price-section {
            font-size: 1.5rem;
            font-weight: 700;
            color: #dc3545;
            margin: 1rem 0;
        }
        #documentDetailInfo .price-section .price-free {
            color: #198754;
        }
        #documentDetailInfo .meta-info {
            font-size: 0.9rem;
            color: #5A6474;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
         #documentDetailInfo .meta-info .fas {
            width: 20px;
            text-align: center;
            margin-right: 0.5rem;
            color: #4A6CF3;
         }
        #documentDetailInfo .description {
            margin-top: 1.5rem;
            color: #5A6474;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        #documentDetailModal .modal-footer {
            border-top: 1px solid #E5E7EB;
        }

        #pdfViewerModal .modal-body {
            position: relative;
        }

        #pdf-loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #F8F7FA;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 2rem;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #pdf-loader-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        #pdf-loader-overlay .progress-bar {
            background: linear-gradient(90deg, #4A6CF3 0%, #9B49F2 100%);
            transition: width 0.1s linear;
        }

        #pdf-iframe {
            border: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #pdf-iframe.loaded {
            opacity: 1;
        }
        
        #pdf-viewer-custom-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 48px;
            background-color: #FFFFFF;
            z-index: 5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem 0 1.5rem;
            border-bottom: 1px solid #E5E7EB;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #pdf-viewer-title-placeholder {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 60%;
        }

        .rounded-pill{
            height: 30px;
        }

        .updating-icon {
            font-size: 4rem;
            color: #4A6CF3; 
            margin-bottom: 1rem;
            line-height: 1;
        }
        
        #deleteConfirmModal .modal-header {
            border-bottom: none;
            padding-bottom: 0;
        }
        #deleteConfirmModal .modal-body {
            text-align: center;
        }
        #deleteConfirmModal .delete-icon {
            font-size: 3rem;
            color: #dc3545;
            margin-bottom: 1rem;
        }
        #deleteConfirmModal .modal-title {
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 991.98px) {
            .document-container-wrapper {
                margin-top: -70px;
                padding: 2rem;
            }
        }

        @media (max-width: 767.98px) {
            .page-header {
                padding: 2.5rem 0;
                margin-bottom: 80px;
            }
             #document-filters {
                justify-content: center;
            }
            #document-filters .dropdown {
                width: 100%;
                margin-top: 0.5rem;
            }
            #document-filters .dropdown .btn {
                width: 100%;
            }

            #documentDetailModal .modal-body {
                flex-direction: column;
                padding: 1rem; 
            }
            #documentDetailModal .modal-body img {
                max-width: 100%;
                max-height: 200px; 
                width: auto;
                margin: 0 auto 1rem auto; 
                object-fit: contain;
            }
            
            #documentDetailModal .modal-footer {
                flex-wrap: nowrap;
            }
            #documentDetailModal .modal-footer .btn {
                font-size: 0.8rem;
                padding: 0.6rem 0.5rem;
            }

            .document-card-body {
                padding: 1rem;
            }
            .document-card-title {
                font-size: 0.9rem;
                min-height: 2.8em;
            }
        }
        
        @media (max-width: 575.98px) {
            .header-search-form #document-search {
                padding: 0.8rem 6.5rem 0.8rem 3rem;
                height: 48px;
                font-size: 0.9rem;
            }
            .header-search-form .btn-gradient {
                padding: 0.4rem 1rem;
                font-size: 0.85rem;
                right: 8px;
            }
        }

    </style>
</head>

<body>
    <div id="preloader">
        <div class="preloader-content">
            <div class="loader"></div>
            <div class="loading-text">Đang tải...</div>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main>
        <section class="page-header">
            <div class="container">
                <h1>Kho Tàng Tri Thức</h1>
                <p class="lead">Khám phá bộ sưu tập tài liệu Tarot và Huyền học độc quyền của VietTarot.</p>
                <form class="header-search-form" onsubmit="event.preventDefault();">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="document-search" class="form-control" placeholder="Tìm kiếm tài liệu theo tiêu đề...">
                    <button type="submit" class="btn btn-gradient">Tìm kiếm</button>
                </form>
            </div>
        </section>

        <section class="documents-section py-5">
            <div class="container">
                <div class="document-container-wrapper">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="d-flex flex-wrap align-items-center gap-2 mb-4" id="document-filters">
                                <button class="btn filter-btn active" data-filter-type="all">Tất cả</button>
                                <button class="btn filter-btn" data-filter-type="free">Miễn phí</button>
                                <div class="dropdown ms-md-auto">
                                    <button class="btn filter-dropdown dropdown-toggle" type="button" id="category-filter-dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        Tất cả danh mục
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="category-filter-dropdown" id="category-filter-list">
                                        <li>
                                            <p class="text-center my-2 text-secondary small">Đang tải...</p>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="row g-3" id="documents-list">
                                <div class="col-12 text-center" id="documents-loader">
                                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3 text-secondary">Đang tải danh sách tài liệu...</p>
                                </div>
                            </div>
                            <nav class="pagination-container d-flex justify-content-center">
                                <ul class="pagination" id="pagination-controls"></ul>
                            </nav>
                        </div>

                        <div class="col-lg-4 mt-5 mt-lg-0">
                            <aside class="sidebar-widget">
                                <h4 class="sidebar-widget-title"><i class="fas fa-fire icon-popular"></i><span>Tài Liệu Phổ Biến</span></h4>
                                <div class="widget-post-list" id="popular-documents-list">
                                    <p class="text-secondary small">Đang tải...</p>
                                </div>
                            </aside>
                            <aside class="sidebar-widget">
                                <h4 class="sidebar-widget-title"><i class="fas fa-clock icon-latest"></i><span>Tài Liệu Mới Nhất</span></h4>
                                <div class="widget-post-list" id="latest-documents-list">
                                    <p class="text-secondary small">Đang tải...</p>
                                </div>
                            </aside>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <div id="modals-placeholder"></div>
    
    <div id="floating-widgets-placeholder"></div>

    <div class="modal fade" id="documentDetailModal" tabindex="-1" aria-labelledby="documentDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentDetailModalLabel">Chi Tiết Tài Liệu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="documentDetailBody">
                    <div class="text-center w-100"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" id="modal-save-button" class="btn btn-outline-primary"><i class="fas fa-bookmark me-2"></i>Lưu vào sổ tay</button>
                    <button type="button" id="modal-view-button" class="btn btn-gradient"><i class="fas fa-file-pdf me-2"></i>Xem Ngay</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pdfViewerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-body p-0">
                    <div id="pdf-loader-overlay">
                         <div class="pdf-loader-content w-25">
                            <div class="progress mb-3" style="height: 10px;">
                                <div id="pdf-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <p class="mb-0 fw-bold text-center"><span id="pdf-progress-text">Đang tải tài liệu: 0%</span></p>
                        </div>
                    </div>
                    <div id="pdf-viewer-custom-header">
                        <span id="pdf-viewer-title-placeholder" class="gradient-text">Tên tài liệu...</span>
                        <button class="btn btn-sm btn-gradient rounded-pill" data-bs-dismiss="modal" aria-label="Close">
                            <i class="fas fa-times me-sm-1"></i><span class="d-none d-sm-inline">Đóng trình xem</span>
                        </button>
                    </div>
                    <iframe id="pdf-iframe" src="" width="100%" height="100%"></iframe>
                </div>
            </div>
        </div>
    </div>
    
    <div id="updating-document-overlay" class="fullscreen-overlay">
        <div class="success-notification">
            <div class="updating-icon"><i class="fas fa-sync-alt fa-spin"></i></div>
            <h4 class="success-title">Tài liệu đang cập nhật</h4>
            <p class="success-message">Nội dung này đang được chúng tôi hoàn thiện. Vui lòng quay lại sau!</p>
        </div>
    </div>

    <div class="modal fade" id="unsaveConfirmModal" tabindex="-1" aria-labelledby="unsaveConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="unsaveConfirmModalLabel">Xác nhận Bỏ Lưu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="delete-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <p>Bạn có chắc chắn muốn bỏ lưu tài liệu này không?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" id="confirm-unsave-btn">Bỏ lưu</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="components.js" defer></script>

    <script>
        // Logic Preloader
        window.addEventListener('load', function() {
            const preloader = document.getElementById('preloader');
            if (preloader) {
                setTimeout(() => {
                    preloader.classList.add('fade-out');
                    preloader.addEventListener('transitionend', () => preloader.style.display = 'none');
                }, 200);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Đảm bảo supabase client từ components.js đã được khởi tạo
            // Dùng một khoảng chờ nhỏ để components.js kịp chạy và tạo window.viettarotApp
            setTimeout(initializeDocumentPage, 100); 
        });

        function initializeDocumentPage() {
             // Sử dụng supabase client toàn cục từ components.js
            if (!window.viettarotApp || !window.viettarotApp.supabase) {
                console.error("Supabase client không được khởi tạo. Tệp components.js có thể chưa được tải.");
                return;
            }
            const supabase = window.viettarotApp.supabase;
            
            // Khai báo các biến và hằng số
            let allDocuments = [];
            let currentDocuments = [];
            let currentPage = 1;
            const itemsPerPage = 6;
            let activeFilters = { type: 'all', category: 'all' };

            const documentsListContainer = document.getElementById('documents-list');
            const searchInput = document.getElementById('document-search');
            const documentsLoader = document.getElementById('documents-loader');
            const latestDocumentsContainer = document.getElementById('latest-documents-list');
            const popularDocumentsContainer = document.getElementById('popular-documents-list');
            const paginationControls = document.getElementById('pagination-controls');
            const filtersContainer = document.getElementById('document-filters');
            const categoryFilterList = document.getElementById('category-filter-list');
            const categoryFilterDropdown = document.getElementById('category-filter-dropdown');
            
            const detailModalEl = document.getElementById('documentDetailModal');
            const detailModalBody = document.getElementById('documentDetailBody');
            const modalViewButton = document.getElementById('modal-view-button');
            const modalSaveButton = document.getElementById('modal-save-button'); 

            const pdfViewerModalEl = document.getElementById('pdfViewerModal');
            const pdfIframe = document.getElementById('pdf-iframe');
            const pdfLoaderOverlay = document.getElementById('pdf-loader-overlay');
            const pdfProgressBar = document.getElementById('pdf-progress-bar');
            const pdfProgressText = document.getElementById('pdf-progress-text');
            const pdfCustomHeader = document.getElementById('pdf-viewer-custom-header');
            const pdfTitlePlaceholder = document.getElementById('pdf-viewer-title-placeholder');
            const updatingOverlay = document.getElementById('updating-document-overlay');

            const unsaveConfirmModalEl = document.getElementById('unsaveConfirmModal');
            const confirmUnsaveBtn = document.getElementById('confirm-unsave-btn');
            const unsaveConfirmModal = new bootstrap.Modal(unsaveConfirmModalEl);

            // Các hàm tiện ích
            const formatDate = (dateString) => {
                if (!dateString) return 'Không rõ ngày';
                return new Date(dateString).toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            };

            const formatCurrency = (number) => {
                if (typeof number !== 'number' || isNaN(number)) return 'N/A';
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
            };

            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };
            
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) return;
                const iconClass = type === 'success' ? 'fa-check-circle' : (type === 'danger' ? 'fa-times-circle' : 'fa-info-circle');
                const bgClass = `text-bg-${type}`;
                const toastId = 'toast-' + Math.random().toString(36).substring(2, 9);
                const toastHTML = `
                    <div id="${toastId}" class="toast align-items-center ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex"><div class="toast-body"><i class="fas ${iconClass} me-2"></i>${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
                    </div>`;
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                const toast = new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 });
                toast.show();
                document.getElementById(toastId).addEventListener('hidden.bs.toast', (e) => e.target.remove());
            }

            // Các hàm render giao diện
            function renderDocuments(docs) {
                if (!documentsListContainer) return;
                documentsListContainer.innerHTML = ''; 
                if (docs.length === 0) {
                    documentsListContainer.innerHTML = `<div class="col-12"><div class="no-results-message"><i class="fas fa-folder-open fa-2x mb-3"></i><h4>Không tìm thấy tài liệu nào</h4><p>Vui lòng thử lại với bộ lọc hoặc từ khóa khác.</p></div></div>`;
                    return;
                }
                docs.forEach(doc => {
                    let priceHTML = `<span class="price-free">Miễn phí</span>`;
                    if (typeof doc.price_sale === 'number' && doc.price_sale > 0) {
                        priceHTML = `<span class="price-sale">${formatCurrency(doc.price_sale)}</span>`;
                        if (typeof doc.price_original === 'number' && doc.price_original > doc.price_sale) {
                            priceHTML += `<span class="price-original">${formatCurrency(doc.price_original)}</span>`;
                        }
                    } else if (typeof doc.price_original === 'number' && doc.price_original > 0) {
                        priceHTML = `<span class="price-sale">${formatCurrency(doc.price_original)}</span>`;
                    }
                    const cardHTML = `
                        <div class="col-lg-4 col-md-6 col-6 d-flex"> 
                            <div class="document-card" data-doc-id="${doc.id}">
                                <div class="document-card-thumbnail">
                                    <img src="${doc.image_url || 'https://placehold.co/400x300/e5e7eb/5a6474?text=Document'}" alt="${doc.title}">
                                    ${doc.category ? `<div class="document-card-category">${doc.category}</div>` : ''}
                                </div>
                                <div class="document-card-body">
                                    <h3 class="document-card-title">${doc.title}</h3>
                                    <div class="document-card-price">${priceHTML}</div>
                                    <div class="document-card-footer">
                                        <span class="info-item"><i class="fas fa-user-edit"></i><span class="author-name-text">${doc.author_name || 'Tác giả'}</span></span>
                                        <span class="info-item"><i class="fas fa-calendar-alt"></i><span>${formatDate(doc.published_at)}</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    documentsListContainer.insertAdjacentHTML('beforeend', cardHTML);
                });
            }

            function setupPagination(items) {
                if (!paginationControls) return;
                paginationControls.innerHTML = "";
                const pageCount = Math.ceil(items.length / itemsPerPage);
                if (pageCount <= 1) {
                    paginationControls.parentElement.style.display = 'none';
                    return;
                }
                paginationControls.parentElement.style.display = 'flex';
                
                const createPageItem = (page, text) => {
                    const li = document.createElement('li');
                    li.className = `page-item ${page === currentPage ? 'active' : ''} ${page === '...' || (text==='&laquo;' && currentPage===1) || (text==='&raquo;' && currentPage===pageCount) ? 'disabled' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#">${text || page}</a>`;
                    if (li.className.indexOf('disabled') === -1) {
                        li.querySelector('a').addEventListener('click', (e) => {
                            e.preventDefault();
                            currentPage = page;
                            updatePage();
                            document.querySelector('.document-container-wrapper')?.scrollIntoView({ behavior: 'smooth' });
                        });
                    }
                    return li;
                }

                if (currentPage > 1) paginationControls.appendChild(createPageItem(currentPage - 1, '&laquo;'));
                for (let i = 1; i <= pageCount; i++) {
                     if (i === 1 || i === pageCount || (i >= currentPage - 1 && i <= currentPage + 1)) {
                        paginationControls.appendChild(createPageItem(i));
                     } else if (i === currentPage - 2 || i === currentPage + 2) {
                        paginationControls.appendChild(createPageItem('...', '...'));
                     }
                }
                if (currentPage < pageCount) paginationControls.appendChild(createPageItem(currentPage + 1, '&raquo;'));
            }

            function displayPage(items) {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                renderDocuments(items.slice(start, end));
            }
            
            function updatePage() {
                displayPage(currentDocuments);
                setupPagination(currentDocuments);
            }

            function applyFilters() {
                let filtered = [...allDocuments];
                const searchTerm = searchInput.value.toLowerCase().trim();

                if (activeFilters.type === 'free') {
                    filtered = filtered.filter(doc => (doc.price_sale === 0 || doc.price_original === 0) && doc.price_sale !== null);
                }
                if (activeFilters.category !== 'all') {
                    filtered = filtered.filter(doc => doc.category === activeFilters.category);
                }
                if (searchTerm) {
                    filtered = filtered.filter(doc => doc.title.toLowerCase().includes(searchTerm));
                }

                currentDocuments = filtered;
                currentPage = 1;
                updatePage();
            }

            function renderSidebarDocs(container, docs) {
                if (!container) return;
                container.innerHTML = docs.length ? docs.map(doc => `
                    <div class="widget-post-item">
                        <a href="#" class="widget-post-thumbnail" data-doc-id="${doc.id}">
                            <img src="${doc.image_url || 'https://placehold.co/100x100/e5e7eb/5a6474?text=Doc'}" alt="${doc.title}">
                        </a>
                        <div class="widget-post-content">
                            <h6><a href="#" data-doc-id="${doc.id}">${doc.title}</a></h6>
                            <span class="widget-post-meta">${formatDate(doc.published_at)}</span>
                        </div>
                    </div>`).join('') : '<p class="text-secondary small">Chưa có tài liệu nào.</p>';
            }

            function populateModal(doc) {
                if (!doc) return;
                let priceHTML = `<span class="price-free">Miễn phí</span>`;
                 if (typeof doc.price_sale === 'number' && doc.price_sale > 0) {
                        priceHTML = `${formatCurrency(doc.price_sale)}`;
                        if (typeof doc.price_original === 'number' && doc.price_original > doc.price_sale) {
                            priceHTML += ` <s class="price-original ms-2" style="font-size: 1rem;">${formatCurrency(doc.price_original)}</s>`;
                        }
                    } else if (typeof doc.price_original === 'number' && doc.price_original > 0) {
                        priceHTML = `${formatCurrency(doc.price_original)}`;
                    }
                detailModalBody.innerHTML = `
                    <img src="${doc.image_url || 'https://placehold.co/400x600/e5e7eb/5a6474?text=Doc'}" alt="${doc.title}">
                    <div id="documentDetailInfo">
                        <h3>${doc.title}</h3>
                        <div class="meta-info"><i class="fas fa-user-edit"></i><span><strong>Tác giả:</strong> ${doc.author_name || 'N/A'}</span></div>
                        <div class="meta-info"><i class="fas fa-calendar-alt"></i><span><strong>Ngày XB:</strong> ${formatDate(doc.published_at)}</span></div>
                        <div class="meta-info"><i class="fas fa-tags"></i><span><strong>Danh mục:</strong> ${doc.category || 'N/A'}</span></div>
                        <div class="price-section">${priceHTML}</div>
                        <div class="description"><p>${doc.description || 'Không có mô tả.'}</p></div>
                    </div>`;
                modalViewButton.dataset.docUrl = doc.document_url || '#';
                modalViewButton.dataset.docTitle = doc.title || 'Tài liệu';
            }
            
            async function checkIfDocIsSaved(docId) {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return setSaveButtonState('unsaved');
                const { data } = await supabase.from('saved_documents').select('id').eq('user_id', user.id).eq('document_id', docId).single();
                setSaveButtonState(data ? 'saved' : 'unsaved');
            }

            function setSaveButtonState(state) {
                if (!modalSaveButton) return;
                modalSaveButton.dataset.savedState = state;
                if (state === 'saved') {
                    modalSaveButton.disabled = false;
                    modalSaveButton.className = 'btn btn-success';
                    modalSaveButton.innerHTML = '<i class="fas fa-check me-2"></i>Đã lưu';
                } else {
                    modalSaveButton.disabled = false;
                    modalSaveButton.className = 'btn btn-outline-primary';
                    modalSaveButton.innerHTML = '<i class="fas fa-bookmark me-2"></i>Lưu vào sổ tay';
                }
            }

            // Các hàm fetch dữ liệu
            async function loadInitialData() {
                if(documentsLoader) documentsLoader.style.display = 'block';
                const [docsRes, catsRes, latestRes, popularRes] = await Promise.all([
                    supabase.from('documents').select('*').order('published_at', { ascending: false }),
                    supabase.from('documents').select('category'),
                    supabase.from('documents').select('*').order('published_at', { ascending: false }).limit(4),
                    supabase.from('documents').select('*').limit(10)
                ]);
                
                if(documentsLoader) documentsLoader.style.display = 'none';

                if (docsRes.error) return console.error("Lỗi tải tài liệu:", docsRes.error);
                allDocuments = docsRes.data || [];
                currentDocuments = allDocuments;
                updatePage();

                if (!catsRes.error) {
                    const categories = [...new Set(catsRes.data.map(item => item.category).filter(Boolean))];
                    categoryFilterList.innerHTML = '<li><a class="dropdown-item" href="#" data-category="all">Tất cả danh mục</a></li>' +
                        categories.map(cat => `<li><a class="dropdown-item" href="#" data-category="${cat}">${cat}</a></li>`).join('');
                }
                
                if (!latestRes.error) renderSidebarDocs(latestDocumentsContainer, latestRes.data);
                
                if (!popularRes.error && popularRes.data) {
                    const shuffledPopular = shuffleArray([...popularRes.data]).slice(0, 4);
                    renderSidebarDocs(popularDocumentsContainer, shuffledPopular);
                }
            }

            // Gắn sự kiện
            filtersContainer?.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('.filter-btn')) {
                    filtersContainer.querySelector('.filter-btn.active')?.classList.remove('active');
                    target.classList.add('active');
                    activeFilters.type = target.dataset.filterType;
                    applyFilters();
                }
                if (target.matches('.dropdown-item')) {
                    const category = target.dataset.category;
                    activeFilters.category = category;
                    if(categoryFilterDropdown) categoryFilterDropdown.textContent = category === 'all' ? 'Tất cả danh mục' : target.textContent;
                    applyFilters();
                }
            });

            searchInput?.addEventListener('input', applyFilters);
            
            documentsListContainer?.addEventListener('click', (e) => {
                const card = e.target.closest('.document-card');
                const link = e.target.closest('a');
                if (card || link) {
                    const docId = card?.dataset.docId || link?.dataset.docId;
                    if(docId) {
                        const detailModal = new bootstrap.Modal(detailModalEl);
                        detailModalEl.dataset.docId = docId;
                        const doc = allDocuments.find(d => d.id == docId);
                        if (doc) {
                            populateModal(doc);
                            checkIfDocIsSaved(docId);
                        }
                        detailModal.show();
                    }
                }
            });

            modalSaveButton?.addEventListener('click', async function() {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    bootstrap.Modal.getInstance(detailModalEl)?.hide();
                    new bootstrap.Modal(document.getElementById('loginModal'))?.show();
                    return;
                }
                const docId = detailModalEl.dataset.docId;
                if (this.dataset.savedState === 'unsaved') {
                    const { error } = await supabase.from('saved_documents').insert({ user_id: user.id, document_id: docId });
                    showToast(error ? 'Lỗi lưu tài liệu' : 'Đã lưu tài liệu!', error ? 'danger' : 'success');
                    if (!error) setSaveButtonState('saved');
                } else {
                    confirmUnsaveBtn.dataset.docId = docId;
                    unsaveConfirmModal.show();
                }
            });

            confirmUnsaveBtn?.addEventListener('click', async function() {
                const { data: { user } } = await supabase.auth.getUser();
                const docId = this.dataset.docId;
                const { error } = await supabase.from('saved_documents').delete().match({ user_id: user.id, document_id: docId });
                unsaveConfirmModal.hide();
                showToast(error ? 'Lỗi bỏ lưu' : 'Đã bỏ lưu tài liệu.', error ? 'danger' : 'info');
                if (!error) setSaveButtonState('unsaved');
            });

            modalViewButton?.addEventListener('click', function() {
                const docUrl = this.dataset.docUrl;
                if (docUrl && docUrl !== '#') {
                    new bootstrap.Modal(pdfViewerModalEl).show();
                } else {
                    updatingOverlay?.classList.add('show');
                    setTimeout(() => updatingOverlay?.classList.remove('show'), 3000);
                }
            });

            pdfViewerModalEl?.addEventListener('show.bs.modal', function() {
                const docUrl = modalViewButton.dataset.docUrl;
                const docTitle = modalViewButton.dataset.docTitle;
                if(pdfTitlePlaceholder) pdfTitlePlaceholder.textContent = docTitle;
                if(pdfIframe) pdfIframe.src = docUrl.replace("/view", "/preview");
                // Fake progress bar for better UX
                let progress = 0;
                pdfProgressBar.style.width = '0%';
                pdfProgressText.textContent = `Đang tải tài liệu: 0%`;
                pdfLoaderOverlay.classList.remove('hidden');
                pdfIframe.classList.remove('loaded');
                const interval = setInterval(() => {
                    progress = Math.min(100, progress + Math.random() * 10);
                    pdfProgressBar.style.width = progress + '%';
                    pdfProgressText.textContent = `Đang tải tài liệu: ${Math.round(progress)}%`;
                    if (progress >= 100) {
                        clearInterval(interval);
                        setTimeout(() => {
                             pdfLoaderOverlay.classList.add('hidden');
                             pdfIframe.classList.add('loaded');
                             pdfCustomHeader.style.opacity = '1';
                             pdfCustomHeader.style.visibility = 'visible';
                        }, 500);
                    }
                }, 150);
            });

            pdfViewerModalEl?.addEventListener('hidden.bs.modal', function() {
                if(pdfIframe) pdfIframe.src = '';
                pdfCustomHeader.style.opacity = '0';
                pdfCustomHeader.style.visibility = 'hidden';

                const detailModalInstance = bootstrap.Modal.getInstance(detailModalEl);
                if (detailModalInstance) {
                    detailModalInstance.hide();
                }
            });

            // Khởi chạy
            loadInitialData();
        }
    </script>
</body>

</html>